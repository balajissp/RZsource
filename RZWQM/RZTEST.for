C $ID: RZTEST.FOR,V 1.1 2002/08/28 00:00:48 ROJAS EXP $
C     LAST CHANGE:  KWR    8 DEC 94  2:05 PM
      SUBROUTINE EVNTRO(CC,NN,NHOR,ID,RESCOV,SLKS,BPWHEN,BPMUCH,COPLNT,
     +    CORES,NBP,ZRFDD,JDAY,CII,ROI,AIRR,FMP,DTCHEM,T,SOLTP1,TEMPR,
     +    CMPS,IMAGIC,IBRK,BRKH2O,BKCHEM,H2OTAB,SUBDR,DRSEEP,DTDCHEM,
     +    TLT,HORTHK,CAPZONE,SMELT,IDP,OMSEA,IYYY,THGCUR,pori,SCUPCH,
     +    Hmin,pplastic)
C
C======================================================================
C
C       PURPOSE:  DRIVER FOR INFILTRATION/STORM EVENT HYDROLOGY
C             THIS IS THE MAIN PROGRAM THAT READS AND WRITES INPUT
C             DATA, MAKES SOME INITIAL CALCULATIONS, AND INITIALIZES
C             OUTPUT VARIABLES.
C
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       A      I  CONSTANT FOR NON-UNIFORM MIXING []
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       AIRR   I  AMOUNT OF IRRIGATION WATER TO APPLY
C       ALH       I/O KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALHMAC    I/O KD FOR LINEAR DESORPTION OF CURRENT PEST[CM3 H2O/G SOIL]
C       B      I  CONSTANT FOR NON-UNIFORM MIXING []
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BFSEEP     L  FLUX OUT BOTTOM DUE TO BOTTOM BOUNDARY CONDITION [CM]
C       BKCHEM    I/O FLUX OF SELECTED CHEMICALS AT BRK. THR. NODE
C                 CONTAINS NO3-N, PEST#1-3 [UG/CM^2]
C       BOTFLX     I  RATE OF FLOW OF BOTTOM BOUNDARY CONDITION [CM/HR]
C       BPMUCH     I  AMOUNT OF WATER AT EACH BREAK POINT [CM]
C       BPWHEN     I  TIME OF EACH RAINFALL BREAK POINT [HR]
C       BRKH2O    I/O FLUX OF WATER AT BRK. THR. NODE [CM/DAY]
C       BRKMAS     L  FLUX OF CHEM AT BREAK THROUGH NODE [UG/CM^2]
C       BRKWAT     L  FLUX OF WATER AT BREAK THROUGH NODE [CM]
C       CAPZONE    I  DEPTH FROM SURFACE TO TOP OF CAPILLARY ZONE [CM]
C       CC         I  TRANSPORT MATRIX FOR MOBILE CHEMICALS [MG/L]
C                 CONTAINS ONLY THE SOLUBLE FORM OF CHEMICAL:
C                 1-HYDROGEN, 2-CALCIUM, 3-SODIUM, 4-MAGNISIUM,
C                 5-CLORINE, 6-BICARBONATE, 7-SULFATE, 8-ALUMINUM,
C                 9-NITRATE-N, 10-AMMONIUM-N, 11-CARBONATE,
C                 12-UREA-N, 13-PEST #1, 14-PEST #2, 15-PEST #3
C       CDBET I/O CHEMICAL IN DEADEND MACP. [UG]
C       CDFLOW    I/O CHEMICAL FLOW FROM DEADEND MACP. TO SOIL [UG]
C       CDNCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE [UG]
C       CDNCI I/O WATER SEEPAGE OUT BOTTOM OF PROFILE [CM]
C       CDNHT  L  HEAT LOST OUT BOTTOM OF PROFILE
C       CFLOW I/O CHEMICAL FROM CONT. MACROPORES TO SOIL [UG]
C       CH1        L  SAT. HYDRAULIC COND. OF 1ST HORIZON [CM/HR]
C       CHJ        L  SAT. HYDRAULIC COND. OF EACH HORIZON [CM/HR]
C       CHKMAS     L  PROFILE MASS BALANCE [CM]
C       CHKRAN     L  RAINFALL MASS BALANCE [CM]
C       CHKTEM     L  ENERGY MASS BALANCE [CM]
C       CI        I/O TIME SERIES ACCUM. WATER INFILTRATION [CM]
C       CII       I/O INFILTRATION AMT. AT CURRENT TIME STEP [CM]
C       CLAT   I  LATERAL HYDROLIC CONDUCTIVITY [CM/HR]
C       CMASW I/O CHEMICAL MASS ALONG MACROPORE WALLS [UG/CM^2]
C       CMESO I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR I/O CHEMICAL CONC. IN MICROPORES [MG/L]
C       CMPS  I/O CUMM. WATER SEEP OUT BOTTOM OF PROFILE FROM
C                 MACROPORES [CM]
C       CONC   L  CHEM. CONC. IN SOIL WATER OF EACH SOIL NODE
C                 SAME AS CC [MG/L]
C       CONCP  L  CONC. OF PESTICIDE ADDED FROM WASHOFF FROM
C                 PLANTS AND RESIDUE [MG/L]
C       CONCX2     I  PEST. CONC. INVOLVED IN KINETIC PROCESSES [UG/G-S]
C       COPLNT     I  INITIAL AMT OF PESTICIDE ON THE FOLIAGE [UG/CM^2]
C       CORES  I  INIT. AMT. CHEM. AVAIL. ON RESIDUE FOR DISSIPATION
C       CRAIN  L  CHEMICAL CONC. IN RAIN WATER [MG/L]
C       CRFD  I/O CUM AMOUNT OF RAINFALL OVER BRK.PNTS. [CM]
C       CRFT  I/O CUM TIME OF RAINFALL OVER BRK. PNTS. [HR]
C       CRO       I/O CHEMICAL IN RUNOFF [UG/CM^2]
C       CRT        L  FACTOR USED IN CRUST ADJUSTMENTS
C       CRUSTK    I/O CRUST HYRAULIC CONDUCTIVITY [CM/HR]
C       CSHD   L  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CSHWS  L  EFFECTIVE VOL HEAT CAPACITIES AT THETA-S [J/MM^3/C]
C       CUMCLM    I/O CUM CHEMICAL FLOW IN MP VS. TIME [UG/CM^2]
C       CUMCLR    I/O CUM CHEMICAL LOSS IN RUNOFF [UG/CM^2]
C       CUMDR  L  CUM TILE DRAIN WATER FLOW [CM]
C       CUMMF I/O CUM MACROPORE WATER FLOW [CM]
C       CUMRO I/O CUMMULATIVE WATER RUNOFF [CM]
C       CUPCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE
C                 FROM MACROPORES [UG/CM^2]
C       CUPRO I/O WATER SEEPAGE OUT BOTTOM OF PROFILE
C                 FROM MACROPORES [CM]
C       CW         P  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DB        I/O MAX CAPACITY OF DEADEND PORES [CM]
C       DBET  I/O MOISTURE CONTENT IN DEADEND MACROPORES [CM]
C       DC1        L  ABBRV. FOR SOILHP(4,I)
C       DC2        L  ABBRV. FOR SOILHP(11,I)
C       DEG       I/O DEGREE OF CHEMICAL MIXING WITH RAINWATER
C       DFLOW I/O WATER FLOW FROM DEADEND MACROPORES TO SOIL
C                 SPACIALLY DISTRUB [CM]
C       DHB        I  DEPTH OF HORIZON BOUNDARIES [CM]
C       DN1        L  ABBRV. FOR SOILHP(12,I)
C       DN2        L  ABBRV. FOR SOILHP(3,I)
C       DRCHEM     L  CHEM. LOSS IN TILE DRAIN [UG/CM^2]
C       DRDEP  I  DEPTH TO TILE DRAIN [CM]
C       DRHT   L  CUM HEAT LOSS OUT TILE DRAIN
C       DRRAD  I  RADIUS OF DRAINS [CM]
C       DRSEEP    I/O TOTAL WATER LOSS OUT TILE DRAIN [CM]
C       DRSPAC     I  DISTANCE BETWEEN DRAINS [CM]
C       DS1        L  ABBRV. FOR SOILHP(10,I)
C       DS2        L  ABBRV. FOR SOILHP(1,I)
C       DSTORE     L  EXCESS WATER TO BE DRAINED [CM]
C       DTCHEM    I/O TOTAL AMOUNT OF CHEMICAL LOST TO SEEPAGE
C                 CORRESPONDS TO CC ORDER [UG/CM^2]
C       DTDCHEM   I/O CUM CHEM. LOSS IN TILE DRAIN [UG/CM^2]
C       FDEP   I  FRACTION OF TOTAL MACROPORES THAT ARE DEADEND [0..1]
C       FERTIR    I/O AMT. OF FERTILIZER IN IRRIGATION WATER [MG/L]
C       FIRST  L  TRUE IF FIRST TIME THROUGH ROUTINE
C       FLOW  I/O CUMCUL. WATER FLOW FROM CONT. MACROPORES TO SOIL
C                 IN EACH LAYER. [CM]
C       FLXMAX    I/O MAXIMUN WATER FLUX IN RADIAL PORE CONTROLLED
C                 MACROPORE HORIZONS [CM/HR]
C       FMP       I/O CUMMULATIVE FLOW FROM MACROPORES [CM]
C       H2OTAB     I  ARRAY CONTAINING NODE # AND DEPTH OF WATER TABLE
C       HORTHK     I  DEPTH OF SOIL HORIZONS [CM]
C       I      L  INDEX VARIABLE
C       IB         L  INDEX VARIABLE
C       IBRK   I  LAYER INTERFACE BELOW BREAK THROUGH NODE
C       IC         L  INDEX VARIABLE
C       ICRUST     I  FLAG FOR PRESENCE OF SURFACE CRUST [0=NO, 1=YES]
C       ID         L  INDEX FOR DEPTH OF WETTING FRONT
C       JDAY   I  JULIAN DATE
C       IE         L  INDEX VARIABLE
C       IH         L  INDEX VARIABLE
C       IK         L  INDEX VARIABLE
C       IMAGIC     I  INDICATOR OF DEBUG OUTPUT
C       INFLPD    I/O FLAG FOR PONDED INFILTRATION
C       IP         L  INDEX FOR PESTICIDE NUMBER
C       IREBOT     I  BOTTOM B.C. INDICATOR: 1 (CONSTANT HEAD) OR 2 (UNIT FLUX
C       ITBL   I  INDICATES PRESENCE OF WATER TABLE 0=NO 1=YES
C       IUGFLW     I  TRIGGERS UNIT GRAD FLOW BELOW WETTING FRONT
C       J      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       K      L  INDEX VARIABLE
C       KWR        L  INDEX VARIABLE
C       MAXBP  P  MAXIMUM NUMBER OF BREAK POINTS IN A RAINSTORM
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MCPOR  I  TOTAL MACROPOROSITY OF HORIZON [CM3/CM3]
C       MICP  I/O TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXPEST     P  MAXIMUM NUMBER OF PESTICIDES
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NBP        I  NUMBER OF BREAK POINTS
C       NDXH2N     I  INDEX FOR HORIZONS TO NUMERICAL LAYERS,
C                   IE. HOW MANY NUMERICAL LAYERS IN HORIZON.
C       NDXN2H     I  INDEX FOR NUMERICAL LAYERS TO HORIZONS,
C                   IE. WHICH HORIZON IS NUMERICAL LAYER IN.
C       NH         L  HORIZON NUMBER OF CURRENT INFIL. LAYER
C       NHCMP  I  NUMBER OF HORIZONS CONTAINING MACROPORES
C       NHOR   I  NUMBER OF SOIL HORIZONS
C       NHZ        I  NUMBER OF SOIL HORIZONS
C       NMICP  I  =1 IF MICROPORSITY VALUES ARE GIVEN, =0 IF NOT
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NPEST  I  NUMBER OF USER DEFINED PESTICIDES
C       NPOR  I/O TOTAL NUMBER OF MACROPORES PER LAYER
C       NSL        I  DEPTH TO BOTTOM OF SOIL HORIZONS [CM]
C       NSLT   I  PROFILE DEPTH [CM]
C       NTIM   L  FINAL NUMBER OF TIME STEPS TAKEN
C       OCRUST     I  ORIGINAL CRUST HYDRAULIC CONDUCTIVITY [CM/HR]
C       PACTIV     I  TRUE WHEN PESTICIDE IS ACTIVE
C       PESTIR    I/O AMT. OF PESTICIDES IN IRRIGATION WATER [MG/L]
C       PI        I/O MATHEMATICAL CONSTANT = 3.141592654...
C       PL         I  LENGTH OF VERTICAL MACROPORE CRACKS  [CM]
C       POND  I/O DEPTH OF PONDED WATER [CM]
C       RAC        I  RAA @ CANOPY [S/M]
C       RESCOV     I  FRACTION BARE SURFACE (NOT COVERED BY RESIDUE)
C       RFD       I/O CURRENT RAINFALL DEPTH [CM]
C       RFDD  I/O TOTAL RAINFALL DEPTH [CM]
C       RFI       I/O CURRENT RAINFALL INTENSITY [CM/HR]
C       ROI       I/O TOTAL SURFACE RUNOFF [CM]
C       RP         I  RADIUS OF CYLINDRICAL MACROPORES IN HORIZON [CM]
C       RR        I/O RAINFALL RATE [CM/HR]
C       RRC        I  IRRIGATION WATER CHEMISTRY [MG/L]
C       RTMM   L  AMT OF RAINFALL [MM]
C       SC         L  CURRENT SCENERIO NUMBER [1-8]
C       SCUPCH     L  CUMMULATIVE CHEM. SEEPAGE FROM MACROPORES
C       SI         L  PRESSURE HEAD AT AVG WATER CONTENT [CM]
C       SLKS   I  SOIL LAYER KD VALUES; CORRECTED FOR OM [CM^3/G]
C       SMELT  I  SNOWMELT FOR TODAY (CM)
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       SOLTP1     I  ARRAY OF HEAT MODEL PARAMETERS,
C                  1: SAT MOISTURE CONTENT [0..1]
C                  2: FIELD CAPACITY [0..1]
C                  3: TEXTURE CLASS (1-COARSE, 2-MED, 3-FINE)
C                  4: # CONSTITUENTS FOR THERMAL PROPERTY CALC
C                  5: DRY VOL HEAT CAPACITY  [J/MM^3/C]
C       SUBDR  I  FLUX OUT TILE DRAIN [CM/HR]
C       SWF       I/O AVE WETTING-FRONT SUCTION [CM]
C       T      I  SOIL TEMPERATURE IN NUMERICAL CONFIGURATION [C]
C       TAIRR I/O NITROGEN IN IRRIGATION WATER
C       TARAIN    I/O NITROGEN IN RAIN WATER
C       TDFLOW    I/O CUMMULATIVE TIME OF FLOW IN DEAD END MACROPORES [HR]
C       TEMIN  L  TEMPERATURE ENERGY INPUT
C       TEMP   L  TEMPERATURE OF LAYER (C)
C       TEMPR  I  TEMPERATURE OF RAIN (C)
C       TFLOW I/O CUMMULATIVE TIME OF MACROPORE FLOW [HR]
C       THETA  I  VOLUMETRIC WATER CONTENT [CM^3/CM^3]
C       THSMS I/O SATURATED WATER CONTENT OF MESOPORES [0..1]
C       TIMAS  L  INITIAL TOTAL WATER CONTENT
C       TITEM  L  INITIAL TOTAL TEMPERATURE ENERGY
C       TLRO  I/O LOSS OF NITROGEN DUE TO RUNOFF [KG-N/HA]
C       TLT        I  DEPTH TO BOTTOM OF NUMERICAL LAYERS [CM]
C       TR        I/O CUMMULATIVE TIME OF RAINFALL [HR]
C       TTMAS  L  FINAL TOTAL WATER CONTENT
C       TTTEM  L  FINAL TOTAL TEMPERATURE ENERGY
C       TWC        L  OLD MOISTURE CONTENTS [0..1]
C       TWOPI I/O VALUE OF 2.0*PI
C       UGSEEP     L  SEEPAGE OUT BOTTOM OF PROFILE DO TO UG FLOW
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C       WCAB   L  MOISTURE CONTENT PLUS KD FACTOR
C       WCJ        L  SATURATED MOISTURE CONTENT
C       WCM        L  CURRENT WATER CONTENT
C       WCMC   L  WATER CONTENT IN MICROPORES
C       WCMS   L  WATER CONTENT IN MESOPORES
C       WI        I/O AVERAGE INITIAL WATER CONTENT OF HORIZON [0..1]
C       WIJ        L  SUMMATION VARIABLE
C       WP         I  WIDTH OF RECTANGULAR CRACKS IN HORIZON [CM]
C       X      L  I: PREVIOUS SOLUTION VECTOR, O: REPLACED WITH XNEW
C       X2CONC     L  PEST. CONC. INVOLVED IN KNETIC PROCESSES [UG/G SOIL]
C       YESMAC     I  INDICATS PRESENCE OF MACROPORES =1 YES, =0 NOT
C       ZRFDD I/O TOTAL RAINFALL DEPTH (FOR OUTPUT) [CM]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 AVGRID
C                 CHEMBL
C                 INFIL
C                 IT2H
C                 MOVE
C                 MOVET
C                 NTRPTR
C                 PEWASH
C                 POINTK
C                 SGATE
C                 WC
C                 WCH
C
C       CALLED FROM:  PHYSCL 
C
C       PROGRAMMER:  KEN ROJAS, K.E. JOHNSEN AND DR. L. AHUJA
C
C       VERSION:   2.15
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MAXBP=50,MXNOD=300,MXNODT=3001,MAXHOR=12,MXCHEM=15,
     +    MXPEST=3,MXSPEC=10,MXANA=135)
      PARAMETER(MXTSTP=5000)
      PARAMETER(CW=4.184D-3)
      common /Gleams_hydsol/gleams_clay,gleams_silt,gleams_por,   !chd  GLEAMS
     +        gleams_om1,gleams_sand,gleams_BulkDn,gleams_Dacre, 
     +        gleams_CHS,gleams_ei,gleams_exrain,thirtyRR,  
     +        IBYEAR,IEYEAR 
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
C   ...COMMON SPACE FOR INFILTRATION AND EVENT-TRANSPORTATION
C
C ----------------------------------------------------------------------
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
C ----------------------------------------------------------------------
      COMMON /IPMACF/ AGSZ(MAXHOR),FDEP(MAXHOR),MCPOR(MAXHOR),PI,
     +    PL(MAXHOR),RP(MAXHOR),SFCT,TWOPI,WP(MAXHOR),NHCMP,YESMAC,
     +    EFFWR,EFFWC,XPRESF
C ----------------------------------------------------------------------
      COMMON /IPINF/ CRUSTK,OCRUST,ICRUST,INFLPD,NHZ,NSLT,POND,RR,
     +    DHB(MAXHOR),NSL(MAXHOR),WI(Mxnod),DSL(MXNODT),VWC(MXNODT),
     +    IUGFLW
C ----------------------------------------------------------------------
      DOUBLE PRECISION MICP,MCPOR,NPOR
      INTEGER YESMAC
      COMMON /OPINF/ RO,SWF(MXnod),TR(MXTSTP),CI(MXTSTP),CRFD(MAXBP),
     +    CRFT(MAXBP),RFI(MAXBP),RFDD,RFD
      COMMON /OPCHEM/ THSMS(MXNOD,MXCHEM),CUPRO,CUPCHM(MXCHEM),CDNCI,
     +    CDNCHM(MXCHEM),CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),
     +    CRO(MXTSTP,MXCHEM)
      COMMON /OPMACF/ CDBET(MXNODT,MXCHEM),CFLOW(MXNODT,MXCHEM),
     +    CDFLOW(MXNODT,MXCHEM),CUMCLM(MXTSTP,MXCHEM),
     +    CUMCLR(MXTSTP,MXCHEM),CUMMF(MXTSTP),CUMRO(MXTSTP),
     +    DBET(MXNODT),DFLOW(MXNODT),FLOW(MXNODT),TDFLOW(MXNODT),
     +    TFLOW(MXNODT)
      COMMON /INFILC/ RAC(11),RRC(11),FERTIR(4),PESTIR(MXPEST),FMNRIR
      COMMON /ICMASW/ CMASW(MXNODT,MXCHEM)
C
C
      COMMON /KNTCS/ CONCX2(MXNOD,MXPEST),EK2(MXNOD,MXPEST),
     +    RK2(MXPEST),RDIF(MXPEST),FEK2(MXPEST),IEK2(MXPEST)
C
C     PESTICIDE COMMON VARIABLES
      COMMON /PINFO/ TSOTP0(MXPEST),TAPAP(MXPEST),TLPRS(MXPEST),
     +    TLPCN(MXPEST),TLPSL(MXPEST),TLPRO(MXPEST),TLPLC(MXPEST),
     +    TDPPLNT(MXPEST),TLPDT(MXPEST),TLPDTD(MXPEST),
     +    TLPDTL(MXPEST),TLPDMA(MXPEST)
C
      COMMON /RZPEST/ HALFF(MXPEST),HALFFP(MXPEST),HALFFB(MXPEST),
     +    HALFR(MXPEST),HALFRP(MXPEST),HALFRB(MXPEST),HALFSSA(MXPEST),
     +    HALFSSV(MXPEST),HALFSSP(MXPEST),HALFSSB(MXPEST),
     +    HALFSA(MXPEST),HALFSN(MXPEST),HALFSB(MXPEST),HALFBD(MXPEST),
     +    XKH(MXPEST),XKOC(MXPEST),XMW(MXPEST),THETAR(MXPEST),
     +    TMPR(MXPEST),EA(MXPEST),EN(MXPEST),WALKERB(MXPEST),
     +    VMAX(MXPEST),DYIELD(4,MXPEST),FREUND(MXPEST),XPKA(MXPEST),
     +    XPKB(MXPEST),REFPH(MXPEST),CATKOC(MXPEST),ANKOC(MXPEST),
     +    PCOEFF(MXPEST),PPOWER(MXPEST),RCOEFF(MXPEST),RPOWER(MXPEST),
     +    XKOW(MXPEST),PBIND(MXPEST),IPCODE(4,MXPEST),IPANC(MXPEST),
     +    IPDEP(MXPEST),IPACTV(MXPEST),NPEST
C
C
      COMMON /INTMCF/ FLXMAX(MAXHOR),DB(MAXHOR),NPOR(MAXHOR)
C
      COMMON /NINFO/ TSOTN0,TSOTN,TOTA,TOTL,TAMIN,TANIT,TADRT(2),
     +    TARAIN(2),TAIRR(3),TAFERT(3),TARES(3),TLIMM,TLDEN,TLVOL,
     +    TLRO(3),TLSEP(3),TLDRN(3),TLLAT(3),TAMANR,TMANH4,tamanr_bal
     +    ,TLN2O,TLNXO,TLNITN2O,TLNITNXO,TLGHGADS,TLGHGADSden
C
      COMMON /CINFO/TAMANC,TADRTC(2),TARESC(3),TOTCO2,TACUREA,YIELDC
     +             ,TAMANC_BAL,RCO2,TCAG,TCBG,TOTCH4,TOTCO2NI
C
C=======================================================================
      CHARACTER SOLTYP*10,NMPEST*30,PLNAME*30
      COMMON /NAMES/ NMPEST(MXPEST),SOLTYP(MAXHOR),PLNAME(MXSPEC)
C-----------------------------------------------------------------------
      COMMON /HYDROL/ AEF,BOTFLX,DRDEP,DRSPAC,DRRAD,CLAT(MAXHOR),
     +    H(MXNOD),HKBAR(MXNOD),QF(MXNOD),SOILHP(13,MAXHOR),HFC,HWP,
     +    THETA(MXNOD),thetai(mxnod),RICH_EPS,IREBOT,ITBL,IDRAIN,
     +    MAXITER_RICH,MAXCYCLE_RICH
C
C     ..PASSED THROUGH PARAMETER LIST
      DIMENSION CC(MXNOD,MXCHEM),BPWHEN(MAXBP),BPMUCH(MAXBP),
     +    COPLNT(MXPEST),CORES(MXPEST),SLKS(MXNOD,MXPEST,2),
     +    DTCHEM(MXCHEM),SOLTP1(MAXHOR,5),T(NN),BKCHEM(MXCHEM),
     +    DTDCHEM(MXCHEM),H2OTAB(2),TLT(MXNOD),HORTHK(MAXHOR),
     +    OMSEA(MXANA),pori(mxnod),porav(mxnodt)
C
C     ..LOCALLY DIMENSIONED
      DIMENSION CONC(MXNODT,MXCHEM),X2CONC(MXNODT,MXPEST),
     +    CUMDR(MXTSTP),CSHD(MAXHOR),TEMP(MXNODT),BRKMAS(MXCHEM),
     +    SCUPCH(MXCHEM),CRAIN(MXCHEM),DRCHEM(MXTSTP,MXCHEM),
     +    CHJ(MAXHOR),CSHWS(MAXHOR),TWC(MXNODT),CMACSEP(MXTSTP,MXCHEM),
     +    WMACSEP(MXTSTP),CUMPWASH(MXCHEM),ALHMAC(MXNOD,MXCHEM),
     +    cnn(mxnod),PORNN(MXNOD),cinf(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C
      LOGICAL FIRST3
      SAVE FIRST3  !,SCUPCH
      DATA FIRST3 /.TRUE./  !,SCUPCH /MXCHEM*0.0D0/
C ----------------------------------------------------------------------
C
C     ..FIND MAX CAP OF D.E. MPORES, # OF MPORES, MAX FLUX INTO MPORES
      IF(FIRST3) THEN
        PI=3.141592653589791D0
        TWOPI=6.2818531D0
        FIRST3=.FALSE.
        IF(YESMAC.GE.1) THEN
          DO 10 J=1,NHZ
            DB(J)=MCPOR(J)*FDEP(J)
            IF(J.GT.NHCMP) THEN
              NPOR(J)=MCPOR(J)/(WP(J)*PL(J))
              FLXMAX(J)=8172.5D0*WP(J)**2.0D0*MCPOR(J)*3600.0D0
            ELSE
              NPOR(J)=MCPOR(J)/(PI*RP(J)**2.0D0)
              FLXMAX(J)=12259.0D0*RP(J)**2.0D0*MCPOR(J)*3600.0D0
            ENDIF
   10     CONTINUE
        ENDIF
      ENDIF
C
C     ..INITIALIZE
      DO 30 I=1,NSLT+1
        DO 20 IC=1,MXCHEM
          CONC(I,IC)=0.0D0
          IF(IC-12 .GT. 0) X2CONC(I,IC-12)=0.0D0
   20   CONTINUE
        TEMP(I)=0.0D0
        VWC(I)=0.0D0
   30 CONTINUE
C
      DO 40 I=1,MXTSTP
        TR(I)=0.0D0
        CI(I)=0.0D0
   40 CONTINUE
C
      DO 60 IH=1,NN
        DO 50 IC=1,MXCHEM
          ALH(IH,IC)=0.0D0
          ALHMAC(IH,IC)=0.0D0
   50   CONTINUE
   60 CONTINUE
C
C     ..A FEW MORE INITIALIZATIONS
      RFD=0.0D0
      RR=0.0D0
      NTIM=0
C
C     ..INTERPOLATE THE THETA VALUES INTO THE INFILTRATION GRID
      CALL NTRPTR(THETA,VWC)

cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
C     gnf    
c     jak
c     FIGURE OUT THE AMOUNT OF AVAILABLE PORE SPACE FOR SATURATION
      DO 65 I = 1, NN
        IH = NDXN2H(I)
        IF (PORI(I) .GT. 0.0D0) THEN
          PORNN(I) = PORI(I)
        ELSE
          PORNN(I) = SOILHP(6,IH)*AEF
        ENDIF
65    CONTINUE
C     ..INTERPOLATE AVAILABLE POROSITY VALUES INTO THE INFILTRATION GRID
      CALL NTRPTR(PORNN,PORAV)
	PORAV(NSLT+1)=PORAV(NSLT)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C     ..CALCULATE THE AVERAGE INITIAL WATER CONTENT FOR EACH HORIZON
C     ..CALCULATE THE AVERAGE INITIAL WATER CONTENT FOR EACH Numerical Layer
c     Liwang Ma, 12-16-2008
      IB=1
c      DO 80 J=1,NHZ
      DO 80 Jjj=1,NN
C       ..SAVE DRY VOLUMETRIC HEAT CAPCITY
        j = ndxn2h(jjj)
        CSHD(J)=SOLTP1(J,5)
C
c        IE=NSL(J)
         IE=INT(TLT(JJJ))
        WIJ=0.0D0
        DO 70 JJ=IB,IE
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     gnf
c     jak
          VWC(JJ) = MIN(VWC(JJ),PORAV(JJ))
c          VWC(JJ)=MIN(VWC(JJ),(SOILHP(6,J)*AEF))
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
          WIJ=WIJ+VWC(JJ)
   70   CONTINUE
cLiwang Ma        WI(J)=WIJ/DHB(J)
cLiwang Ma        IF(J.GT.1) WI(J)=WIJ/(DHB(J)-DHB(J-1))
        WI(Jjj)=WIJ/tlt(Jjj)
        IF(Jjj.GT.1) WI(Jjj)=WIJ/(tlt(Jjj)-tlt(Jjj-1))
C        IB=NSL(J)+1
         IB=INT(TLT(JJJ))+1
   80 CONTINUE
C
C     ..DECIDE IF WE ARE IN RAINFALL OR PONDED WATER CONDITION
      POND=0.0D0
      IF(BPWHEN(1).NE.0.0D0) THEN
C       ...ZERO OUT RAINFALL INTENSITIES
        DO 90 K=1,MAXBP
          RFI(K)=0.0D0
   90   CONTINUE
C       ..MOVE THE BREAK-POINT RAINFALL DATA INTO WORK VECTORS
c        CRFD(1)=BPMUCH(1)*min(1.0d0,-5.0d0*(pplastic-1.0d0))   !Liwang 2017  >80%
        CRFD(1)=BPMUCH(1)*min(1.0d0,-10.0d0*(pplastic-1.0d0))   !Liwang 2017  >90%
        RFI(1)=CRFD(1)/BPWHEN(1)
        RFDD=CRFD(1)
        DO 100 J=2,NBP
          CRFD(J)=0.0D0
c          CRFD(J)=CRFD(J-1)+BPMUCH(J)*min(1.0d0,-5.0d0*(pplastic-1.0d0))   !Liwang 2017
         CRFD(J)=CRFD(J-1)+BPMUCH(J)*min(1.0d0,-10.0d0*(pplastic-1.0d0))    !Liwang 2017
C         ...CALCULATE BREAK POINT RAINFALL INTENSITIES
          IF(BPWHEN(J).EQ.0.0D0) THEN
            RFI(J)=0.0D0
          ELSE
            RFI(J)=(CRFD(J)-CRFD(J-1))/BPWHEN(J)
            RFI(J)=MAX(RFI(J),0.0D0)
          ENDIF
          RFDD=MAX(CRFD(J),RFDD)
  100   CONTINUE
        INFLPD=0
      ELSE
        POND=AIRR*0.5D0
C       ..SET TOTAL DEPTH TO PONDED WATER DEPTH
        INFLPD=1
        RFDD=AIRR
C       ..SET RAINFALL INTENSITY TO SAT. COND.
        RFI(1)=1.0D0
      ENDIF
C
      IF(INFLPD.NE.1) RR=RFI(1)
C
C     START INFILTRATION PROCESS AND CHEMICAL ROUTING
C====================================================
C     ..FIND INITIAL TOTAL WATER CONTENT
      TIMAS=0.0D0
      DO 110 I=1,NSLT
        TIMAS=TIMAS+VWC(I)
  110 CONTINUE
C
C     ..MOVE TEMPERATURE INTO INFIL GRID
      CALL NTRPTR(T,TEMP)
C
C     ..FIND INITIAL TOTAL TEMPERATURE ENERGY
      TITEM=0.0D0
      DO 120 I=1,NSLT
        NH=IT2H(I)
        TITEM=TITEM+TEMP(I)*(VWC(I)*CW+CSHD(NH))*1.0D3
  120 CONTINUE
C
C     ..CYCLE THROUGH CHEMICALS TO FIND NEEDED INITIAL VALUES
      DO 180 IC=1,MXCHEM
        CRAIN(IC)=0.0D0
C       ..MOVE CHEMICAL INTO INFIL GRID
        CALL NTRPTR(CC(1,IC),CONC(1,IC))
C       ..FIND AMOUNT OF CHEMICAL THAT WILL BE ADDED TO SYSTEM
        IF(AIRR.EQ.0.0D0) THEN
C         ..RAINFALL EVENT
          IF(IC.LE.8) THEN
            CRAIN(IC)=RAC(IC)
          ELSEIF(IC.EQ.11) THEN
            CRAIN(IC)=RAC(9)
          ELSEIF(IC.LE.10) THEN
            TARAIN(IC-8)=TARAIN(IC-8)+RAC(10-IC+10)*RFDD*0.1D0
            CRAIN(IC)=RAC(10-IC+10)
          ENDIF
        ELSE
C
C         ..IRRIGATION EVENT
          IF((IC.GE.1.AND.IC.LE.8).OR.IC.EQ.11) THEN
            CRAIN(IC)=RRC(IC)
            IF(IC.EQ.11) CRAIN(IC)=RRC(9)
          ELSEIF(IC.LE.10) THEN
C
C           ..ADD IN (10) NH4 AND (9) NO3 FROM FERTLIZER AMOUNTS
            CRAIN(IC)=RRC(10-IC+10)+FERTIR(IC-8)
C
C           ..ADD IN MANURE NH4 AMOUNTS
            IF(IC.EQ.10) CRAIN(IC)=CRAIN(IC)+FMNRIR
C
C           ..SEND AMOUNTS BACK TO NITBAL ROUTINE
            IF(SMELT.GT.0.0D0) THEN
              TAIRR(IC-8)=0.0D0
            ELSE
              TAIRR(IC-8)=TAIRR(IC-8)+(RRC(10-IC+10)+FERTIR(IC-8))*RFDD*
     +            0.1D0
            ENDIF
            FERTIR(IC-8)=0.0D0
          ELSEIF(IC.EQ.12) THEN
C           .. ADD IN UREA FERTILIZER
            CRAIN(IC)=FERTIR(IC-8)
            TAIRR(IC-9)=TAIRR(IC-9)+FERTIR(IC-8)*RFDD*0.1D0
            FERTIR(IC-8)=0.0D0
          ENDIF
          IF(SMELT.GT.0.0D0) CRAIN(IC)=0.0D0
        ENDIF
C
C       ..FIND PESTICIDES TO BE ADDED TO SYSTEM
        IF(IC.GT.12.AND.IC.LE.12+MXPEST) THEN
          IP=IC-12
          IF(IPACTV(IP).NE.1) GOTO 150
          IF(AIRR.GT.0.0D0) CRAIN(IC)=CRAIN(IC)+PESTIR(IP)
          PESTIR(IP)=0.0D0
CC          DO 140 IH=1,NHZ
            DO 130 IK=1,NN
CC              KWR=NDXN2H(IK)
CC              IF(KWR.EQ.IH) THEN
c liwang ma, 7-3-2006
c                ALH(IK,IC)=SLKS(IK,IP,1)
c                ALHMAC(IK,IC)=SLKS(IK,IP,2)
                IH=NDXN2H(IK)
                ALH(IK,IC)=fslks(SLKS(IK,IP,1),conc(ik,ic),
     +                 freund(ip),theta(ik),bdh(ih))
                ALHMAC(IK,IC)=fslks(SLKS(IK,IP,2),conc(ik,ic),
     +                 freund(ip),theta(ik),bdh(ih))
c                ALHMAC(IH,IC)=ALHMAC(IH,IC)+SLKS(IK,IP,2)/NDXH2N(IH)
c                ALH(IH,IC)=ALH(IH,IC)+fslks(SLKS(IK,IP,1),conc(ik,ic),
c     +                 freund(ip),theta(ik),bdh(ih))/NDXH2N(IH)
CC              ENDIF
  130       CONTINUE
CC  140     CONTINUE
          CALL NTRPTR(CONCX2(1,IP),X2CONC(1,IP))
        ENDIF
C
C       ..TO LIMIT MOVEMENT OF AMMONIA, GIVE IT A KD VALUE
  150   IF(IC.EQ.10) THEN
          DO 160 IH=1,NN
            ALH(IH,IC)=1.0D5
            ALHMAC(IH,IC)=1.0D5
  160     CONTINUE
          DO 170 IK=1,NSLT
            IL=NDXT2N(IK)
            IH=IT2H(IK)
            CONC(IK,IC)=VWC(IK)*CONC(IK,IC)/(VWC(IK)+ALH(IL,IC)*
     +          BDH(IH))
  170     CONTINUE
        ENDIF
C
  180 CONTINUE
C
C     ..FIND SUCTION AT THE WETTING FRONT
c    find suction head in a numerical layer
c      DO 190 I=1,NHZ
      DO 190 jj=1,NN
        I=ndxn2h(jj)
        DS1=SOILHP(10,I)
        DS2=SOILHP(1,I)
        DN1=SOILHP(12,I)
        DN2=SOILHP(3,I)
        DC1=SOILHP(4,I)
        DC2=SOILHP(11,I)
        SI=-1.0D0*WCH(-DS2,WI(jj),SOILHP(1,I),I,0)
C
C       ..MODIFIED BROOKS-COREY FUNCTION ANALYTICALLY INTEGRATED
        IF(SI.GT.DS1) THEN
          SWF(jj)=DC2/(1.0D0-DN2)*(SI**(1.0D0-DN2)-DS1**(1.0D0-DN2))
          SWF(jj)=SWF(jj)+DC1/(1.0D0-DN1)*(DS1**(1.0D0-DN1)-1.0D0)
        ELSEIF(SI.LE.DS1) THEN
          IF(SI.GT.1.0D0) THEN
            SWF(jj)=DC1/(1.0D0-DN1)*(SI**(1.0D0-DN1)-1.0D0)
          ELSE
            SWF(jj)=DC1
          ENDIF
        ENDIF
        SWF(jj)=SWF(jj)/DC1+POND+1.0D0
  190 CONTINUE
C
C     ..ADJUST K OF TOPSOIL IF CRUST IS PRESENT
      CH1=SOILHP(4,1)
      SC=0.0D0
      CRT=0.0D0
      IF(ICRUST.NE.0.AND.CRUSTK.NE.0.0D0) THEN
        CRT=0.5D0/CRUSTK
        SC=(SOILHP(4,1)*CRT)**(1.0D0/(SOILHP(12,1)+1.0D0))
        IF(SC.GT.SOILHP(10,1)) SC=(SOILHP(11,1)*CRT)**(1.0D0/(
     +      SOILHP(3,1)+1.0D0))
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     gnf
c     jak
        CH1=POINTK(-SC,SOILHP(1,1),1,pori(1))
      ENDIF
c      CHJ(1)=CH1
C
C     ..FIND MAX CONDUCTIVITIES THROUGH HORIZONS
c      DO 200 J=2,NHZ
c        CHJ(J)=SOILHP(4,J)
c        IF(CHJ(J).GT.CHJ(J-1)) CHJ(J)=CHJ(J-1)
c  200 CONTINUE
C
      CNN(1) = CH1

C gnf 9/11/98
c limit conductivity according to pori, which reflects ice content
c chj redefined to cnn, conductivity of soil layers rather than horizon
C     ..FIND MAX CONDUCTIVITIES THROUGH LAYERS AS LIMITED BY ICE CONTENT
c      HTMP = -SOILHP(1,1)                              !commented out by Liwang Ma, 8-7-2009
c      HTMP = WCH(HTMP, PORI(1), SOILHP(1, 1),1,0)      !commented out by Liwang Ma, 8-7-2009
c      CNN(1) = POINTK(HTMP,SOILHP(1,1),1,PORI(1))      !commented out by Liwang Ma, 8-7-2009
c      CNN(1) = MIN(CNN(1),SOILHP(4, 1))                !commented out by Liwang Ma, 8-7-2009
      DO 200 J = 2, NN
         JH = NDXN2H(J)
         HTMP = -SOILHP(1,JH)
c         HTMP = WCH(HTMP, PORI(J), SOILHP(1, JH),jh,0)  !commented out by Liwang Ma, 8-7-2009
         CNN(J) = POINTK(HTMP,SOILHP(1,JH),jh,PORI(J))
         CNN(J) = MIN(CNN(J),SOILHP(4, JH))
         IF (CNN(J) .GT. CNN(J - 1)) CNN(J) = CNN(J - 1)   !should this be .le.?
  200 CONTINUE
C     ..MOVE CONDUCTIVITY INTO INFIL GRID
c      CALL NTRPTR(CNN,CINF)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C     ..zero MICROPOROSITES IF NOT GIVEN:
      IF(NMICP.NE.1) THEN
        DO 210 J=1,NHZ
c          MICP(J)=WC(-2000.D0,SOILHP(1,J),J,0)/SOILHP(6,J)   !assume 2 bar as microposity
          MICP(J)=SOILHP(9,J)/(SOILHP(6,J)*AEF)   !assume 15 bar as microposity
c          MICP(J)=0.0d0
  210   CONTINUE
      ENDIF
C
C     ..SET H2OTAB TO TOP OF THE SATURATED ZONE TO AVOID
C     DESATURATION PROBLEMS
      IF(ITBL.EQ.1) H2OTAB(2)=CAPZONE
      ORIGH2OTAB = H2OTAB(2)
C     3.19.2002
C
C     ..DETERMINE THE DEGREE OF MIXING IN TOP 2 CM
      DO 220 J=1,2
        X=DBLE(J)-0.5D0
        DEG(J)=A*EXP(-B*X)
  220 CONTINUE
C
C     ..INITIALIZE ACCUMULATORS (ACCUM. WITH TIME)
      DO 240 J=1,MXTSTP
        CUMDR(J)=0.0D0
        CUMRO(J)=0.0D0
        CUMMF(J)=0.0D0
        DO 230 IC=1,MXCHEM
          CRO(J,IC)=0.0D0
          CUMCLR(J,IC)=0.0D0
          CUMCLM(J,IC)=0.0D0
          DRCHEM(J,IC)=0.0D0
  230   CONTINUE
  240 CONTINUE
        gleams_exrain = 0.0D0   ! CHD excess rain in/hr
        gleams_ei = 0.0D0       ! CHD Wischmeier's rainfall erosivity: 100(ft-tons/acre)(hr/in)
C
C     ..INITIALIZE ACCUMULATORS (ACCUM. WITH DEPTH)
      DO 260 J=1,NSLT+1
        JJ=IT2H(J)
        DBET(J)=0.0D0
        FLOW(J)=0.0D0
        DFLOW(J)=0.0D0
        TFLOW(J)=0.0D0
        TDFLOW(J)=0.0D0
        WMACSEP(J)=0.0D0
        DO 250 IC=1,MXCHEM
          CMASW(J,IC)=0.0D0
          CDBET(J,IC)=0.0D0
          CFLOW(J,IC)=0.0D0
          CMACSEP(J,IC)=0.0D0
          CDFLOW(J,IC)=0.0D0
          CMICR(J,IC)=0.0D0
          CMESO(J,IC)=CONC(J,IC)
          IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CONC(J,IC)
  250   CONTINUE
  260 CONTINUE
      CUPRO=0.0D0
      CDNCI=0.0D0
      BRKWAT=0.0D0
      UGSEEP=0.0D0
      BFSEEP=0.0D0
      CDNHT=0.0D0
      DRHT=0.0D0
      TEMIN=0.0D0
      FMP=0.0D0
      ROI=0.0d0
      DO IJ=1,NBP
c        ROI=ROI+BPMUCH(IJ)*(1.0d0-min(1.0d0,-5.0d0*(pplastic-1.0d0)))    !LIWANG 2017
        ROI=ROI+BPMUCH(IJ)*(1.0d0-min(1.0d0,-10.0d0*(pplastic-1.0d0)))    !LIWANG 2017
      ENDDO
      RINDR=0.0D0
      CII=0.0D0
      DRSEEP=0.0D0
      DO 270 IC=1,MXCHEM
        CUPCHM(IC)=0.0D0
        CDNCHM(IC)=0.0D0
        BRKMAS(IC)=0.0D0
        CUMPWASH(IC)=0.0D0
C
C       ..FIND INITIAL CHEMICAL AMOUNTS
        IP=IC-12
        CALL CHEMBL(CONC(1,IC),0,IP,IC,CDNCHM(IC)+CUPCHM(IC),CRAIN(IC),
     +      X2CONC,IMAGIC,0.0D0,0.0D0)
  270 CONTINUE
      DO 290 J=1,NN
        DO 280 IC=1,MXCHEM
          JJ=NDXN2H(J)  !STOPPED HERE 3-27-2009
C          jk=NDXT2N(j)
          THSMS(J,IC)=(pori(J)+ALH(J,IC)*BDH(JJ))*(1.0D0-
     +        MICP(JJ))
  280   CONTINUE
        CSHWS(JJ)=(pori(J)*CW+CSHD(JJ))*1.0D3
c        CSHWS(JJ)=(SOILHP(6,JJ)*AEF*CW+CSHD(JJ))*1.0D3
  290 CONTINUE
C
CC      DO 290 J=1,NN
CC        DO 280 IC=1,MXCHEM
CC          JJ=NDXN2H(J)  !STOPPED HERE 3-27-2009
CC          THSMS(J,IC)=(SOILHP(6,JJ)*AEF+ALH(J,IC)*BDH(JJ))*(1.0D0-
CC     +        MICP(JJ))
CC  280   CONTINUE
CC        CSHWS(JJ)=(SOILHP(6,JJ)*AEF*CW+CSHD(JJ))*1.0D3
C
C     ..CALC THE INFILTRATION
      CALL INFIL(I,CONC,CRAIN,X2CONC,TEMPR,TEMP,CW,CSHD,CSHWS,AEF,IBRK,
     +    BRKWAT,BRKMAS,IREBOT,UGSEEP,BOTFLX,SUBDR,ITBL,SOILHP,CUMRO,
     +    CUMDR,DRCHEM,BFSEEP,CDNHT,YESMAC,NN,TLT,HORTHK,CUMCLR,THGCUR,
     +    DRSPAC,DRRAD,H2OTAB,NHOR,Cnn,NTIM,DRHT,RINDR,CLAT,ID,FLXMAX,
     +    FDEP,IDP,CMACSEP,WMACSEP,COPLNT,CORES,RESCOV,CUMPWASH,IDRAIN,
     +    ALHMAC,XPRESF,CUMMF,CUMCLM,pori,porav,Hmin)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee

C
C     ..COMBINE CHEMICALS INTO CONC AND DETERMINE TEMPERATURE
C
C     ..SAVE CURRENT WC VALUES
      DO 300 J=1,NSLT
        TWC(J)=VWC(J)
  300 CONTINUE
C
      DO 350 IC=1,MXCHEM
C
C       ..RESET WC VALUES FOR EACH CHEMICAL
        DO 310 J=1,NSLT
          VWC(J)=TWC(J)
  310   CONTINUE
C
c        H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
c        IF((YESMAC.EQ.0).or.(h2ot2.le.2.0d0)) THEN
        IF((YESMAC.EQ.0)) THEN
C
C         .. NO MACROPORE FLOW
          DO 320 J=1,NSLT
            JJ=IT2H(J)
            JK=NDXT2N(J)
            WCM=VWC(J)
            WCAB=WCM+ALH(JK,IC)*BDH(JJ)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
            WCMC = (porav(J)+ALH(JK,IC)*BDH(JJ))*MICP(JJ)
            IF (porav(J)*MICP(JJ).GT.WCM)
     +         WCMC=(WCM+ALH(JK,IC)*BDH(JJ))*MICP(JJ)  !should this be the one?
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            WCMS=WCAB-WCMC
            CONC(J,IC)=(CMESO(J,IC)*WCMS+CMICR(J,IC)*WCMC)/WCAB
  320     CONTINUE
        ELSE
C
C         .. MACROPORE FLOW
          DO 330 J=1,NSLT
            JJ=IT2H(J)
            JK=NDXT2N(J)
            WCM=VWC(J)
            WCAB=WCM+ALH(JK,IC)*BDH(JJ)
            WCMC=(porav(J)+ALH(JK,IC)*BDH(JJ))*MICP(JJ)
            IF(porav(J)*MICP(JJ).GT.WCM) WCMC=(WCM+ALH(JK,IC)*
     +          BDH(JJ))*MICP(JJ)
            WCMS=WCAB-WCMC
            CONC(J,IC)=(CMASW(J,IC)+CDBET(J,IC)+CMESO(J,IC)*WCMS+
     +          CMICR(J,IC)*WCMC)/(WCMC+WCMS+DBET(J))
C
C           ..UPDATE TEMPERATURE
            IF(IC.EQ.1) THEN
              TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
              TFLO=0.0D0
              TFLI=DBET(J)*CW*1.0D3
              DENT=((VWC(J)+DBET(J))*CW+CSHD(JJ))*1.0D3
              TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+TEMPR*TFLI)/DENT
            ENDIF
C
            VWC(J)=VWC(J)+DBET(J)
  330     CONTINUE
C
          DSTORE=0.0D0
          DO 340 J=1,NSLT
            JJ=IT2H(J)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
            JK=NDXT2N(J)
		  wcj = porav(J)
c gnf-ma      WCJ = SOILHP(6, JJ) * AEF
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            IF(J.EQ.1) THEN
              IF(VWC(J).GT.WCJ) THEN
                DSTORE=VWC(J)-WCJ
                VWC(J)=WCJ
              ENDIF
            ELSE
              IF(DSTORE.GT.0.0D0) THEN
C
C               .. ACCUMULATE IF BREAKTHROUGH LAYER
                IF(J.EQ.IBRK+1) THEN
                  BRKMAS(IC)=BRKMAS(IC)+DSTORE*CONC(J-1,IC)
                  IF(IC.EQ.1) BRKWAT=BRKWAT+DSTORE
                ENDIF
                WCAB=VWC(J)+ALH(JK,IC)*BDH(JJ)
                CONC(J,IC)=(CONC(J,IC)*WCAB+DSTORE*CONC(J-1,IC))/(WCAB+
     +              DSTORE)
C
C               ..UPDATE TEMPERATURE
                IF(IC.EQ.1) THEN
                  TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
                  TFLO=0.0D0
                  TFLI=DSTORE*CW*1.0D3
                  DENT=((VWC(J)+DSTORE)*CW+CSHD(JJ))*1.0D3
                  TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+TEMP(J-1)*TFLI)/
     +                DENT
                ENDIF
C
                VWC(J)=VWC(J)+DSTORE
                DSTORE=0.0D0
              ENDIF
              IF(VWC(J).GT.WCJ) THEN
                DSTORE=VWC(J)-WCJ
                VWC(J)=WCJ
              ENDIF
            ENDIF
  340     CONTINUE
C
C         THIS IS WHERE I NEED TO RAISE WATER TABLE!!
          IF(IC.EQ.1) THEN
            CUPRO=CUPRO+DSTORE
            CDNHT=CDNHT+TEMP(NSLT)*DSTORE*CW*1.0D3
          ENDIF
          CUPCHM(IC)=CUPCHM(IC)+DSTORE*CONC(NSLT,IC)
          CMACSEP(NSLT,IC)=CMACSEP(NSLT,IC)+CUPCHM(IC)
          WMACSEP(NSLT)=WMACSEP(NSLT)+DSTORE
C         .. ACCUMULATE IF BREAKTHROUGH LAYER
          IF(J.EQ.IBRK+1) THEN
            BRKMAS(IC)=BRKMAS(IC)+DSTORE*CONC(NSLT,IC)
            IF(IC.EQ.1) BRKWAT=BRKWAT+DSTORE
          ENDIF
        ENDIF
  350 CONTINUE
C
      IF(IMAGIC.EQ.-1.OR.IMAGIC.EQ.-2.OR.IMAGIC.EQ.-10) WRITE(79,*)
     +    ' JDAY ==> ',JDAY,IYYY
C
C     ..TRANSLATE WATER CONTENTS, TEMP AND CHEMS INTO VECTORS
      CALL MOVE(THETA,VWC)
      CALL MOVET(T,TEMP,VWC,CSHD,THETA)
C
      DO 370 IC=1,MXCHEM
        IP=IC-12
C
C       ..GET RID OF AMMONIA KD VALUE
        IF(IC.EQ.10) THEN
          DO 360 IK=1,NSLT
            IH=IT2H(IK)
            IL=NDXT2N(IK)
            CONC(IK,IC)=(VWC(IK)+ALH(IL,IC)*BDH(IH))*CONC(IK,IC)/
     +          VWC(IK)
            IF(IK.LT.NSLT) THEN
              IF(NDXT2N(IK+1).NE.IL) ALH(IL,IC)=0.0D0
            ELSE
              ALH(IL,IC)=0.0D0
              ALHMAC(IL,IC)=0.0D0
            ENDIF
  360     CONTINUE
        ENDIF
C
        CALL AVGRID(IC,CC(1,IC),CONC(1,IC),THETA,VWC,ALH,BDH,0)
C
C       ..TRACK MOVEMENT OF CHEMICALS
        DTCHEM(IC)=DTCHEM(IC)+CDNCHM(IC)+CUPCHM(IC)
        DTDCHEM(IC)=DTDCHEM(IC)+DRCHEM(NTIM,IC)
        SCUPCH(IC)=SCUPCH(IC)+CUPCHM(IC)
        IF(IC.EQ.9) THEN
          BKCHEM(9)=BKCHEM(9)+BRKMAS(9)
          TLRO(1)=TLRO(1)+CUMCLR(NTIM,IC)*0.1D0
        ELSEIF(IC.EQ.10) THEN
          TLRO(2)=TLRO(2)+CUMCLR(NTIM,IC)*0.1D0
        ELSEIF(IC.EQ.12) THEN
          TLRO(3)=TLRO(3)+CUMCLR(NTIM,IC)*0.1D0
        ELSEIF(IC.GE.13) THEN
          BKCHEM(IC)=BKCHEM(IC)+BRKMAS(IC)
          TLPRO(IP)=TLPRO(IP)+CUMCLR(NTIM,IC)*0.1D0
C         ..REDISTRIBUTE ADSORPED CONC
          CALL AVGRID(IC,CONCX2(1,IP),X2CONC(1,IP),THETA,VWC,ALH,BDH,1)
        ENDIF
C
C       ..DO CHEMICAL MASS BALANCE FOR STORM
        CALL CHEMBL(CONC(1,IC),1,IP,IC,CDNCHM(IC)+CUPCHM(IC),RFDD*(
     +      CRAIN(IC))+CUMPWASH(IC),X2CONC,IMAGIC,CUMCLR(NTIM,IC),
     +      DRCHEM(NTIM,IC))
        IF(IC.GT.12.AND.IC.LE.12+MXPEST) THEN
          CALL SGATE(DBLE(JDAY),82+IP,CUMCLR(NTIM,IC))
          OMSEA((8+IP)*5+5)=CUMCLR(NTIM,IC)*0.1D0
        ENDIF
  370 CONTINUE
C
      IF(IMAGIC.EQ.-1.OR.IMAGIC.EQ.-2.OR.IMAGIC.EQ.-10) THEN
C       ..FIND FINAL TOTAL WATER CONTENT
        TTMAS=0.0D0
        DO 380 I=1,NSLT
          TTMAS=TTMAS+VWC(I)
  380   CONTINUE
C       ..DO WATER MASS BALANCE
        CHKRAN=RFDD-CUMRO(NTIM)-CUMMF(NTIM)-RINDR-CDNCI-CI(NTIM)
        CHKMAS=TIMAS+RFDD-CUMRO(NTIM)-CUMDR(NTIM)-CDNCI-CUPRO-BFSEEP-
     +      UGSEEP-TTMAS
C
C       ..FIND FINAL TOTAL TEMPERATURE ENERGY
        TTTEM=0.0D0
        DO 390 I=1,NSLT
          NH=IT2H(I)
          TTTEM=TTTEM+TEMP(I)*(VWC(I)*CW+CSHD(NH))*1.0D3
  390   CONTINUE
C
C       ..DO ENERGY BALANCE
        TEMIN=TEMPR*(RFDD-CUMRO(NTIM))*CW*1.0D3
        CHKTEM=TITEM+TEMIN-CDNHT-DRHT-TTTEM
C
C       ..OUTPUT MASS BALANCES
        IF (CHKRAN.LT.1.0D-10) CHKRAN=0.0D0
        IF (CHKMAS.LT.1.0D-10) CHKMAS=0.0D0
        IF (CHKTEM.LT.1.0D-7) CHKTEM=0.0D0
        WRITE(9,*) ' MASS BALANCE FOR RAINFALL IS: ',CHKRAN
        WRITE(9,*) ' MASS BALANCE FOR PROFILE IS : ',CHKMAS
        WRITE(9,*) ' TEMP BALANCE FOR RAINFALL IS: ',CHKTEM
      ENDIF
C     --------------------------------------------------------------------------
      IF(IMAGIC.EQ.-10) THEN
          IC=13
c          J=NTIM
c          WRITE(179,1200) ' INFIL SUMMARY',JDAY,IYYY 
c          WRITE(179,1301) NMPEST(1),NMPEST(2),NMPEST(3)
          WRITE(179,1101) (JDAY,IYYY,J,TR(J),CI(J),CUMRO(J),CUMDR(J),
     +        CUMMF(J),WMACSEP(J),CRO(J,IC),CUMCLR(J,IC),DRCHEM(J,IC),
     +        CUMCLM(J,IC),CMACSEP(J,IC),
     +        CRO(J,IC+1),CUMCLR(J,IC+1),DRCHEM(J,IC+1),
     +        CUMCLM(J,IC+1),CMACSEP(J,IC+1),
     +        CRO(J,IC+2),CUMCLR(J,IC+2),DRCHEM(J,IC+2),
     +        CUMCLM(J,IC+2),CMACSEP(J,IC+2),J=NTIM,NTIM)
c
          WRITE(279,1101) (JDAY,IYYY,J,TR(J),CI(J),CUMRO(J),CUMDR(J),
     +        CUMMF(J),WMACSEP(J),CRO(J,IC),CUMCLR(J,IC),DRCHEM(J,IC),
     +        CUMCLM(J,IC),CMACSEP(J,IC),
     +        CRO(J,IC+1),CUMCLR(J,IC+1),DRCHEM(J,IC+1),
     +        CUMCLM(J,IC+1),CMACSEP(J,IC+1),
     +        CRO(J,IC+2),CUMCLR(J,IC+2),DRCHEM(J,IC+2),
     +        CUMCLM(J,IC+2),CMACSEP(J,IC+2),J=1,NTIM)
c
        WRITE(79,1150) ORIGH2OTAB
        DO 400 IC=13,12+NPEST
          WRITE(79,1200) ' INFIL SUMMARY',JDAY,IYYY,' AFTER CHEMICAL #',
     +      IC,' PESTICIDE : ',NMPEST(IC-12)
          WRITE(79,1300)
          WRITE(79,1100) (J,TR(J),CI(J),CUMRO(J),CRO(J,IC),
     +        CUMCLR(J,IC),CUMDR(J),DRCHEM(J,IC),CUMMF(J),CUMCLM(J,IC),
     +        CMACSEP(J,IC),WMACSEP(J),J=1,NTIM)
          WRITE(79,1400)
          DO 395 J=1,NSLT
            IF (J.EQ.INT(H2OTAB(2))) THEN
              WRITE(79,1505) J,VWC(J),CMESO(J,IC),CMICR(J,IC),
     +        CONC(J,IC),FLOW(J),DFLOW(J),CFLOW(J,IC),CDFLOW(J,IC),
     +        DBET(J),CDBET(J,IC),CMASW(J,IC)
            ELSEIF (J.EQ.INT(THGCUR)) THEN
              WRITE(79,1510) J,VWC(J),CMESO(J,IC),CMICR(J,IC),
     +        CONC(J,IC),FLOW(J),DFLOW(J),CFLOW(J,IC),CDFLOW(J,IC),
     +        DBET(J),CDBET(J,IC),CMASW(J,IC)
            ELSE
              WRITE(79,1500) J,VWC(J),CMESO(J,IC),CMICR(J,IC),
     +        CONC(J,IC),FLOW(J),DFLOW(J),CFLOW(J,IC),CDFLOW(J,IC),
     +        DBET(J),CDBET(J,IC),CMASW(J,IC)
            ENDIF
  395     CONTINUE
  400   CONTINUE
      ENDIF
C     --------------------------------------------------------------------------
C
C     ..REFORM SURFACE CRUST IF IT WAS DESTROYED BY TILLAGE
      IF(ICRUST.EQ.1) THEN
        IF(OCRUST.NE.0.0D0) THEN
          CRUSTK=OCRUST
        ELSE
          CRUSTK=SOILHP(4,1)/5.0D0
        ENDIF
      ENDIF
C
C     .. REINITIALIZE AND SAVE EXTERNAL VALUES
      BRKH2O=BRKH2O+BRKWAT
      DRSEEP=CUMDR(NTIM)
      CMPS=CMPS+CUPRO
      CDNCI=CDNCI+UGSEEP+BFSEEP+CUPRO
      ROI=ROI+CUMRO(NTIM)
      FMP=CUMMF(NTIM)
      CII=CI(NTIM)+CDNCI+FMP
      ZRFDD=RFDD
C
C     .. CHECK FOR FULL PROFILE AND SET HEADS 12/3/03
      IF(H2OTAB(2).EQ.1) THEN
        DO 405 I=2,NN
          H(I)=TLT(I)
  405   CONTINUE
      ENDIF
C====================================================
      IF((IMAGIC.LE.-1.AND.IMAGIC.GE.-2).OR.IMAGIC.EQ.-10) then
         WRITE(78,1000) Jday,(SCUPCH(IP),IP=1,15)
      ENDIF
C
      RETURN
 1000 FORMAT('MAC',I3,15E13.6)
 1100 FORMAT(I5,11E12.4)
 1101 FORMAT(3I5,21E12.4)
 1150 FORMAT('ORIGINAL WATERTABLE DEPTH (CM) ',F6.2)
 1200 FORMAT(////80('*'),/A15,I4,I8,A20,I3,A16,A30//)
 1300 FORMAT(4X,'I',10X,'TR',10X,'CI',7X,'CUMRO',9X,'CRO',6X,'CUMCLR',7
     +    X,'CUMDR',6X,'DRCHEM',7X,'CUMMF',6X,'CUMCLM',5X,'CMACSEP',5X,
     +    'WMACSEP')
 1301 FORMAT('DAY',2X,'YEAR',5X,'I',10X,'TR',10X,'CI',7X,'CUMRO',
     +      7X,'CUMDR',7X,'CUMMF',5X,'WMACSEP',
     +      9X,'CRO',6X,'CUMCLR',6X,'DRCHEM',6X,'CUMCLM',5X,'CMACSEP',
     +      9X,'CRO',6X,'CUMCLR',6X,'DRCHEM',6X,'CUMCLM',5X,'CMACSEP',
     +      9X,'CRO',6X,'CUMCLR',6X,'DRCHEM',6X,'CUMCLM',5X,'CMACSEP'/
     +      90X,20('-'),3x,A11,3x,20('-'),
     +      2X,20('-'),3x,A11,3x,20('-'),
     +      3X,20('-'),3x,A11,3x,20('-'))
 1400 FORMAT(4X,'I',9X,'VWC',7X,'CMESO',7X,'CMICR',8X,'CONC',8X,'FLOW',7
     +    X,'DFLOW',7X,'CFLOW',6X,'CDFLOW',8X,'DBET',7X,'CDBET',7X,
     +    'CMASW')
 1500 FORMAT(I5,11E12.4)
 1505 FORMAT('WT',I3,11E12.4)
 1510 FORMAT('DR',I3,11E12.4)
      END
C
      SUBROUTINE INFIL(I,CONC,CRAIN,X2CONC,TEMPR,TEMP,CW,CSHD,CSHWS,AEF,
     +    IBRK,BRKWAT,BRKMAS,IREBOT,UGSEEP,BOTFLX,SUBDR,ITBL,SOILHP,
     +    CUMRO,CUMDR,DRCHEM,BFSEEP,CDNHT,YESMAC,NN,TLT,HORTHK,CUMCLR,
     +    THGCUR,DRSPAC,DRRAD,H2OTAB,NHOR,cnn,NTIM,DRHT,RINDR,CLAT,ID,
     +    FLXMAX,FDEP,IDP,CMACSEP,WMACSEP,COPLNT,CORES,RESCOV,CUMPWASH,
     +    IDRAIN,ALHMAC,XPRESF,CUMMF,CUMCLM,pori,porav,Hmin)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C======================================================================
C
C       PURPOSE:
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALHMAC    I/O KD FOR LINEAR DESORPTION OF CURRENT PEST[CM3 H2O/G SOIL]
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BFSEEP     I  FLUX OUT BOTTOM DUE TO BOTTOM BOUNDARY CONDITION [CM]
C       BOTFLX     I  RATE OF FLOW OF BOTTOM BOUNDARY CONDITION [CM/HR]
C       BRKMAS     I  FLUX OF CHEM AT BREAK THROUGH NODE [UG/CM^2]
C       BRKWAT     I  FLUX OF WATER AT BREAK THROUGH NODE [CM]
C       CDNCHM     I  CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE [UG]
C       CDNCI I/O WATER SEEPAGE OUT BOTTOM OF PROFILE [CM]
C       CDNHT  I  HEAT LOST OUT BOTTOM OF PROFILE
C       CHJ        I  SAT. HYDRAULIC COND. OF EACH HORIZON [CM/HR]
C       CI        I/O TIME SERIES ACCUM. WATER INFILTRATION [CM]
C       CII        L  INFILTRATION AMT. AT CURRENT TIME STEP [CM]
C       CII1   L  INFILTRATION AMT. AT PREVIOUS TIME STEP [CM]
C       CLAT   I  LATERAL HYDROLIC CONDUCTIVITY [CM/HR]
C       CMESO  I  CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR  I  CHEMICAL CONC. IN MICROPORES [MG/L]
C       COI        L  INFIL. AMT. VARIABLE FOR OUTPUT
C       CONC   I  CHEM. CONC. IN SOIL WATER OF EACH SOIL NODE
C                 SAME AS CC [MG/L]
C       CORR   L  AMT. OF INFILTRATION CORRECTION FOR OVERSHOOTING
C                 THE TOTAL RAINFALL AMOUNT [CM]
C       CRAIN  I  CHEMICAL CONC. IN RAIN WATER [MG/L]
C       CRO        I  CHEMICAL IN RUNOFF [UG/CM^2]
C       CSHD   I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CSHWS  I  EFFECTIVE VOL HEAT CAPACITIES AT THETA-S [J/MM^3/C]
C       CUMCLR     I  CUM CHEMICAL LOSS IN RUNOFF [UG/CM^2]
C       CUMDR  I  CUM TILE DRAIN WATER FLOW [CM]
C       CUMRO  I  CUMMULATIVE WATER RUNOFF [CM]
C       CW         I  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DEG        I  DEGREE OF CHEMICAL MIXING WITH RAINWATER
C       DELQ   L  AMOUNT OF WATER NEEDED TO SATURATE [CM]
C       DHB        I  DEPTH OF HORIZON BOUNDARIES [CM]
C       DRCHEM     I  CHEM. LOSS IN TILE DRAIN [UG/CM^2]
C       DRDEP  I  DEPTH TO TILE DRAIN [CM]
C       DRHT   I  CUM HEAT LOSS OUT TILE DRAIN
C       DRRAD  I  RADIUS OF DRAINS [CM]
C       DRSPAC     I  DISTANCE BETWEEN DRAINS [CM]
C       DSL        I  THICKNESS OF INFILTRATION LAYERS [CM]
C       DTIM   L  TIME STEP [HR]
C       DTMIN  L  MINIMUM ALLOWABLE TIME INCREMENT IN DARCY
C                 (PREVENTS EXCESSIVE LOOPING) [HR]
C       DWF        L  DEPTH OF WETTING FRONT [CM]
C       DWFJJ  L  INCRE. DEPTH OF WETTING FRONT [CM]
C       H2OTAB    I/O ARRAY CONTAINING NODE # AND DEPTH OF WATER TABLE
C       HORTHK     I  DEPTH OF SOIL HORIZONS [CM]
C       I     I/O INDEX VARIABLE
C       IBRK   I  LAYER INTERFACE BELOW BREAK THROUGH NODE
C       IC         L  INDEX VARIABLE
C       ID        I/O INDEX FOR DEPTH OF WETTING FRONT
C       INFLPD     I  FLAG FOR PONDED INFILTRATION
C       IREBOT     I  BOTTOM B.C. INDICATOR: 1 (CONSTANT HEAD) OR 2 (UNIT FLUX
C       ISAT   L  INDICATES WHETHER PROFILE IS SATURATED 0=NO 1=YES
C       ITBL   I  INDICATES PRESENCE OF WATER TABLE 0=NO 1=YES
C       IDRAIN     I  INDICATES USE OF TILE DRAINAGE 0=NO 1=YES
C       ITIME1     I  TIME FOR SCENERIO 1 OUTPUT [MIN]
C       IUGFLW     I  TRIGGERS UNIT GRAD FLOW BELOW WETTING FRONT
C       J      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       MAXBP  P  MAXIMUM NUMBER OF BREAK POINTS IN A RAINSTORM
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXPEST     P  MAXIMUM NUMBER OF PESTICIDES
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NH         L  HORIZON NUMBER OF CURRENT INFIL. LAYER
C       NHOR   I  NUMBER OF SOIL HORIZONS
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NSLT   I  PROFILE DEPTH [CM]
C       NTIM  I/O FINAL NUMBER OF TIME STEPS TAKEN
C       RFD       I/O CURRENT RAINFALL DEPTH [CM]
C       RFDD   I  TOTAL RAINFALL DEPTH [CM]
C       RO        I/O RUNOFF DURING A TIME INTERVAL [CM]
C       RR        I/O RAINFALL RATE [CM/HR]
C       RRD        L  AMT OF RAIN IN THIS TIME STEP [CM]
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       SUBDR  I  FLUX OUT TILE DRAIN [CM/HR]
C       SWF        I  AVE WETTING-FRONT SUCTION [CM]
C       TEMP   I  TEMPERATURE OF LAYER (C)
C       TEMPR  I  TEMPERATURE OF RAIN (C)
C       TERM2  L  VARIABLE USED IN INFIL. CALC.
C       THSMS  I  SATURATED WATER CONTENT OF MESOPORES [0..1]
C       TLT        I  DEPTH TO BOTTOM OF NUMERICAL LAYERS [CM]
C       TR        I/O CUMMULATIVE TIME OF RAINFALL [HR]
C       TRI        L  TIME AT CURRENT TIME STEP [HR]
C       TRI1   L  TIME AT PREVIOUS TIME STEP [HR]
C       UGSEEP     I  SEEPAGE OUT BOTTOM OF PROFILE DO TO UG FLOW
C       V      L  SCALAR VALUE TO BE STORED
C       VFIN   L  FINAL INFIL. RATE IF FRONT REACHES BOTTOM OF PROFILE
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C       X2CONC     I  PEST. CONC. INVOLVED IN KNETIC PROCESSES [UG/G SOIL]
C       YESMAC     I  INDICATS PRESENCE OF MACROPORES =1 YES, =0 NOT
C
C       COMMENTS:
C
C       MASS STORAGE FILES:
C
C       EXTERNAL REFERENCES:
C                 CLOSER
C                 FULFLO
C                 IT2H
C                 MPFLOW
C                 ONETWO
C                 RR2
C                 SATFLO
C                 SGATE
C                 TILEFLO
C                 UGFLOW
C                 UNSATFLO
C                 VGATE
C
C       CALLED FROM:  EVNTRO
C
C       PROGRAMMER:  DR. L. AHUJA AND K.E. JOHNSEN
C
C       VERSION:   2.15
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C=======================================================================
C
      PARAMETER(MAXBP=50,MXNODT=3001,MAXHOR=12,MXCHEM=15,MXPEST=3,
     +    MXNOD=300)
      PARAMETER(MXTSTP=5000)
      PARAMETER(VRCF=2.0D0)
      PARAMETER(DTMIN=1.0D-5)
C
C ----------------------------------------------------------------------
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
      COMMON /IPINF/ CRUSTK,OCRUST,ICRUST,INFLPD,NHZ,NSLT,POND,RR,
     +    DHB(MAXHOR),NSL(MAXHOR),WI(MXnod),DSL(MXNODT),VWC(MXNODT),
     +    IUGFLW
      DOUBLE PRECISION MICP
C
      COMMON /OPINF/ RO,SWF(MXnod),TR(MXTSTP),CI(MXTSTP),CRFD(MAXBP),
     +    CRFT(MAXBP),RFI(MAXBP),RFDD,RFD
      COMMON /OPCHEM/ THSMS(MXNOD,MXCHEM),CUPRO,CUPCHM(MXCHEM),CDNCI,
     +    CDNCHM(MXCHEM),CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),
     +    CRO(MXTSTP,MXCHEM)
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
      INTEGER YESMAC
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
      DIMENSION CONC(MXNODT,MXCHEM),X2CONC(MXNODT,MXPEST),Cnn(Mxnod),
     +    CSHD(MAXHOR),TEMP(NSLT+1),SOILHP(13,MAXHOR),CRAIN(MXCHEM),
     +    BRKMAS(MXCHEM),DRCHEM(MXTSTP,MXCHEM),CUMDR(MXTSTP),H2OTAB(2),
     +    CUMRO(MXTSTP),TLT(MXNOD),HORTHK(MAXHOR),CSHWS(MAXHOR),
     +    CUMCLR(MXTSTP,MXCHEM),CLAT(MAXHOR),ALHMAC(MXNOD,MXCHEM),
     +    FLXMAX(MAXHOR),FDEP(MAXHOR),UDRN(MXNOD),XPRESCHEM(MXCHEM),
     +    CMACSEP(MXTSTP,MXCHEM),WMACSEP(MXTSTP),COPLNT(MXPEST),
     +    CORES(MXPEST),CUMPWASH(MXCHEM),CHEMWASH(MXCHEM),CUMMF(MXTSTP),
     +    CUMCLM(MXTSTP,MXCHEM),pori(mxnod),porav(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
      common /Gleams_hydsol/gleams_clay,gleams_silt,gleams_por,   !chd  GLEAMS
     +        gleams_om1,gleams_sand,gleams_BulkDn,gleams_Dacre, 
     +        gleams_CHS,gleams_ei,gleams_exrain,thirtyRR,  
     +        IBYEAR,IEYEAR
C
      CORR=0.0D0
      VFIN=0.0D0
      ISAT=0
C
      DO 130 I=1,MXTSTP
        RO=0.0D0
        XPRESWAT=0.0D0
        DO 10 IC=1,MXCHEM
          CHEMWASH(IC)=0.0D0
          XPRESCHEM(IC)=0.0D0
   10   CONTINUE
C
C       VARIABLE I WILL FOLLOW TIME STEPS,
C       VARIABLE ID WILL FOLLOW DEPTH OF WETTING FRONT (POINTS TO
C       FIRST UNSAT LAYER BELOW SAT LAYER; ID=NSLT+1 MEANS FULLY SAT --
C       THAT'S WHEN ISAT IS TOGGLED ==> 1)
C
C       ..FIND DEPTH OF WETTING FRONT, based on numerical layers
        ID=1
        DO 20 J=ID,NSLT
C          NH=IT2H(J)
C NEED TO CHECK PORAV, NUMERICAL LAYER OR HORIZON, LIWANG MA, 3-28-2009
c          NH=NDXT2N(J)
c          JJ=NDXT2N(J)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
c          IF (ABS(VWC(J) - SOILHP(6, NH) * AEF) .LT. 1.0D-12) THEN
c gnf-ma            VWC(J) = SOILHP(6, NH) * AEF
          IF (ABS(VWC(J) - porav(J)) .LT. 1.0D-12) THEN
		          vwc(j) = porav(J)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            ID=ID+1
          ELSE
            IF(ID.LT.NSLT) THEN
              DWF=DSL(ID)-0.5D0
            ELSE
              DWF=NSLT-0.5D0
            ENDIF
            GOTO 30
          ENDIF
   20   CONTINUE
        IF(ID.EQ.NSLT+1) ISAT=1
C======================================================================
   30   IF(ISAT.EQ.0) THEN
C
C         ..FIND INFIL INTO UNSATURATED PROFILE
c Liwang Ma          JJ=IT2H(ID)
          JJ=NDXT2N(ID)
          DWFJJ=DWF
c          IF(JJ.NE.1) DWFJJ=DWF-DHB(JJ-1)
          IF(JJ.NE.1) DWFJJ=DWF-tlt(JJ-1)
          TERM2=0.0D0
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
          DO 40 J=1,JJ-1
            IF(J.EQ.1) THEN
              TERM2=TERM2+tlt(J)*Cnn(JJ)/Cnn(J)
            ELSE
              TERM2=TERM2+(tlt(J)-tlt(J-1))*Cnn(JJ)/Cnn(J)
            ENDIF
   40     CONTINUE
          V=Cnn(JJ)*(SWF(JJ)+DWF)/(TERM2+DWFJJ)
          V=V/VRCF
          IF(INFLPD.EQ.1) RR=V
          RR=MAX(RR,1.0D-2)
          IF(V.GE.RR) V=RR
          VFIN=V
          IF(IREBOT.EQ.3) VFIN=MIN(VFIN,BOTFLX)
          DELQ=porav(id)-VWC(ID)
          DELQ=MAX(0.D0,DELQ)
          IF(ID.EQ.NSLT) VWC(ID+1)=VWC(ID)
          IF(I.LE.1) THEN
            TR(I)=DELQ/V
C           ..SET UP A MINIMUM TIME STEP
            IF(TR(I).LT.DTMIN) THEN
              V=DELQ/DTMIN
              IF(V.GE.RR) V=RR
              TR(I)=DELQ/V
            ENDIF
            CI(I)=DELQ
          ELSE
            TR(I)=TR(I-1)+DELQ/V
C           ..SET UP A MINIMUM TIME STEP
            IF(TR(I)-TR(I-1).LT.DTMIN) THEN
              V=DELQ/DTMIN
              IF(V.GE.RR) V=RR
              TR(I)=TR(I-1)+DELQ/V
            ENDIF
            CI(I)=CI(I-1)+DELQ
          ENDIF
          RFDI=RFD
          RFD=RFD+RR*DELQ/V
          IF(RFD.GT.RFDD) THEN
            CORR=0.0D0
            CORR=(RFD-RFDD)*V/RR
            CI(I)=CI(I)-CORR
            TR(I)=TR(I)-CORR/V
            RFD=RFDD
          ENDIF
          TRI=TR(I)
          CII=CI(I)
          IF(I.GT.1) THEN
            TRI1=TR(I-1)
            CII1=CI(I-1)
          ELSE
            TRI1=0.0D0
            CII1=0.0D0
          ENDIF
          DTIM=TRI-TRI1
          RRD=RR*DTIM
C
C         ..FIND HOW MUCH PESTICIDE WASHED OFF AND ADDED INTO THE SYSTEM
          DO 50 IP=1,MXPEST
            CALL PEWASH(RRD*10.0D0,COPLNT(IP),CORES(IP),
     +          CHEMWASH(12+IP),RESCOV,IP)
C
C         .. CHEMWASH COMES OUT OF WASHOFF IN PPM
   50     CONTINUE
          CALL MIXRUNOFF (AEF,ALH,BDH,BOTFLX,CHEMWASH,CI,CMESO,
     +      CMICR,CRAIN,CRO,CUMCLR,CUMDR,CUMRO,DEG,DR,DRCHEM,
     +      DTIM,FDEP,FLXMAX,I,ISAT,ID,INFLPD,MICP,NHZ,RFD,RFDD,
     +      RINDR,RO,RR,RRD,SOILHP,SUBDR,THSMCJ,THSMS,TR,YESMAC,VWC,
     +      porav,itbl,h2otab(2),cii,cii1,TRI,TRI1)
C
C         ..DETERMINE TRANSPORT WITH INFILTRATION IN UNSATURATED PROFILE
          CALL UNSATFLO(I,ID,CRAIN,CORR,AEF,IBRK,BRKWAT,BRKMAS,SOILHP,
     +        CII,TRI,CII1,TRI1,TEMP,CSHD,CW,CDNHT,TEMPR,CSHWS,X2CONC,
     +        ISAT,CHEMWASH,DR,DTIM,porav)
C
C         ..RESET DEPTH OF WETTING FRONT, BUT NOT ISAT
          ID=2
          DO 60 J=ID,NSLT
            NH=IT2H(J)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     gnf
c     jak
            IF (ABS(VWC(J) - PORAV(J)) .LT. 1.0D-12) THEN
              VWC(J) = PORAV(J)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
              ID=ID+1
            ELSE
              GOTO 70
            ENDIF
   60     CONTINUE
        ENDIF
C======================================================================
c       H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
c   70      IF(YESMAC.GE.1.AND.ISAT.EQ.0.and.h2ot2.gt.2.0d0) THEN
   70      IF(YESMAC.GE.1.AND.ISAT.EQ.0) THEN
          CALL MPFLOW(I,ID,CORR,CONC,AEF,IBRK,BRKWAT,BRKMAS,ITBL,ISAT,
     +        H2OTAB(2),SOILHP,TEMP,CSHD,CW,CDNHT,TEMPR,CMACSEP,WMACSEP,
     +        ALHMAC,XPRESWAT,XPRESCHEM,IDRAIN,porav,NN)
C
C         ..RESET DEPTH OF WETTING FRONT, BUT NOT ISAT
          ID=2
          DO 80 J=ID,NSLT
            NH=IT2H(J)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c gnf-ma            IF (ABS(VWC(J) - SOILHP(6, NH) * AEF) .LT. 1.0D-12) THEN
c gnf-ma             VWC(J) = SOILHP(6, NH) * AEF
            IF (ABS(VWC(J) - PORAV(J)) .LT. 1.0D-12) THEN
              VWC(J) = PORAV(J)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
              ID=ID+1
            ELSE
              GOTO 90
            ENDIF
   80     CONTINUE
        ENDIF
C======================================================================
   90   IF(ITBL.EQ.1.AND.INT(H2OTAB(2)).LE.NSLT) THEN
C
C         ... CALCULATE FLUX DUE TO SUBSURFACE DRAINAGE
c          SUBDR=0.0D0
c          IF(IDRAIN.EQ.1) CALL TILEFLO(TLT,HORTHK,THGCUR,DRSPAC,DRRAD,
c     +        H2OTAB,SUBDR,NN,NHOR,CLAT,IDP,UDRN)
C
C         ..DO TILE DRAINAGE AND SEEPAGE FROM SATURATED PROFILE
C
          IF(INT(H2OTAB(2)).GE.ID) THEN
C           ..DETERMINE TRANSPORT IN SATURATED PROFILE BELOW WETTING FRONT
C    ==============================================================
            CALL SATFLO(I,NSLT,DTIM,THGCUR,SUBDR,BOTFLX,CUMDR,SOILHP,
     +          VWC,CMESO,CSHD,CW,TEMP,DRCHEM,CDNCHM,CDNHT,CRO,DRHT,
     +          TEMPR,BFSEEP,H2OTAB(2),AEF,XPRESWAT,XPRESCHEM,CMICR,ALH,
     +          BDH,MICP,DR)
          ELSE
C           ..DETERMINE TRANSPORT IN FULLY SATURATED PROFILE
C           ================================================
            IF (ISAT.NE.0) THEN
C             ..FIND HOW MUCH PESTICIDE WASHED OFF AND ADDED INTO THE SYSTEM
              DO 100 IP=1,MXPEST
                CALL PEWASH(RRD*10.0D0,COPLNT(IP),CORES(IP),
     +            CHEMWASH(12+IP),RESCOV,IP)
  100         CONTINUE
              CALL MIXRUNOFF (AEF,ALH,BDH,BOTFLX,CHEMWASH,CI,CMESO,
     +          CMICR,CRAIN,CRO,CUMCLR,CUMDR,CUMRO,DEG,DR,DRCHEM,
     +          DTIM,FDEP,FLXMAX,I,ISAT,ID,INFLPD,MICP,NHZ,RFD,RFDD,
     +          RINDR,RO,RR,RRD,SOILHP,SUBDR,THSMCJ,THSMS,TR,YESMAC,VWC,
     +          porav,itbl,h2otab(2),cii,cii1,TRI,TRI1)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            ENDIF
C
            CALL FULFLO(NSLT,VWC,SOILHP,CI,TR,RR,RFD,RFDD,CRAIN,CRO,
     +          THSMS,CMESO,CMICR,DEG,ALH,BDH,MICP,CUMRO,CUMCLR,ISAT,
     +          SUBDR,BOTFLX,THGCUR,CUMDR,BFSEEP,DRCHEM,TEMP,CSHD,CW,
     +          CDNHT,CDNCHM,HORTHK,H2OTAB(2),NHOR,INFLPD,I,ID,AEF,
     +          TEMPR,RINDR,DRHT,YESMAC,FLXMAX,FDEP,CHEMWASH,XPRESWAT,
     +          XPRESCHEM,DR,DTIM,CUMMF,CUMCLM,porav)
          ENDIF
        ELSEIF(ID.LT.NSLT.AND.IREBOT.EQ.2) THEN
C         ..DO UNIT GRADIENT FLOW BELOW WETTING FRONT
C         ===========================================
          IF(IUGFLW.EQ.1) CALL UGFLOW(I,ID,NSLT,VWC,TR,ALH,BDH,CONC,
     +        UGSEEP,TEMP,CSHD,CW,CDNHT,MICP,pori,porav,Hmin)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
        ELSEIF(ISAT.EQ.1.AND.ITBL.EQ.0) THEN
C         ..WETTING FRONT HIT BOTTOM OF PROFILE, BUT NO WATER TABLE
C         =========================================================
c          V=VFIN
          IF(INFLPD.NE.1) RR=RR2(RFD)
          RR=MAX(RR,1.0D-2)
          V=RR
          IF(VFIN.GT.1.D-12) THEN
C
C           ..SET INFIL STEP EQUAL TO LAST INFIL STEP
            TR(I)=TR(I-1)+(CII-CII1)/V
            CI(I)=CI(I-1)
            CII=CI(I)+(CII-CII1)
            CII1=CI(I-1)
            TRI=TR(I)
            TRI1=TR(I-1)
          ELSEIF(I.EQ.1) THEN
C           .. SPECIAL CASE WHEN THE PROFILE COMES IN FULLY SATURATED,
C           SET ALL THE WATER OUT AS RUNOFF
            TR(I)=1.D0
            TRI=TR(I)
            TRI1=0.0D0
            RR=RFDD-RFD
            CI(I)=0.0D0
            CII=CI(I)
            CII1=CII
          ELSE
C           ..DUE TO 0 BOTTOM FLUX, SET ALL THE WATER TO GO INTO RUNOFF
            TR(I)=1.D0+TR(I-1)
            TRI=TR(I)
            TRI1=TR(I-1)
            RR=RFDD-RFD
            CI(I)=CI(I-1)
            CII=CI(I)
            CII1=CI(I-1)
          ENDIF
          DTIM=TRI-TRI1
          RRD=RR*DTIM
C         ..MAKE CORRECTION FOR OVERSHOOT IN WATER APPLICATION
          IF(RFD+RRD-RFDD.GT.1.0D-12) THEN
            CORR=(RFDD-RFD)*V/RR
            CII=CII1+CORR
            TRI=TRI1+CORR/V
            TR(I)=TRI
            RFD=RFDD
            CORR=RRD*V/RR-CORR
          ELSE
            RFDI=RFD
            RFD=RFD+RRD
          ENDIF
C         ..ACCUMULATE WATER DUE TO SEEPAGE
          CDNCI=CDNCI+(CII-CII1)
C         ..FIND HOW MUCH PESTICIDE WASHED OFF AND ADDED INTO THE SYSTEM
          DO 110 IP=1,MXPEST
            CALL PEWASH(RRD*10.0D0,COPLNT(IP),CORES(IP),
     +          CHEMWASH(12+IP),RESCOV,IP)
  110     CONTINUE

          CALL MIXRUNOFF (AEF,ALH,BDH,BOTFLX,CHEMWASH,CI,CMESO,
     +      CMICR,CRAIN,CRO,CUMCLR,CUMDR,CUMRO,DEG,DR,DRCHEM,
     +      DTIM,FDEP,FLXMAX,I,ISAT,ID,INFLPD,MICP,NHZ,RFD,RFDD,
     +      RINDR,RO,RR,RRD,SOILHP,SUBDR,THSMCJ,THSMS,TR,YESMAC,VWC,
     +      porav,itbl,h2otab(2),cii,cii1,TRI,TRI1)
C
          CALL UNSATFLO(I,ID,CRAIN,CORR,AEF,IBRK,BRKWAT,BRKMAS,SOILHP,
     +        CII,TRI,CII1,TRI1,TEMP,CSHD,CW,CDNHT,TEMPR,CSHWS,X2CONC,
     +        ISAT,CHEMWASH,DR,DTIM,porav)
C
C         .ADDED 3/24/1999 TO ALLOW MP FLOW UNDER THESE CONDITIONS
c        H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
c          IF(YESMAC.GE.1.and.h2ot2.gt.2.0d0) 
          IF(YESMAC.GE.1) 
     +       CALL MPFLOW(I,ID,CORR,CONC,AEF,IBRK,BRKWAT,
     +        BRKMAS,ITBL,ISAT,H2OTAB(2),SOILHP,TEMP,CSHD,CW,CDNHT,
     +        TEMPR,CMACSEP,WMACSEP,ALHMAC,XPRESWAT,XPRESCHEM,
     +        IDRAIN,porav,NN)
        ENDIF
        DO 120 IP=1,MXPEST
          CUMPWASH(12+IP)=CUMPWASH(12+IP)+CHEMWASH(12+IP)*RRD
  120   CONTINUE
        if (ro.gt.0.0d0) then
        ! chd: find the highest rain intensity (gleams_exrain) and the EI (gleams_ei), moved here by Liwang Ma
        IF (I.eq.1) THEN
            EXRAINTMP = CUMRO(I)/TR(I)
        ELSE
            EXRAINTMP = (CUMRO(I)-CUMRO(I-1))/(TR(I)-TR(I-1))
        ENDIF
c
        EXRAINTMP = EXRAINTMP / 2.54d0    ! cm/hr --> in/hr
        IF (RR/2.54D0.GT.3.0d0) THEN  ! > 3 in/hr
          EITMP = 1074d0
        ELSE
          EITMP = 916d0+331d0*log10(RR/2.54d0)          ! Wischmeir & Smith 1978 EITMP in foot-ton/acre in, RR is rainfall intensity (cm/hr)
c          EITMP = 916d0+331d0*log10(EXRAINTMP)          ! Wischmeir & Smith 1978 EITMP in foot-ton/acre in by DeMars
        ENDIF
c    this is different from what used in GLEAMS 3.0, Liwang 1-30-2015. 
c     the ei values seem to high. changed to original one
c     DEI=7.87*(REFF-xmelt)**1.51*fac_e whre REFF is effective rainfall+irrigation in inches
          gleams_ei = gleams_ei + EITMP * RRD / 2.54     !Liwang Ma
c        IF (I.EQ.1) THEN
c          gleams_ei = gleams_ei + EITMP * (CUMRO(I) / 2.54)
c        ELSE        
c          gleams_ei = gleams_ei + EITMP * ((CUMRO(I)-CUMRO(I-1)) / 2.54)
c        ENDIF
c        
        IF(EXRAINTMP.GT.gleams_exrain) gleams_exrain = EXRAINTMP
        endif
c
        IF(RFD.GE.RFDD) GOTO 140
        IF(INFLPD.NE.1) RR=RR2(RFD)
C
  130 CONTINUE
C
C     ..GO BACK TO EVNTRO
  140 NTIM=MIN(I,MXTSTP)
      RETURN
      END
      SUBROUTINE MIXRUNOFF (AEF,ALH,BDH,BOTFLX,CHEMWASH,CI,CMESO,CMICR,
     + CRAIN,CRO,CUMCLR,CUMDR,CUMRO,DEG,DR,DRCHEM,DTIM,FDEP,FLXMAX,I,
     + ISAT,ID,INFLPD,MICP,NHZ,RFD,RFDD,RINDR,RO,RR,RRD,SOILHP,SUBDR,
     + THSMCJ,THSMS,TR,YESMAC,VWC,porav,itbl,h2otab2,cii,cii1,TRI,TRI1)

C    -------------------------------------------------------------------------
C    OBJECT MODELING SYSTEM,  ARS, USGS, ITC, FSU, 1999-2002.
C    FORT COLLINS USA, DENVER USA, JENA GERMANY.
C
C    THIS FILE WAS GENERATED FOR THE OBJECT MODELING SYSTEM, AN OPEN MODELING
C    FRAMEWORK FOR ENVIRONMENTAL MODEL CONSTRUCTION AND APPLICATION. THE SOFTWARE
C    IS A RESULT OF AN ARS, USGS, ITC INTERAGENCY RESEARCH PROJECT.
C
C    THE CODE WAS GENERATED "AS IS".  SOME MODIFICATION MAY BE REQUIRED
C    -------------------------------------------------------------------------
      PARAMETER(MAXHOR = 12)
      PARAMETER(MXCHEM = 15)
      PARAMETER(MXNOD = 300)
      PARAMETER(MXNODT=3001)
      PARAMETER(MXTSTP=5000)

      INTEGER I, I1, IC, ID, INFLPD, J, JH, KJ, YESMAC,IT2H,itbl
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)

      DOUBLE PRECISION AEF, ALH(MXnod,MXCHEM), BDH(MAXHOR), BOTFLX,
     + CHEMWASH(MXCHEM), CI(MXTSTP), VWC(MXNODT),h2otab2,cii,cii1,
     + CMESO(MXNODT,MXCHEM), CMICR(MXNODT,MXCHEM), CRAIN(MXCHEM),
     + CRO(MXTSTP,MXCHEM), CUMCLR(MXTSTP,MXCHEM), CUMDR(MXTSTP),
     + CUMRO(MXTSTP), DEG(MAXHOR), DR, DRCHEM(MXTSTP,MXCHEM),
     + DTIM, FLXMXA, MICP(MAXHOR), OUTFLOW, RFD, RFDD, RINDR, RO, RR,
     + RRD, SATDTIM, SOILHP(13,MAXHOR), SUBDR, THSMCJ, RR2,tri,tri1,
     + THSMS(MXNOD,MXCHEM), TR(MXTSTP),FLXMAX(MAXHOR),FDEP(MAXHOR),
     + porav(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
      PARAMETER(SATDTIM=5.0D0/60.0D0)

       IF(ITBL.EQ.0.or.isat.ne.1) THEN
c      IF (ISAT.NE.1) THEN
C       .. UNSATURATED/PARTIALLY SATURATED CONDITION
C       ============================================
        IF(I.EQ.1) THEN
          DR=CII
          RRD=RR*TRI
          DTIM=TRI
        ELSE
          DR=CII-CII1
          RRD=RR*(TRI-TRI1)
          DTIM=TRI-TRI1
        ENDIF
        RO=RRD-DR
        IF(RO.LE.1.0D-13) RO=0.0D0
c        H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
c        IF(INFLPD.EQ.1.AND.YESMAC.GE.1 .and.h2ot2.gt.2.0d0) THEN
        IF(INFLPD.EQ.1.AND.YESMAC.GE.1) THEN
          FLXMXA=9.0D30
          DO 10 KK=1,NHZ
            FLXMXA=MIN(FLXMAX(KK)*(1.0D0-FDEP(KK)),FLXMXA)
   10     CONTINUE
          RO=FLXMXA*DTIM
          IF(RO.GT.(RFDD-RFD)) RO=RFDD-RFD
          RO=MAX(RO,0.0D0)
          RFD=RFD+RO
        ENDIF
      ELSE IF(H2OTAB2.LT.ID.AND.ISAT.EQ.1) THEN
C       .. FULLY SATURATED CONDITION
C       ============================
        DTIM=SATDTIM
        IF(INFLPD.NE.1) RR=RR2(RFD)
        RR=MAX(RR,1.0D-2)
        IF(I.LE.1) THEN
          CI(I)=0.0D0
          TR(I)=0.0D0
        ELSE
          CI(I)=CI(I-1)
          TR(I)=TR(I-1)
        ENDIF
        DR=RR*DTIM
        IF(DR+RFD.GT.RFDD) THEN
          DTIM=(RFDD-RFD)/RR
          RFD=RFDD
          DR=RR*DTIM
        ELSE
          RFD=RFD+DR
        ENDIF
        RRD=DR
        TR(I)=TR(I)+DTIM
        RO=0.0D0
C       ..FIND AMT TO FLOW OUT OF BOTTOM AND DRAIN FOR THIS TIME STEP
        OUTFLOW=(SUBDR+BOTFLX)*DTIM
        IF(DR.GE.OUTFLOW) THEN
C         ..INFILTRATE AMOUNT OF OUTFLOW, RUN OFF THE REST
          RO=DR-OUTFLOW
          RINDR=RINDR+OUTFLOW
        ENDIF
      ENDIF
C     ..SETUP ACCUMULATORS
C     ====================
      IF(I.LE.1) THEN
        CUMDR(I)=0.0D0
        CUMRO(I)=0.0D0
        DO 22 IC=1,MXCHEM
          CUMCLR(I,IC)=0.0D0
          CRO(I,IC)=CRAIN(IC)+CHEMWASH(IC)
   22   CONTINUE
      ELSE
        CUMDR(I)=CUMDR(I-1)
        CUMRO(I)=CUMRO(I-1)
        DO 23 IC=1,MXCHEM
          CUMCLR(I,IC)=CUMCLR(I-1,IC)
          CRO(I,IC)=CRAIN(IC)+CHEMWASH(IC)
   23   CONTINUE
      ENDIF
C     ..IF THERE IS RUNOFF THEN MIX CHEMICALS
C     =======================================
      IF(RO.GT.0.0D0) THEN
C       ..ACCUMULATE RUNOFF TOTALS
c        H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
c        IF(ISAT.EQ.1.OR.(ISAT.NE.1.AND.YESMAC.EQ.0)
c     +   .or.(h2ot2.le.2.0d0)) CUMRO(I)=CUMRO(I)+RO
        IF(ISAT.EQ.1.OR.(ISAT.NE.1.AND.YESMAC.EQ.0)
     +   ) CUMRO(I)=CUMRO(I)+RO
        ! chd: find the highest rain intensity (gleams_exrain) and the EI (gleams_ei)
cc        IF (I.eq.1) THEN
cc            EXRAINTMP = CUMRO(I)/TR(I)
cc        ELSE
cc            EXRAINTMP = (CUMRO(I)-CUMRO(I-1))/(TR(I)-TR(I-1))
cc        ENDIF
cc        
cc        EXRAINTMP = EXRAINTMP / 2.54d0    ! cm/hr --> in/hr
cc        IF (EXRAINTMP.GT.(6.94D-006)) THEN  ! > 3 in/hr
cc          EITMP = 106.927d0
cc        ELSE
cc          EITMP = 916d0+331d0*log10(RR/2.54d0)          ! Wischmeir & Smith 1978 EITMP in foot-ton/acre in, RR is rainfall intensity (cm/hr)
c          EITMP = 916d0+331d0*log10(EXRAINTMP)          ! Wischmeir & Smith 1978 EITMP in foot-ton/acre in by DeMars
cc        ENDIF
c    this is different from what used in GLEAMS 3.0, Liwang 1-30-2015. 
c     the ei values seem to high. changed to original one
c     DEI=7.87*(REFF-xmelt)**1.51*fac_e whre REFF is effective rainfall+irrigation in inches
cc          gleams_ei = gleams_ei + EITMP * RRD / 2.54     !Liwang Ma
c        IF (I.EQ.1) THEN
c          gleams_ei = gleams_ei + EITMP * (CUMRO(I) / 2.54)
c        ELSE        
c          gleams_ei = gleams_ei + EITMP * ((CUMRO(I)-CUMRO(I-1)) / 2.54)
c        ENDIF
c        
cc        IF(EXRAINTMP.GT.gleams_exrain) gleams_exrain = EXRAINTMP
        DO 50 IC=1,MXCHEM
C         ..CALCULATE CHANGES IN CMESO & CMICR IN TOP 2 CMS DUE TO
C         TRANSFER TO RUNOFF, AND CONC. IN RUNOFF
          KJ=MIN(ID-1,2)
          IF(ISAT.EQ.1) THEN
            DO 40 J=1,KJ
              JH=IT2H(J)
              JK=NDXT2N(J)
              THJ=(VWC(J)+ALH(JK,IC)*BDH(JH))
              CMESO(J,IC)=CMESO(J,IC)*THJ/(THJ+DEG(J)*RRD)
              CRO(I,IC)=CRO(I,IC)+DEG(J)*CMESO(J,IC)
              IF(MICP(JH).GT.0.0D0) CMICR(J,IC)=CMESO(J,IC)
   40       CONTINUE
          ELSE IF(INFLPD.NE.1) THEN
            DO 45 J=1,KJ
              JH=IT2H(J)
              JK=NDXT2N(J)
              CMESO(J,IC)=CMESO(J,IC)*THSMS(JK,IC)/(THSMS(JK,IC)+
     +            DEG(J)*RRD)
              CRO(I,IC)=CRO(I,IC)+DEG(J)*CMESO(J,IC)
              IF (MICP(JH).GT.0.0D0) THEN
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
c                THSMCJ=(SOILHP(6,JH)*AEF+ALH(JH,IC)*BDH(JH))*MICP(JH)
                THSMCJ=(porav(j)+ALH(JK,IC)*BDH(JH))*MICP(JH)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
                CMICR(J,IC)=CMICR(J,IC)*THSMCJ/(THSMCJ+DEG(J)*RRD)
                CRO(I,IC)=CRO(I,IC)+DEG(J)*CMICR(J,IC)
              ENDIF
   45       CONTINUE
          ENDIF
C         ..ACCUMULATE CHEMICAL IN RUNOFF TOTALS
c        H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
          IF(ISAT.EQ.1.OR.(ISAT.NE.1.AND.YESMAC.EQ.0))
c     +   .or.(h2ot2.le.2.0d0))
     +      CUMCLR(I,IC)=CUMCLR(I,IC)+RO*CRO(I,IC)
   50   CONTINUE
      ENDIF
      RETURN
      END
C
      SUBROUTINE UNSATFLO(I,ID,CRAIN,CORR,AEF,IBRK,BRKWAT,BRKMAS,SOILHP,
     +    CII,TRI,CII1,TRI1,TEMP,CSHD,CW,CDNHT,TEMPR,CSHWS,X2CONC,ISAT,
     +    CHEMWASH,DR,DTIM,porav)
C
C======================================================================
C
C       PURPOSE:  CALCULATE NEW WATER CONTENTS AND CHEMICAL CONCENTRATIONS
C             IN UNSATURATED SOIL PROFILE
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       AL         L  ALUMINUM CONC. [MOLES/LITER]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALHMAC    I/O KD FOR LINEAR DESORPTION OF CURRENT PEST[CM3 H2O/G SOIL]
C       BD         L  BULK DENSITY FOR CURRENT HORIZON [G/CM^3]
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BRKMAS    I/O FLUX OF CHEM AT BREAK THROUGH NODE [UG/CM^2]
C       BRKWAT    I/O FLUX OF WATER AT BREAK THROUGH NODE [CM]
C       CDNCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE [UG]
C       CDNHT I/O HEAT LOST OUT BOTTOM OF PROFILE
C       CII        I  INFILTRATION AMT. AT CURRENT TIME STEP [CM]
C       CII1   I  INFILTRATION AMT. AT PREVIOUS TIME STEP [CM]
C       CMESO I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR I/O CHEMICAL CONC. IN MICROPORES [MG/L]
C       CORR   I  AMT. OF INFILTRATION CORRECTION FOR OVERSHOOTING
C                 THE TOTAL RAINFALL AMOUNT [CM]
C       CRAIN  I  CHEMICAL CONC. IN RAIN WATER [MG/L]
C       CRO       I/O CHEMICAL IN RUNOFF [UG/CM^2]
C       CSHD   I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CSHWS  I  EFFECTIVE VOL HEAT CAPACITIES AT THETA-S [J/MM^3/C]
C       CUMCLR    I/O CUM CHEMICAL LOSS IN RUNOFF [UG/CM^2]
C       CUMRO I/O CUMMULATIVE WATER RUNOFF [CM]
C       TCUR   L  CURRENT TEMPERATURE ENERGY
C       CW         I  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DEF        L  AMOUNT OF WATER NEEDED TO SATURATE [CM]
C       DEG        I  DEGREE OF CHEMICAL MIXING WITH RAINWATER
C       DENT   L  FACTOR IN TEMPERATURE CALC.
C       DR         L  DEPTH OF RAIN IN CURRENT STEP
C       DTIM   L  TIME STEP [HR]
C       FDEP   I  FRACTION OF TOTAL MACROPORES THAT ARE DEADEND [0..1]
C       TFLI   L  TEMPERATURE FLUX MOVING IN
C       TFLO   L  TEMPERATURE FLUX MOVING OUT
C       FLXMAX     I  MAXIMUN WATER FLUX IN RADIAL PORE CONTROLLED
C                 MACROPORE HORIZONS [CM/HR]
C       FLXMXA     L  R/O RATE IN PONDED CONDITIONS W/ MACP. [CM/HR]
C       I      I  INDEX VARIABLE
C       IBRK   I  LAYER INTERFACE BELOW BREAK THROUGH NODE
C       IC         L  INDEX VARIABLE
C       ID         I  INDEX VARIABLE (DEPTH)
C       INFLPD     I  FLAG FOR PONDED INFILTRATION
C       ISAT   I  INDICATES WHETHER PROFILE IS SATURATED 0=NO 1=YES
C       IUGFLW     I  TRIGGERS UNIT GRAD FLOW BELOW WETTING FRONT
C       J      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       K      L  INDEX VARIABLE
C       KJ         L  INDEX VARIABLE
C       KK         L  INDEX VARIABLE
C       KL         L  INDEX VARIABLE
C       MAXBP  P  MAXIMUM NUMBER OF BREAK POINTS IN A RAINSTORM
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MCPOR  I  TOTAL MACROPOROSITY OF HORIZON [CM3/CM3]
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXPEST     P  MAXIMUM NUMBER OF PESTICIDES
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NH         L  HORIZON NUMBER OF CURRENT INFIL. LAYER
C       NHZ        I  NUMBER OF SOIL HORIZONS
C       NPOR   I  TOTAL NUMBER OF MACROPORES PER LAYER
C       NSLT   I  PROFILE DEPTH [CM]
C       RFD       I/O CURRENT RAINFALL DEPTH [CM]
C       RFDD   I  TOTAL RAINFALL DEPTH [CM]
C       RO        I/O RUNOFF DURING A TIME INTERVAL [CM]
C       RR         I  RAINFALL RATE [CM/HR]
C       RRD        L  AMT OF RAIN IN THIS TIME STEP [CM]
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       TEMP  I/O TEMPERATURE OF LAYER (C)
C       TEMPR  I  TEMPERATURE OF RAIN (C)
C       THI        L  WATER CONTENT OF CURRENT HORIZON [0..1]
C       THS        L  SATURATED WATER CONTENT OF CURRENT HORIZON
C                 INCL. KD FACTOR
C       THSMCJ     L  SATURATED WATER CONTENT OF MICROPORES [0..1]
C       THSMS  I  SATURATED WATER CONTENT OF MESOPORES [0..1]
C       TRI        I  TIME AT CURRENT TIME STEP [HR]
C       TRI1   I  TIME AT PREVIOUS TIME STEP [HR]
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C       WSH        L  SATURATED WATER CONTENT [0..1]
C       X2CONC     I  PEST. CONC. INVOLVED IN KNETIC PROCESSES [UG/G SOIL]
C       YESMAC     I  INDICATS PRESENCE OF MACROPORES =1 YES, =0 NOT
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 IT2H
C                 KNETIC
C
C       CALLED FROM:   INFIL
C
C       PROGRAMMER: DR. L. AHUJA, K.E. JOHNSEN, K.W. ROJAS
C
C       VERSION:   2004
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MAXBP=50,MXNODT=3001,MAXHOR=12,MXCHEM=15,MXPEST=3)
      PARAMETER(MXTSTP=5000,mxnod=300)
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C ----------------------------------------------------------------------
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
C ----------------------------------------------------------------------
      COMMON /IPMACF/ AGSZ(MAXHOR),FDEP(MAXHOR),MCPOR(MAXHOR),PI,
     +    PL(MAXHOR),RP(MAXHOR),SFCT,TWOPI,WP(MAXHOR),NHCMP,YESMAC,
     +    EFFWR,EFFWC,XPRESF
C ----------------------------------------------------------------------
      COMMON /IPINF/ CRUSTK,OCRUST,ICRUST,INFLPD,NHZ,NSLT,POND,RR,
     +    DHB(MAXHOR),NSL(MAXHOR),WI(Mxnod),DSL(MXNODT),VWC(MXNODT),
     +    IUGFLW
C ----------------------------------------------------------------------
      DOUBLE PRECISION MICP,MCPOR,NPOR
      INTEGER YESMAC
      COMMON /OPINF/ RO,SWF(MXnod),TR(MXTSTP),CI(MXTSTP),CRFD(MAXBP),
     +    CRFT(MAXBP),RFI(MAXBP),RFDD,RFD
      COMMON /OPCHEM/ THSMS(MXNOD,MXCHEM),CUPRO,CUPCHM(MXCHEM),CDNCI,
     +    CDNCHM(MXCHEM),CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),
     +    CRO(MXTSTP,MXCHEM)
      COMMON /OPMACF/ CDBET(MXNODT,MXCHEM),CFLOW(MXNODT,MXCHEM),
     +    CDFLOW(MXNODT,MXCHEM),CUMCLM(MXTSTP,MXCHEM),
     +    CUMCLR(MXTSTP,MXCHEM),CUMMF(MXTSTP),CUMRO(MXTSTP),
     +    DBET(MXNODT),DFLOW(MXNODT),FLOW(MXNODT),TDFLOW(MXNODT),
     +    TFLOW(MXNODT)
      COMMON /INTMCF/ FLXMAX(MAXHOR),DB(MAXHOR),NPOR(MAXHOR)
C
      DIMENSION SOILHP(13,MAXHOR),CRAIN(MXCHEM),BRKMAS(MXCHEM),
     +    TEMP(NSLT+1),CSHD(MAXHOR),CSHWS(MAXHOR),
     +    X2CONC(MXNODT,MXPEST),CHEMWASH(MXCHEM),porav(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C     ..SET VARIABLES THAT ARE CONSTANT FOR EACH CHEMICAL
      K=ID
      NH=IT2H(K)
      NK=NDXT2N(K)
	if (nk.eq.0) NK=NDXT2N(K-1)
      BD=BDH(NH)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     gnf
        wsh=porav(k)
c        IF (WSH.LE.0.0D0) WSH=PORAV(K-1)     !TO CORRECT WSH=0 AT THE BOTTOM
c      WSH=SOILHP(6,NH)*AEF
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
      IF(RFD.GE.RFDD) WSH=WSH-CORR
      TCW=CW*1000.0D0
C
C     ..ACCUMULATE BREAKTHROUGH WATER AMOUNTS
      DEF=WSH-VWC(K)
      DEF=MAX(DEF,0.D0)
      IF(ID.EQ.IBRK+1) THEN
        BRKWAT=BRKWAT+DEF
      ENDIF
C
C     ..CYCLE THROUGH CHEMICALS DOING PISTON DISPLACEMENT
      DO 50 IC=1,MXCHEM
        IF(K.EQ.NSLT+1) THEN
          CMESO(K,IC)=0.0D0
          CMICR(K,IC)=0.0D0
          TEMP(K)=0.0D0
        ENDIF
        AL=ALH(NK,IC)
        THS=WSH+AL*BD
        IF(K.EQ.1) THEN
          THI=VWC(1)+AL*BD
          THE=VWC(1)+DR+AL*BD
          CMESO(1,IC)=(CMESO(1,IC)*THI+CRO(1,IC)*DR)/THE
          IF(MICP(1).GT.0.0D0) CMICR(1,IC)=CMESO(1,IC)
          IF(IC.EQ.1) THEN
            TFLI=DEF*TCW
            TCUR=(VWC(1)*CW+CSHD(NH))*1.0D3
            DENT=(WSH*CW+CSHD(NH))*1.0D3
            TEMP(1)=(TEMP(1)*TCUR+TEMPR*TFLI)/DENT
          ENDIF
        ELSE
          DEF=(WSH-VWC(K))*0.5D0
C         DEF = (WSH - VWC(K)) * 0.25D0
          DEF=MAX(DEF,0.D0)
          DEF=MIN(DEF,THSMS(1,IC))
          THI=VWC(K)+AL*BD
C         DO 40 KL = 1, 4
          DO 40 KL=1,2
            DO 30 J=K,2,-1
              JJ=IT2H(J)
              JK=NDXT2N(J)
              if (jk.EQ.0) JK=NDXT2N(J-1)
              DEF=MIN(DEF,THSMS(JK,IC))
              IF (CMESO(J,IC).LT. 0.0D0)
     +          WRITE(9,*)' CMESO STARTING NEG',CMESO(J,IC),IC,J,K
              IF(J.EQ.K) THEN
C               CMESORG = CMESO(J,IC)
              if (K.EQ.NSLT+1) then
              IF (CMESO(J,IC).EQ.0.0D0) THEN
              cmeso(j,ic)=cmeso(j-1,ic)
              ELSE
              cmeso(j,ic)=(cmeso(j-1,ic)+cmeso(j,ic))/2.0d0
              ENDIF
              else
                CMESO(J,IC)=(CMESO(J,IC)*THI+DBLE(KL-1)*CMESO(J,IC)*DEF+
     +              CMESO(J-1,IC)*DEF)/(THI+DEF+DBLE(KL-1)*DEF)
              endif
              IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CMESO(J,IC)
                IF(IC.EQ.1) THEN
                  TFLI=DEF*TCW
                  TCUR=(VWC(K)*CW+CSHD(NH))*1.0D3
                  DENT=((VWC(K)+DBLE(KL-1)*DEF+DEF)*CW+CSHD(NH))*1.0D3
                  TEMP(J)=(TEMP(J)*TCUR+DBLE(KL-1)*TEMP(J)*TFLI+
     +                TEMP(J-1)*TFLI)/DENT
                ENDIF
                IF(J.EQ.IBRK+1)BRKMAS(IC)=BRKMAS(IC)+CMESO(J-1,IC)*DEF
              ELSE
                CMESO(J,IC)=(CMESO(J,IC)*(THSMS(JK,IC)-DEF)+
     +              CMESO(J-1,IC)*DEF)/THSMS(JK,IC)
                IF(IC.EQ.1) THEN
                  TFLO=DEF*TCW
                  TCUR=CSHWS(JJ)
                  TEMP(J)=(TEMP(J)*TCUR+(TEMP(J-1)-TEMP(J))*TFLO)/TCUR
                ENDIF
                IF(J.EQ.IBRK+1)BRKMAS(IC)=BRKMAS(IC)+CMESO(J-1,IC)*DEF
              ENDIF
              IF(CMESO(J,IC).LT.0.0D0) THEN
                WRITE(9,*)'CMESO WENT NEGATIVE-UNSATFLO',CMESO(J,IC),J,K
              ENDIF
   30       CONTINUE
C           .. LEVEL OUT THE SURFACE LAYER
            CMESO(1,IC)=(CMESO(1,IC)*(THSMS(1,IC)-DEF)+CRO(I,IC)*DEF)/
     +          THSMS(1,IC)
            IF(IC.EQ.1) THEN
              TFLO=DEF*TCW
              TCUR=CSHWS(1)
              TEMP(1)=(TEMP(1)*TCUR+(TEMPR-TEMP(1))*TFLO)/TCUR
            ENDIF
   40     CONTINUE
        ENDIF
        IF(ID.EQ.NSLT+1) THEN
c  change made my Liwang Ma to correct mistake on infiltration when reaches bottom for Green-Ampt 
c          CDNCHM(IC)=CDNCHM(IC)+CMESO(ID,IC)*(WSH+AL*BD)
c          IF(IC.EQ.1) CDNHT=CDNHT+TEMP(ID)*(WSH*CW+CSHD(NH))*1.0D3
          CDNCHM(IC)=CDNCHM(IC)+CMESO(ID,IC)*DEF*2.0d0
          IF(IC.EQ.1) CDNHT=CDNHT+TEMP(ID)*(DEF*CW+CSHD(NH))*1.0D3
        ENDIF
C       DETERMINE EFFECTS FROM KINETICS
        IF(IC.GT.12.AND.ID.LT.NSLT) CALL
     +      KNETIC(ID,DTIM,IC,X2CONC,AEF,CORR,SOILHP,porav)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
   50 CONTINUE
C     ..UPDATE WATER CONTENT
      IF(K.LT.NSLT+1) VWC(K)=WSH
      RETURN
      END
      FUNCTION IFINDWT(VWC,SOILHP,NSLT,MAXHOR)
C
C======================================================================
C
C       PURPOSE:  LOCATE THE FIRST NON SATURATED LAYER COUNTING FROM THE
C                 BOTTOM OF THE PROFILE
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       NSLT       I  PROFILE DEPTH [CM]
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C
C       PROGRAMMER: KWR
C
C       VERSION:  2003
C
C-----------------------------------------------------------------------
C
      INTEGER J,JH,NSLT,MAXHOR,IFINDWT
	parameter (mxnodt=3001)
      DOUBLE PRECISION VWC(mxnodt), SOILHP(13,MAXHOR)
      IFINDWT=1
      DO 10 J=NSLT,1,-1
        JH=IT2H(J)
        IF (VWC(J).LT.SOILHP(6,JH)-1.0E-12) THEN
          IFINDWT=J+1
          GOTO 100
        ENDIF
10    CONTINUE
100   IFINDWT=MIN(IFINDWT,NSLT)
      RETURN
      END
      SUBROUTINE SATFLO(I,NSLT,DTIM,DRDEP,SUBDR,BOTFLX,CUMDR,SOILHP,
     +    VWC,CMESO,CSHD,CW,TEMP,DRCHEM,CDNCHM,CDNHT,CRO,DRHT,TEMPR,
     +    BFSEEP,H2OT2,AEF,XPRESWAT,XPRESCHEM,CMICR,ALH,BDH,MICP,DR)
C
C======================================================================
C
C       PURPOSE:  DO SEEPAGE OUT OF TILE DRAIN OR BOTTOM OF PROFILE WHEN
C        A WATER TABLE EXISTS IN THE ROOT ZONE
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALHMAC    I/O KD FOR LINEAR DESORPTION OF CURRENT PEST[CM3 H2O/G SOIL]
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BFSEEP    I/O FLUX OUT BOTTOM DUE TO BOTTOM BOUNDARY CONDITION [CM]
C       BOTFLX     I  RATE OF FLOW OF BOTTOM BOUNDARY CONDITION [CM/HR]
C       BOTLO     L  BOTTOM FLUX DEMAND WE ARE UNABLE TO MEET [CM]
C       BOTOUT     L  ACTUAL AMOUNT OF WATER OUT BOTTOM OF PROFILE [CM]
C       CDNCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE [UG]
C       CDNHT     I/O HEAT LOST OUT BOTTOM OF PROFILE
C       CMESO     I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CRO        I  CHEMICAL IN RUNOFF [UG/CM^2]
C       CSHD      I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CUMDR     I/O CUM TILE DRAIN WATER FLOW [CM]
C       TCUR      L  CURRENT TEMPERATURE ENERGY
C       CW         I  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DENT      L  FACTOR IN TEMPERATURE CALC.
C       DFLJ1     L  WATER FLUX INTO LAYER BELOW TILE DRAIN [CM/HR]
C       DFLX      L  WATER FLUXES DUE TO DRAINAGE [CM/HR]
C       DRCHEM    I/O CHEM. LOSS IN TILE DRAIN [UG/CM^2]
C       DRDEP     I  DEPTH TO TILE DRAIN [CM]
C       DRHT      I/O CUM HEAT LOSS OUT TILE DRAIN
C       DTIM      I  TIME STEP [HR]
C       FC10      L  VOL WATER CONTENT AT 1/10 BAR [CM^3-W/CM^3-S]
C       TFLI      L  TEMPERATURE FLUX MOVING IN
C       TFLO      L  TEMPERATURE FLUX MOVING OUT
C       H2OT2     I/O DEPTH TO WATER TABLE [CM]
C       I         I  INDEX VARIABLE
C       IC         L  INDEX VARIABLE
C       J         L  INDEX VARIABLE
C       JH         L  HORIZON INDEX
C       JJ         L  INDEX VARIABLE
C       KJ         L  INDEX VARIABLE
C       L          L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MICP       I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NSLT       I  PROFILE DEPTH [CM]
C       OLDSUB     L  TEMPORARY DRAIN VARIABLE
C       OUTFLOW    L  AMT OF WATER TO BE TAKEN OUT DUE TO DRAIN AND FLX [CM]
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       SUBDR     I/O FLUX OUT TILE DRAIN [CM/HR]
C       SUBLO      L  DRAIN FLUX DEMAND WE ARE UNABLE TO MEET [CM]
C       SUBOUT     L  ACTUAL AMOUNT OF WATER OUT TILE DRAIN [CM]
C       TEMP      I/O TEMPERATURE OF LAYER (C)
C       TEMPR      I  TEMPERATURE OF RAIN (C)
C       THJ        L  WATER CONTENT IN MICROPORES [CM]
C       TMP        L  AUGMENTED MATRIX WORKSPACE
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 IT2H, FINDWT
C
C       CALLED FROM:  INFIL
C
C       PROGRAMMER: K.W. ROJAS
C
C       VERSION:  2003
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MXNODT=3001,MAXHOR=12,MXCHEM=15,MXNOD=300)
      PARAMETER(MXTSTP=5000)
C
      DOUBLE PRECISION MICP(MAXHOR),ALH(MXnod,MXCHEM),BDH(MAXHOR),
     +  CUMDR(MXTSTP),SOILHP(13,MAXHOR),VWC(mxnodt),
     +  CMESO(MXNODT,MXCHEM),CSHD(MAXHOR),TEMP(mxnodt),
     +  DRCHEM(MXTSTP,MXCHEM),CDNCHM(MXCHEM),CMICR(MXNODT,MXCHEM),
     +  CRO(MXTSTP,MXCHEM),XPRESCHEM(MXCHEM),TVWC(mxnodt)
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      TCW=CW*1000.0D0
      IWTL=IFINDWT(VWC,SOILHP,NSLT,MAXHOR)
C     ..FIND AMT TO FLOW OUT DRAIN IN THIS TIME STEP
      DRAINWAT=SUBDR*DTIM
C     ..FIND AMT TO FLOW OUT BOTTOM IN THIS TIME STEP
      BOTOUT=BOTFLX*DTIM
C
C     ..MOVE WATER FROM LEAKAGE AND TILE DRAIN
      IF (IWTL.EQ.DRDEP+1) THEN
        OUTDRAIN=DRAINWAT
      ELSE
        OUTDRAIN=DRAINWAT/(DRDEP-IWTL+1)
      ENDIF
      IWTLO=IWTL
      DO 30 J=1,NSLT
        TVWC(J)=VWC(J)
   30 CONTINUE
      CDNHT=CDNHT+TEMP(NSLT)*BOTOUT*TCW
      DRHT=DRHT+TEMPR*XPRESWAT*TCW
      CUMDR(I)=CUMDR(I)+DRAINWAT+XPRESWAT
      BFSEEP=BFSEEP+BOTOUT
C
C     ..CALCULATE NEW CHEMICAL CONC. AND TEMPERATURES
      DO 60 IC=1,MXCHEM
        IF(I.EQ.1) THEN
          DRCHEM(I,IC)=0.0D0
        ELSE
          DRCHEM(I,IC)=DRCHEM(I-1,IC)
        ENDIF
        IWTL=IWTLO
        DO 40 J=1,NSLT
          VWC(J)=TVWC(J)
   40   CONTINUE
C
C       ..IF BOTTOM FLUX LEACH CHEMS AND WATER
        IF (BOTOUT.GT.0.0D0) THEN
          CDNCHM(IC)=CDNCHM(IC)+CMESO(NSLT,IC)*BOTOUT
          VWC(NSLT)=VWC(NSLT)-BOTOUT
        ENDIF
        DO 50 J=NSLT,IWTL,-1
          IF(J.LE.DRDEP.AND.OUTDRAIN.GT.0.0)THEN
C
C           ..EXTRACT DRAIN WATER/TEMP/CHEM FROM SINGLE LAYER
            DRCHEM(I,IC)=DRCHEM(I,IC)+CMESO(J,IC)*OUTDRAIN
            IF(IC.EQ.1)DRHT=DRHT+TEMP(J)*OUTDRAIN*TCW
            VWC(J)=VWC(J)-OUTDRAIN
          ENDIF
C         ..REFILL VOID SPACE WITH WATER/CHEM/TEMP FROM ABOVE LAYER
          JH=IT2H(J)
          JK=NDXT2N(J)
          DEF=SOILHP(6,JH)-VWC(J)
          THJ=(VWC(J)+ALH(JK,IC)*BDH(JH))
          TCUR=(VWC(J)*CW+CSHD(JH))*1.0D3
          TFLO=DEF*TCW
          IF(J.GT.1) THEN
            CMESO(J,IC)=(CMESO(J,IC)*THJ+CMESO(J-1,IC)*DEF)/(THJ+DEF)
            IF(IC.EQ.1)TEMP(J)=(TEMP(J)*TCUR+TEMP(J-1)*TFLO)/(TCUR+TFLO)
                  VWC(J-1)=VWC(J-1)-DEF
          ELSE
            IF (DR.LT.DEF) THEN
              DEF=DR
              TFLO=DR*TCW
            ENDIF
            CMESO(J,IC)=(CMESO(J,IC)*THJ+CRO(I,IC)*DEF)/(THJ+DEF)
            IF(IC.EQ.1)TEMP(J)=(TEMP(J)*TCUR+TEMPR*TFLO)/(TCUR+TFLO)
          ENDIF
          VWC(J)=VWC(J)+DEF
          IF(MICP(JH).GT.0.0D0) CMICR(J,IC)=CMESO(J,IC)
   50   CONTINUE
        DRCHEM(I,IC)=DRCHEM(I,IC)+XPRESWAT*XPRESCHEM(IC)
   60 CONTINUE
      H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
      RETURN
      END
C
      SUBROUTINE FULFLO(NSLT,VWC,SOILHP,CI,TR,RR,RFD,RFDD,CRAIN,CRO,
     +    THSMS,CMESO,CMICR,DEG,ALH,BDH,MICP,CUMRO,CUMCLR,ISAT,SUBDR,
     +    BOTFLX,DRDEP,CUMDR,BFSEEP,DRCHEM,TEMP,CSHD,CW,CDNHT,CDNCHM,
     +    HORTHK,H2OT2,NHOR,INFLPD,I,ID,AEF,TEMPR,RINDR,DRHT,YESMAC,
     +    FLXMAX,FDEP,CHEMWASH,XPRESWAT,XPRESCHEM,DR,DTIM,CUMMF,CUMCLM,
     +    porav)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C======================================================================
C
C       PURPOSE:  CALCULATE TILE FLOW, BOTTOM SEEPAGE, AND RUN OFF WHEN
C             PROFILE BECOMES FULLY SATURATED.
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALHMAC    I/O KD FOR LINEAR DESORPTION OF CURRENT PEST[CM3 H2O/G SOIL]
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BFSEEP    I/O FLUX OUT BOTTOM DUE TO BOTTOM BOUNDARY CONDITION [CM]
C       BOTFLX     I  RATE OF FLOW OF BOTTOM BOUNDARY CONDITION [CM/HR]
C       BOTLO  L  BOTTOM FLUX DEMAND WE ARE UNABLE TO MEET [CM]
C       BOTOUT     L  ACTUAL AMOUNT OF WATER OUT BOTTOM OF PROFILE [CM]
C       CDNCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE [UG]
C       CDNHT I/O HEAT LOST OUT BOTTOM OF PROFILE
C       CI        I/O TIME SERIES ACCUM. WATER INFILTRATION [CM]
C       CMESO I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR I/O CHEMICAL CONC. IN MICROPORES [MG/L]
C       CRAIN  I  CHEMICAL CONC. IN RAIN WATER [MG/L]
C       CRO       I/O CHEMICAL IN RUNOFF [UG/CM^2]
C       CSHD   I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CUMCLR    I/O CUM CHEMICAL LOSS IN RUNOFF [UG/CM^2]
C       CUMDR I/O CUM TILE DRAIN WATER FLOW [CM]
C       CUMRO I/O CUMMULATIVE WATER RUNOFF [CM]
C       TCUR   L  CURRENT TEMPERATURE ENERGY
C       CW         I  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DEG        I  DEGREE OF CHEMICAL MIXING WITH RAINWATER
C       DELQ   L  AMOUNT OF WATER NEEDED TO SATURATE [CM]
C       DENT   L  FACTOR IN TEMPERATURE CALC.
C       DFLJ1  L  WATER FLUX INTO LAYER BELOW TILE DRAIN [CM/HR]
C       DFLX   L  WATER FLUXES DUE TO DRAINAGE [CM/HR]
C       DR         L  DEPTH OF RAIN IN CURRENT STEP
C       DRCHEM    I/O CHEM. LOSS IN TILE DRAIN [UG/CM^2]
C       DRDEP  I  DEPTH TO TILE DRAIN [CM]
C       DRHT  I/O CUM HEAT LOSS OUT TILE DRAIN
C       DTIM   L  TIME STEP [HR]
C       FC10   L  VOL WATER CONTENT AT 1/10 BAR [CM^3-W/CM^3-S]
C       TFLI   L  TEMPERATURE FLUX MOVING IN
C       TFLO   L  TEMPERATURE FLUX MOVING OUT
C       H2OT2 I/O DEPTH TO WATER TABLE [CM]
C       HORTHK     I  DEPTH OF SOIL HORIZONS [CM]
C       I      I  INDEX VARIABLE
C       I1         L  MAXIMUM OF I-1 AND 1
C       IC         L  INDEX VARIABLE
C       ID         I  INDEX VARIABLE
C       INFLPD     I  FLAG FOR PONDED INFILTRATION
C       ISAT  I/O INDICATES WHETHER PROFILE IS SATURATED 0=NO 1=YES
C       J      L  INDEX VARIABLE
C       JH         L  HORIZON INDEX
C       JJ         L  INDEX VARIABLE
C       KJ         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NHOR   I  NUMBER OF SOIL HORIZONS
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NSLT   I  PROFILE DEPTH [CM]
C       OLDSUB     L  TEMPORARY DRAIN VARIABLE
C       OUTFLOW    L  AMT OF WATER TO BE TAKEN OUT DUE TO DRAIN AND FLX [CM]
C       RFD       I/O CURRENT RAINFALL DEPTH [CM]
C       RFDD   I  TOTAL RAINFALL DEPTH [CM]
C       RO         L  RUNOFF DURING A TIME INTERVAL [CM]
C       RR        I/O RAINFALL RATE [CM/HR]
C       RRD        L  AMT OF RAIN IN THIS TIME STEP [CM]
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       SUBDR I/O FLUX OUT TILE DRAIN [CM/HR]
C       SUBLO  L  DRAIN FLUX DEMAND WE ARE UNABLE TO MEET [CM]
C       SUBOUT     L  ACTUAL AMOUNT OF WATER OUT TILE DRAIN [CM]
C       TEMP  I/O TEMPERATURE OF LAYER (C)
C       TEMPR  I  TEMPERATURE OF RAIN (C)
C       THJ        L  WATER CONTENT IN MICROPORES [CM]
C       THSMCJ     L  SATURATED WATER CONTENT OF MICROPORES [0..1]
C       THSMS  I  SATURATED WATER CONTENT OF MESOPORES [0..1]
C       TMP        L  AUGMENTED MATRIX WORKSPACE
C       TR        I/O CUMMULATIVE TIME OF RAINFALL [HR]
C       V      L  SCALAR VALUE TO BE STORED
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 IT2H
C                 RR2
C
C       CALLED FROM:  INFIL
C
C       PROGRAMMER: K.E. JOHNSEN
C
C       VERSION:  2.15
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MXNODT=3001,MAXHOR=12,MXCHEM=15,MXNOD=300)
      PARAMETER(MXTSTP=5000, SATDTIM=5.0D0/60.0D0)
C
      INTEGER YESMAC
      DOUBLE PRECISION MICP(MAXHOR)
      DIMENSION VWC(mxnodt),SOILHP(13,MAXHOR),TR(MXTSTP),CI(MXTSTP),
     +   CRAIN(MXCHEM),CRO(MXTSTP,MXCHEM),THSMS(MXNOD,MXCHEM),
     +   CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),DEG(MAXHOR),
     +   ALH(MXnod,MXCHEM),BDH(MAXHOR),CUMRO(MXTSTP),XPRESCHEM(MXCHEM),
     +   CUMCLR(MXTSTP,MXCHEM),CUMDR(MXTSTP),DRCHEM(MXTSTP,MXCHEM),
     +   TEMP(MXNODT),CSHD(MAXHOR),CDNCHM(MXCHEM),DFLX(MXNODT),
     +   HORTHK(MAXHOR),FLXMAX(MAXHOR),FDEP(MAXHOR),CHEMWASH(MXCHEM),
     +   CUMMF(MXTSTP),CUMCLM(MXTSTP,MXCHEM),porav(mxnodt)
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C     ..INITIALIZE SEEPAGE VARIABLES
      IF(ISAT.NE.1) THEN
C        PRINT*,'INSIDE FULFLO @ ISAT=0',I,ID
C
C       ..WE ARE STILL ON CURRENT TIME STEP, SO TAKE THIS TIME STEP
C       WITHOUT DOING DRAINAGE SO THAT MASS BALANCES DON'T GET MESSED UP
        I1=MAX(I-1,1)
        DRHT=DRHT+TEMPR*XPRESWAT*CW*1000.0
        CUMDR(I)=CUMDR(I1)+XPRESWAT
        DO 30 IC=1,MXCHEM
          DRCHEM(I,IC)=DRCHEM(I1,IC)+XPRESWAT*XPRESCHEM(IC)
          DO 320 J=1,NSLT
            JH=IT2H(J)
            JK=NDXT2N(J)
            WCAB=VWC(J)+ALH(JK,IC)*BDH(JH)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
            WCMC=(porav(j)+ALH(JK,IC)*BDH(JH))*MICP(JH)
            IF(porav(j)*MICP(JH).GT.VWC(J)) WCMC=WCAB*MICP(JH)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            WCMS=WCAB-WCMC
            CMESO(J,IC)=(CMESO(J,IC)*WCMS+CMICR(J,IC)*WCMC)/WCAB
            IF(MICP(JH).GT.0.0D0) CMICR(J,IC)=CMESO(J,IC)
  320     CONTINUE
   30   CONTINUE
      ELSE
        I1=MAX(I-1,1)
        CUMMF(I)=CUMMF(I1)
        DO 50 IC=1,MXCHEM
          CUMCLM(I,IC)=CUMCLM(I1,IC)
   50   CONTINUE
        OUTFLOW=(SUBDR+BOTFLX)*DTIM
        IF(DR.LT.OUTFLOW) THEN
C          PRINT*,'INSIDE FULFLO @ ISAT>0 AND DR<OUTFLOW',DR,OUTFLOW
C         ..NEW RAIN DEPTH IS NOT > OUTFLOW SO PROFILE WILL BECOME NON-SAT
C         INFILTRATE RAIN AND MOVE OUTFLOW FROM THE TOP OF WATER TABLE
          RINDR=RINDR+DR
          ISAT=0
        ENDIF
C        PRINT*,'CALLING SATFLO FROM FULFLO',I
C       ..DETERMINE TRANSPORT IN SATURATED PROFILE FROM SURFACE TO BOTTOM
        CALL SATFLO(I,NSLT,DTIM,DRDEP,SUBDR,BOTFLX,CUMDR,SOILHP,VWC,
     +      CMESO,CSHD,CW,TEMP,DRCHEM,CDNCHM,CDNHT,CRO,DRHT,TEMPR,
     +      BFSEEP,H2OT2,AEF,XPRESWAT,XPRESCHEM,CMICR,ALH,BDH,MICP,DR)
      ENDIF
      RETURN
      END
C
      SUBROUTINE MPFLOW(I,ID,CORR,CONC,AEF,IBRK,BRKWAT,BRKMAS,ITBL,ISAT,
     +    H2OT2,SOILHP,TEMP,CSHD,CW,CDNHT,TEMPR,CMACSEP,WMACSEP,ALHMAC,
     +    XPRESWAT,XPRESCHEM,IDRAIN,porav,NN)
C======================================================================
C
C       PURPOSE:  THIS SUBROUTINE ACCOUNTS FOR MACROPORE FLOW AND
C             INTERACTIONS WITH SOIL MATRIX, OF WATER AND CHEMICALS
C
C
C       REF:  AHUJA, LAJ; USDA-ARS, DURANT OK
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALHMAC    I/O KD FOR LINEAR DESORPTION OF CURRENT PEST[CM3 H2O/G SOIL]
C       ALMW   L  KD FACTOR FOR MACP.
C       AVGC   L  CHEM. MASS FROM DEADEND MACP.
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BRKMAS    I/O FLUX OF CHEM AT BREAK THROUGH NODE [UG/CM^2]
C       BRKWAT    I/O FLUX OF WATER AT BREAK THROUGH NODE [CM]
C       CDBET I/O CHEMICAL IN DEADEND MACP. [UG]
C       CDFLOW    I/O CHEMICAL FLOW FROM DEADEND MACP. TO SOIL [UG]
C       CDNHT I/O HEAT LOST OUT BOTTOM OF PROFILE
C       CFLOW I/O CHEMICAL FROM CONT. MACROPORES TO SOIL [UG]
C       CHH        L  SAT. HYDRAULIC CONDUCTIVITY
C       CMASW I/O CHEMICAL MASS ALONG MACROPORE WALLS [UG/CM^2]
C       CMESO I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR I/O CHEMICAL CONC. IN MICROPORES [MG/L]
C       CONC  I/O CHEM. CONC. IN SOIL WATER OF EACH SOIL NODE
C                 SAME AS CC [MG/L]
C       CORR   I  AMT. OF INFILTRATION CORRECTION FOR OVERSHOOTING
C                 THE TOTAL RAINFALL AMOUNT [CM]
C       CRO        I  CHEMICAL IN RUNOFF [UG/CM^2]
C       CRONEW     L  CHEM. CONC. GOING INTO MACROPORES
C       CSHD   I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CUMCLM    I/O CUM CHEMICAL FLOW IN MP VS. TIME [UG/CM^2]
C       CUMCLR    I/O CUM CHEMICAL LOSS IN RUNOFF [UG/CM^2]
C       CUMMF I/O CUM MACROPORE WATER FLOW [CM]
C       CUMRO I/O CUMMULATIVE WATER RUNOFF [CM]
C       CUPCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE
C                 FROM MACROPORES [UG/CM^2]
C       CUPRO I/O WATER SEEPAGE OUT BOTTOM OF PROFILE
C                 FROM MACROPORES [CM]
C       TCUR   L  CURRENT TEMPERATURE ENERGY
C       CW         I  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DB         I  MAX CAPACITY OF DEADEND PORES [CM]
C       DBET  I/O MOISTURE CONTENT IN DEADEND MACROPORES [CM]
C       DEF        L  AMOUNT OF WATER NEEDED TO SATURATE [CM]
C       DEFD   L  DEFICIT IN DEADEND MACROPORES
C       DEXCES     L  EXCESS R/O THAT CAN NOT FLOW INTO MACROPORES
C       DENT   L  FACTOR IN TEMPERATURE CALC.
C       DFLOW I/O WATER FLOW FROM DEADEND MACROPORES TO SOIL
C                 SPACIALLY DISTRUB [CM]
C       DTIM   L  TIME STEP [HR]
C       EFFWR  P  EFFECTIVE LATERAL INFILTRATION WETTING THICKNESS
C                 FOR RADIAL HOLES [CM]
C       EFFWC  P  EFFECTIVE LATERAL INFILTRATION WETTING THICKNESS
C                 FOR CRACKS [CM]
C       EXCESS     L  TOTAL EXCESS R/O THAT CAN NOT FLOW INTO MACROPORES
C       EXCHEM     L  TOTAL EXCESS CHEM THAT CAN NOT FLOW INTO MACROPORES
C       FCTR1  L  FACTOR USED IN MACROPORE FLOW
C       FCTR2  L  FACTOR USED IN MACROPORE FLOW
C       FCTR22     L  FACTOR USED IN MACROPORE FLOW
C       FDEP   I  FRACTION OF TOTAL MACROPORES THAT ARE DEADEND [0..1]
C       TFLI   L  TEMPERATURE FLUX MOVING IN
C       TFLO   L  TEMPERATURE FLUX MOVING OUT
C       FLOW  I/O CUMCUL. WATER FLOW FROM CONT. MACROPORES TO SOIL
C                 IN EACH LAYER. [CM]
C       FLXMAX     I  MAXIMUN WATER FLUX IN RADIAL PORE CONTROLLED
C                 MACROPORE HORIZONS [CM/HR]
C       FLXMXA     L  R/O RATE IN PONDED CONDITIONS W/ MACP. [CM/HR]
C       H2OT2 I/O DEPTH TO WATER TABLE [CM]
C       I      I  INDEX VARIABLE
C       I1         L  --SUBSCRIPT OF FIRST TABLE VALUE.
C       I2         L  --SUBSCRIPT OF SECOND TABLE VALUE.
C       IBRK   I  LAYER INTERFACE BELOW BREAK THROUGH NODE
C       IC         L  INDEX VARIABLE
C       ID         I  INDEX VARIABLE (DEPTH)
C       ISAT   I  INDICATES WHETHER PROFILE IS SATURATED 0=NO 1=YES
C       ITBL   I  INDICATES PRESENCE OF WATER TABLE 0=NO 1=YES
C       J      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       MAXBP  P  MAXIMUM NUMBER OF BREAK POINTS IN A RAINSTORM
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MCPOR  I  TOTAL MACROPOROSITY OF HORIZON [CM3/CM3]
C       MFBLC  L  AMOUNT OF RUNOFF TO GO INTO MACROPORES
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NH         L  HORIZON NUMBER OF CURRENT INFIL. LAYER
C       NHCMP  I  NUMBER OF HORIZONS CONTAINING MACROPORES
C       NHZ        I  NUMBER OF SOIL HORIZONS
C       NPOR   I  TOTAL NUMBER OF MACROPORES PER LAYER
C       NSL        I  DEPTH TO BOTTOM OF SOIL HORIZONS [CM]
C       NSL1   L  DEPTH TO BOTTOM OF HORIZONS CONTAINING MACP.
C       NSLT   I  PROFILE DEPTH [CM]
C       PI         I  MATHEMATICAL CONSTANT = 3.141592654...
C       PL         I  LENGTH OF VERTICAL MACROPORE CRACKS  [CM]
C       Q      L  NODAL MOISTURE FLUXES [CM/HR]
C       QD         L  FACTOR USED IN MACROPORE FLOW
C       RFD        I  CURRENT RAINFALL DEPTH [CM]
C       RFDD   I  TOTAL RAINFALL DEPTH [CM]
C       RO         I  RUNOFF DURING A TIME INTERVAL [CM]
C       ROB        L  NEW RUNOFF AMOUNT [CM]
C       RP         I  RADIUS OF CYLINDRICAL MACROPORES IN HORIZON [CM]
C       RWF        L  FACTOR USED IN CALCULATING RADIAL INFILTRATION
C       RWFD   L  FACTOR USED IN CALCULATING RADIAL INFILTRATION
C       SATUR  L  DEFICIT IN CONTINUOUS PORES
C       SATURD     L  DEFICIT IN DEADEND PORES
C       SDBET  L  SAVED INITIAL DEADEND PORE MOISTURE CONTENTS
C       SDFLOW     L  SAVED INITIAL WATER FLOW FROM D.E. PORES
C       SFCT   I  SORPTIVITY FACTOR
C       SFLOW  L  SAVED INITIAL WATER FLOW FROM CONT. PORES
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       SORPT  L  SORPTIVITY FACTOR
C       STDFLO     L  SAVED INITIAL WATER FLOW IN D.E. MACP.
C       STFLOW     L  SAVED INITIAL TIME OF FLOW
C       SVWC   L  SAVED INITIAL WATER CONTENTS
C       SWF        I  AVE WETTING-FRONT SUCTION [CM]
C       SWFF   L  SUCTION AT THE WETTING FRONT AT CURRENT DEPTH
C       TDFLOW    I/O CUMMULATIVE TIME OF FLOW IN DEAD END MACROPORES [HR]
C       TEMP  I/O TEMPERATURE OF LAYER (C)
C       TEMPR  I  TEMPERATURE OF RAIN (C)
C       TFLOW I/O CUMMULATIVE TIME OF MACROPORE FLOW [HR]
C       THMS   L  SATURATED WATER CONTENT OF MESOPORES [0..1]
C       THMSW  L  SATURATED WATER CONTENT OF MACP. WALLS [0..1]
C       THSMS  I  SATURATED WATER CONTENT OF MESOPORES [0..1]
C       THSV   L  SAVED THSMS VALUE
C       TR         I  CUMMULATIVE TIME OF RAINFALL [HR]
C       TWOPI  I  VALUE OF 2.0*PI
C       V      L  RADIAL INFILTRATION RATE - CONT. MACP.
C       VD         L  RADIAL INFILTRATION RATE - D.E. MACP.
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C       WCAB   L  MOISTURE CONTENT PLUS KD FACTOR
C       WP         I  WIDTH OF RECTANGULAR CRACKS IN HORIZON [CM]
C       WSH        L  SATURATED WATER CONTENT [0..1]
C       WSS        L  SATURATED MOISTURE CONTENT
C       WVOL   L  VOLUME OF PLANAR CRACKS
C       WVOL1  L  VOLUME OF MACROPORES
C       YESMAC     I  INDICATS PRESENCE OF MACROPORES =1 YES, =0 NOT
C
C       PROGRAMMER:  DR. L. AHUJA, K.E. JOHNSEN, KEN ROJAS
C
C       VERSION:   2003.12.16
C
C       LAST CHANGED: 12/16/2003
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MAXBP=50,MXNODT=3001,MAXHOR=12,MXCHEM=15)
      PARAMETER(MXTSTP=5000,mxnod=300)
C
C   ...COMMON SPACE FOR INFILTRATION AND EVENT-TRANSPORTATION
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
C ----------------------------------------------------------------------
      COMMON /IPMACF/ AGSZ(MAXHOR),FDEP(MAXHOR),MCPOR(MAXHOR),PI,
     +    PL(MAXHOR),RP(MAXHOR),SFCT,TWOPI,WP(MAXHOR),NHCMP,YESMAC,
     +    EFFWR,EFFWC,XPRESF
C ----------------------------------------------------------------------
      COMMON /IPINF/ CRUSTK,OCRUST,ICRUST,INFLPD,NHZ,NSLT,POND,RR,
     +    DHB(MAXHOR),NSL(MAXHOR),WI(Mxnod),DSL(MXNODT),VWC(MXNODT),
     +    IUGFLW
      DOUBLE PRECISION MICP,MCPOR,MFBLC,NPOR
      INTEGER YESMAC
      COMMON /OPINF/ RO,SWF(MXnod),TR(MXTSTP),CI(MXTSTP),CRFD(MAXBP),
     +    CRFT(MAXBP),RFI(MAXBP),RFDD,RFD
      COMMON /OPCHEM/ THSMS(MXNOD,MXCHEM),CUPRO,CUPCHM(MXCHEM),CDNCI,
     +    CDNCHM(MXCHEM),CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),
     +    CRO(MXTSTP,MXCHEM)
      COMMON /OPMACF/ CDBET(MXNODT,MXCHEM),CFLOW(MXNODT,MXCHEM),
     +    CDFLOW(MXNODT,MXCHEM),CUMCLM(MXTSTP,MXCHEM),
     +    CUMCLR(MXTSTP,MXCHEM),CUMMF(MXTSTP),CUMRO(MXTSTP),
     +    DBET(MXNODT),DFLOW(MXNODT),FLOW(MXNODT),TDFLOW(MXNODT),
     +    TFLOW(MXNODT)
      COMMON /INTMCF/ FLXMAX(MAXHOR),DB(MAXHOR),NPOR(MAXHOR)
      COMMON /ICMASW/ CMASW(MXNODT,MXCHEM)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
      DIMENSION ALMW(MXNOD),THMSW(MXNOD,MXCHEM),SDBET(MXNODT),
     +    SFLOW(MXNODT),SDFLOW(MXNODT),STFLOW(MXNODT),STDFLOW(MXNODT),
     +    SVWC(MXNODT),WMACSEP(MXTSTP),TEMP(NSLT+1),CSHD(MAXHOR),
     +    CMACSEP(MXTSTP,MXCHEM),ALHMAC(MXNOD,MXCHEM),porav(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
      SAVE ALMW,THMSW
C ----------------------------------------------------------------------
      DIMENSION CONC(NSLT+1,MXCHEM),SOILHP(13,MAXHOR),BRKMAS(MXCHEM),
     +    XPRESCHEM(MXCHEM)
C ----------------------------------------------------------------------
C
C     ..SAVE INITIAL VALUES
      DO 10 J=1,NSLT+1
        SDBET(J)=DBET(J)
        SFLOW(J)=FLOW(J)
        SDFLOW(J)=DFLOW(J)
        STFLOW(J)=TFLOW(J)
        STDFLOW(J)=TDFLOW(J)
        SVWC(J)=VWC(J)
   10 CONTINUE
C
      DO 120 IC=1,MXCHEM
C
C       ..RESET TO INITIAL VALUES FOR EACH CHEMICAL
        DO 20 J=1,NSLT+1
          DBET(J)=SDBET(J)
          FLOW(J)=SFLOW(J)
          DFLOW(J)=SDFLOW(J)
          TFLOW(J)=STFLOW(J)
          TDFLOW(J)=STDFLOW(J)
          VWC(J)=SVWC(J)
   20   CONTINUE
        H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
C       ----------------------------------------------------------------------
C       MAXIMUM FLUX INTO SOIL, CONTROLLED BY HORIZON A:
C       FLXMAX= MAX INFILTRATION RATE(CM/TIME STEP)
C
C       ..SET ADSORPTION TO WALLS AND LATERAL INFIL AMTS.
C       IF (I .EQ. 1) THEN
C
C       ..SET THE LATERAL INFILTRATION AMOUNT FOR RADIAL HOLES
           NNCMP=0
        DO J=1,NHCMP
           NNCMP=NNCMP+NDXH2N(J)
        ENDDO
        DO 30 J=1,NNCMP
           JJ=NDXN2H(J)
          WVOL1=(TWOPI*RP(JJ)*EFFWR+PI*EFFWR**2.0D0)*(1.0D0-FDEP(JJ))*
     +        NPOR(JJ)
          ALMW(J)=WVOL1*ALHMAC(J,IC)*BDH(JJ)   !why not +? Liwang Ma, 3-27-2009
          THMSW(J,IC)=THSMS(J,IC)*WVOL1
   30   CONTINUE
C
C       ..SET THE LATERAL INFILTRATION AMOUNT FOR CRACKS
        DO 40 J=NNCMP+1,NN
           JJ=NDXN2H(J)
          WVOL=2.0D0*(PL(JJ)+WP(JJ))*EFFWC*(1.0D0-FDEP(JJ))*NPOR(JJ)
          ALMW(J)=WVOL*ALHMAC(J,IC)*BDH(JJ)    !why not +? Liwang Ma, 3-27-2009
          THMSW(J,IC)=THSMS(J,IC)*WVOL
   40   CONTINUE
C       END IF
C
        CRONEW=CRO(I,IC)
        ROB=0.0D0
        EXCESS=0.0D0
        EXCHEM=0.0D0
        MFBLC=0.0D0
C
C       ..IF NO RUNOFF AT THIS STEP THEN DON'T DO MACROPORE FLOW
        IF(RO.GT.0.0D0) THEN
          FCTR1=SQRT(2.0D0*SWF(1))
          DTIM=TR(I)
          IF(I.GT.1) DTIM=TR(I)-TR(I-1)
C
C         ..IF COLUMN IS FULLY SATURATED, PUT EXCESS INTO R/O AND EXIT
          IF(ISAT.EQ.1.AND.ITBL.EQ.1) THEN
            EXCESS=EXCESS+RO
            EXCHEM=EXCHEM+RO*CRONEW
            ROB=0.0D0
            MFBLC=0.0D0
            GOTO 80
          ENDIF
C
C         ------------------------------------------------------------------
C
C         ..CALCULATE MIXING ALONG WALLS AND INTO D.E. M.P. ABOVE FRONT
C
          I2=ID-1
          I2=MIN(I2,INT(H2OT2)+1)
          DO 50 J=1,I2
            JJ=IT2H(J)
            JK=NDXT2N(J)
            FLXMXA=FLXMAX(JJ)*DTIM*(1.0D0-FDEP(JJ))
            IF(J.EQ.1) THEN
              IF(FLXMXA.GT.RO) FLXMXA=RO
              MFBLC=FLXMXA
              ROB=RO-MFBLC
            ENDIF
            IF(MFBLC.GT.FLXMXA) THEN
              DEXCES=(MFBLC-FLXMXA)
              EXCHEM=EXCHEM+DEXCES*CRONEW
              EXCESS=EXCESS+DEXCES
              MFBLC=FLXMXA
            ENDIF
C
C           .. ACCUMULATE IF BREAKTHROUGH LAYER
            IF(J.EQ.IBRK+1) THEN
              BRKMAS(IC)=BRKMAS(IC)+MFBLC*CRONEW
              IF(IC.EQ.1) BRKWAT=BRKWAT+MFBLC
            ENDIF
C
            IF(RFD.GE.RFDD.AND.J.EQ.I2) THEN
              THSV=THSMS(JK,IC)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
              THMS=(porav(j)-CORR+BDH(JJ)*ALH(JK,IC))*(1.D0-
     +            MICP(JJ))
c              THMS=(SOILHP(6,JJ)*AEF-CORR+BDH(JJ)*ALH(JJ,IC))*(1.D0-
c     +            MICP(JJ))
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
              THMSW(JK,IC)=(THMSW(JK,IC)/THSV)*THMS
            ENDIF
C
            IF(MFBLC.GT.0.0D0.AND.ALH(JK,IC).EQ.0) THEN
              CMASW(J,IC)=CMESO(J,IC)*THMSW(JK,IC)+CMASW(J,IC)
              CRONEW=(CRONEW*MFBLC+CMASW(J,IC))/(MFBLC+THMSW(JK,IC))
              CMESO(J,IC)=(CMESO(J,IC)*(THSMS(JK,IC)-THMSW(JK,IC))+
     +            CRONEW*THMSW(JK,IC))/THSMS(JK,IC)
              IF(CRONEW.LT.1.0D-60) CRONEW=0.0D0
              CMASW(J,IC)=0.D0
            ELSEIF(ALMW(JK).NE.0.0D0) THEN
              CRONEW=(CRONEW*MFBLC+CMASW(J,IC))/(MFBLC+ALMW(JK))
              CMASW(J,IC)=ALMW(JK)*CRONEW
            ELSE
              CRONEW=0.0D0
              CMASW(J,IC)=0.0D0
            ENDIF
            IF(DBET(J).LT.DB(JJ)) THEN
              DEF=DB(JJ)-DBET(J)
              IF(MFBLC.LE.DEF) THEN
                DBET(J)=DBET(J)+MFBLC
                CDBET(J,IC)=CDBET(J,IC)+MFBLC*CRONEW
                MFBLC=0.0D0
              ELSE
                DBET(J)=DB(JJ)
                MFBLC=MFBLC-DEF
                CDBET(J,IC)=CDBET(J,IC)+DEF*CRONEW
              ENDIF
            ENDIF
            IF(MFBLC.LE.0.0D0) GOTO 80
   50     CONTINUE
          IF(ISAT.EQ.1) GOTO 110
C
C         ---------------------------------------------------------------------
C
C         ..CALCULATE FLOW FROM M.P. TO SOIL AND INTO D.E. M.P. BELOW
C         FRONT AND WITHIN HORIZONS CONTAINING M.P.
C
          I1=I2+1
          NSL1=NSL(NHCMP)
          I2=MIN(NSL1,INT(H2OT2)+1)
          DO 60 J=I1,I2
            JJ=IT2H(J)
            JK=NDXT2N(J)
            FLXMXA=FLXMAX(JJ)*DTIM*(1.0D0-FDEP(JJ))
            IF(MFBLC.GT.FLXMXA) THEN
              DEXCES=(MFBLC-FLXMXA)
              EXCHEM=EXCHEM+DEXCES*CRONEW
              EXCESS=EXCESS+DEXCES
              MFBLC=FLXMXA
            ENDIF
C
C           .. ACCUMULATE IF BREAKTHROUGH LAYER
            IF(J.EQ.IBRK+1) THEN
              BRKMAS(IC)=BRKMAS(IC)+MFBLC*CRONEW
              IF(IC.EQ.1) BRKWAT=BRKWAT+MFBLC
            ENDIF
            FCTR1=SQRT(2.0D0*SWF(JK))
            FCTR2=TWOPI*RP(JJ)*NPOR(JJ)
            FCTR22=FCTR2*DSQRT(DTIM)
            CHH=SOILHP(4,JJ)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
	        wss=porav(j)
c            WSS=SOILHP(6,JJ)*AEF
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            IF(MFBLC.GT.0.0D0) THEN
              CRONEW=(CRONEW*MFBLC+CMASW(J,IC))/(MFBLC+ALMW(JK))
              CMASW(J,IC)=ALMW(JK)*CRONEW
              IF(CMASW(J,IC).LT.1.0D-60) CMASW(J,IC)=0.0D0
              IF(CRONEW.LT.1.0D-60) CRONEW=0.0D0
            ENDIF
            DEF=WSS-VWC(J)
C
            IF(DEF.GT.0.0D0) THEN
              SATUR=DEF*(1.0D0-FDEP(JJ))
              SATURD=SATUR
              IF(FDEP(JJ).LT.1.0D0) SATURD=SATUR*FDEP(JJ)/(1.0D0-
     +            FDEP(JJ))
C
C             ..CALCULATE CONTINUOUS M.P. FLOW TO SOIL
              IF(MFBLC.GT.0.0D0) THEN
                IF(FLOW(J).LE.0.0D0) THEN
                  SORPT=FCTR1*SQRT(DEF*CHH)
                  V=SORPT*FCTR22*(1.0D0-FDEP(JJ))
                ELSE
                  RWF=SQRT(FLOW(J)/(PI*DEF*NPOR(JJ)*(1.0D0-FDEP(JJ)))+
     +                RP(JJ)**2.0D0)
                  V=TWOPI*CHH*SWF(JK)/LOG(RWF/RP(JJ))
                  V=V*DTIM*NPOR(JJ)*(1.0D0-FDEP(JJ))
                ENDIF
                V=V*SFCT
                IF((FLOW(J)+V).GT.SATUR) V=SATUR-FLOW(J)
                IF(V.GT.MFBLC) V=MFBLC
                IF(V.LE.0.D0) V=0.D0
                MFBLC=MFBLC-V
                FLOW(J)=FLOW(J)+V
                CFLOW(J,IC)=CFLOW(J,IC)+V*CRONEW
C
C               ..UPDATE CHEMS
                WCAB=VWC(J)+ALH(JK,IC)*BDH(JJ)
                CMESO(J,IC)=(CMESO(J,IC)*WCAB+V*CRONEW)/(WCAB+V)
                CONC(J,IC)=CMESO(J,IC)
                IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CONC(J,IC)
C
C               ..UPDATE TEMPERATURE
                IF(IC.EQ.1) THEN
                  TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
                  TFLO=0.0D0
                  TFLI=V*CW*1.0D3
                  DENT=((VWC(J)+V)*CW+CSHD(JJ))*1.0D3
                  TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+TEMPR*TFLI)/DENT
                ENDIF
C
C               ..UPDATE WATER
                VWC(J)=VWC(J)+V
              ENDIF
C
C             ..CALCULATE DEAD END M.P. FLOW TO SOIL (cylinder pores)
              IF(MFBLC.GT.0.0D0.AND.FDEP(JJ).GT.0.0D0) THEN
                IF(DFLOW(J).LE.0.0D0) THEN
                  SORPT=FCTR1*SQRT(DEF*CHH)
                  V=SORPT*FCTR22*FDEP(JJ)
                ELSE
                  RWFD=SQRT(DFLOW(J)/(PI*DEF*NPOR(JJ)*FDEP(JJ))+RP(JJ)**
     +                2.0D0)
                  V=TWOPI*CHH*SWF(JK)/LOG(RWFD/RP(JJ))
                  V=V*DTIM*NPOR(JJ)*FDEP(JJ)
                ENDIF
                V=V*SFCT
                IF((DFLOW(J)+V).GT.SATURD) V=SATURD-DFLOW(J)
                IF(V.GT.MFBLC) V=MFBLC
                IF(V.LE.0.D0) V=0.D0
                MFBLC=MFBLC-V
                DFLOW(J)=DFLOW(J)+V
                IF(V+DBET(J).GT.0) THEN
                  AVGC=(CDBET(J,IC)+V*CRONEW)/(V+DBET(J))
                ENDIF
                CDFLOW(J,IC)=CDFLOW(J,IC)+V*AVGC
                CDBET(J,IC)=DBET(J)*AVGC
C
C               ..UPDATE CHEMS
                WCAB=VWC(J)+ALH(JK,IC)*BDH(JJ)
                CMESO(J,IC)=(CMESO(J,IC)*WCAB+V*AVGC)/(WCAB+V)
                CONC(J,IC)=CMESO(J,IC)
                IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CONC(J,IC)
C
C               ..UPDATE TEMPERATURE
                IF(IC.EQ.1) THEN
                  TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
                  TFLO=0.0D0
                  TFLI=V*CW*1.0D3
                  DENT=((VWC(J)+V)*CW+CSHD(JJ))*1.0D3
                  TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+TEMPR*TFLI)/DENT
                ENDIF
C
C               ..UPDATE WATER
                VWC(J)=VWC(J)+V
C
C               ..CALCULATE AMOUT OF WATER AND CHEM. IN D.E. M.P.
                IF(DBET(J).LT.DB(JJ)) THEN
                  DEFD=DB(JJ)-DBET(J)
                  IF(MFBLC.LE.DEFD) THEN
                    DBET(J)=DBET(J)+MFBLC
                    CDBET(J,IC)=CDBET(J,IC)+MFBLC*CRONEW
                    MFBLC=0.0D0
                  ELSE
                    DBET(J)=DB(JJ)
                    MFBLC=MFBLC-DEFD
                    CDBET(J,IC)=CDBET(J,IC)+CRONEW*DEFD
                  ENDIF
                ENDIF
C
              ENDIF
C
              IF(MFBLC.LE.0.0D0) GOTO 80
            ENDIF
C
   60     CONTINUE
C         ------------------------------------------------------------------
C
C         ..CALCULATE FLOW FROM M.P. TO SOIL IN LAYERS BELOW FRONT WITH CRACKS
C
          IF(MFBLC.GT.0.AND.ID.NE.NSLT+1) THEN
            IF(ID.LE.NSL(NHCMP)) I1=I2+1
            IF(ID.GT.NSL(NHCMP)) I1=ID
            I2=MIN(NSLT,INT(H2OT2)+1)
            DO 70 J=I1,I2
              JJ=IT2H(J)
              JK=NDXT2N(J)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
              wss=porav(j)
c              WSS=SOILHP(6,JJ)*AEF
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
              CHH=SOILHP(4,JJ)
              SWFF=SWF(JK)
              FLXMXA=FLXMAX(JJ)*DTIM*(1.0D0-FDEP(JJ))
              IF(MFBLC.GT.FLXMXA) THEN
                DEXCES=(MFBLC-FLXMXA)
                EXCHEM=EXCHEM+DEXCES*CRONEW
                EXCESS=EXCESS+DEXCES
                MFBLC=FLXMXA
              ENDIF
C
C             .. ACCUMULATE IF BREAKTHROUGH LAYER
              IF(J.EQ.IBRK+1) THEN
                BRKMAS(IC)=BRKMAS(IC)+MFBLC*CRONEW
                IF(IC.EQ.1) BRKWAT=BRKWAT+MFBLC
              ENDIF
              DEF=WSS-VWC(J)
              IF(MFBLC.GT.0.0D0) THEN
                CRONEW=(CRONEW*MFBLC+CMASW(J,IC))/(MFBLC+ALMW(JK))
                CMASW(J,IC)=CRONEW*ALMW(JK)
                IF(CMASW(J,IC).LT.1.0D-60) CMASW(J,IC)=0.0D0
              ENDIF
C
C             ..CALCULATE CONTINUOUS M.P. FLOW TO SOIL
              IF(DEF.GT.0.0D0) THEN
                TFLOW(J)=TFLOW(J)+DTIM
                SATUR=DEF*(1.0D0-FDEP(JJ))
                SATURD=DEF*FDEP(JJ)
                SORPT=SQRT(2.0D0*SWFF*CHH*DEF)
                SORPT=SORPT*SFCT
                Q=SORPT*SQRT(TFLOW(J))*NPOR(JJ)*(WP(JJ)+PL(JJ))*2.0D0*(
     +              1.0D0-FDEP(JJ))
                IF(Q.GT.SATUR) Q=SATUR
                IF(Q.LE.0.D0) Q=0.D0
                V=Q-FLOW(J)
                IF(V.GT.MFBLC) V=MFBLC
                IF(V.LE.0.D0) V=0.D0
                MFBLC=MFBLC-V
                FLOW(J)=FLOW(J)+V
                CFLOW(J,IC)=CFLOW(J,IC)+V*CRONEW
                IF(SORPT.GT.0) THEN
                  TFLOW(J)=(FLOW(J)/(SORPT*NPOR(JJ)*(WP(JJ)+PL(JJ))*(
     +                1.0D0-FDEP(JJ))*2.0D0))**2.0D0
                ENDIF
C
C               ..UPDATE CHEMS
                WCAB=VWC(J)+ALH(JK,IC)*BDH(JJ)
                CMESO(J,IC)=(CMESO(J,IC)*WCAB+V*CRONEW)/(WCAB+V)
                CONC(J,IC)=CMESO(J,IC)
                IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CONC(J,IC)
C
C               ..UPDATE TEMPERATURE
                IF(IC.EQ.1) THEN
                  TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
                  TFLO=0.0D0
                  TFLI=V*CW*1.0D3
                  DENT=((VWC(J)+V)*CW+CSHD(JJ))*1.0D3
                  TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+TEMPR*TFLI)/DENT
                ENDIF
C
C               ..UPDATE WATER
                VWC(J)=VWC(J)+V
C
                IF((MFBLC.LE.0.0D0).or.(fdep(jj).eq.0.0d0)) GOTO 80
C
C               ..CALCULATE DEAD END M.P. FLOW TO SOIL (Cracks below)
                TDFLOW(J)=TDFLOW(J)+DTIM
                QD=SORPT*SQRT(TDFLOW(J))*(WP(JJ)+PL(JJ))*NPOR(JJ)*
     +              FDEP(JJ)*2.0D0
                IF(QD.GT.SATURD) QD=SATURD
                VD=QD-DFLOW(J)
                IF(VD.GT.MFBLC) VD=MFBLC
                IF(VD.LE.0.D0) VD=0.D0
                MFBLC=MFBLC-VD
                DFLOW(J)=DFLOW(J)+VD
c                IF((SORPT.GT.0.0d0).and.(fdep(jj).gt.0.0d0)) THEN  !to prevent NaN for tdflow when fdep=0, why TDFLOW is different from RWFD for cylinder pores?
                IF(SORPT.GT.0.0d0) THEN  !to prevent NaN for tdflow when fdep=0, why TDFLOW is different from RWFD for cylinder pores?
                  TDFLOW(J)=(DFLOW(J)/(SORPT*NPOR(JJ)*(WP(JJ)+PL(JJ))*
     +                FDEP(JJ)*2.0D0))**2.0D0
                ENDIF
                AVGC=0.0D0
                IF(VD+DBET(J).GT.0) THEN
                  AVGC=(CDBET(J,IC)+VD*CRONEW)/(VD+DBET(J))
                ENDIF
                CDFLOW(J,IC)=CDFLOW(J,IC)+VD*AVGC
                CDBET(J,IC)=DBET(J)*AVGC
C
C               ..UPDATE CHEMS
                WCAB=VWC(J)+ALH(JK,IC)*BDH(JJ)
                CMESO(J,IC)=(CMESO(J,IC)*WCAB+VD*AVGC)/(WCAB+VD)
                CONC(J,IC)=CMESO(J,IC)
                IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CONC(J,IC)
C
C               ..UPDATE TEMPERATURE
                IF(IC.EQ.1) THEN
                  TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
                  TFLO=0.0D0
                  TFLI=VD*CW*1.0D3
                  DENT=((VWC(J)+VD)*CW+CSHD(JJ))*1.0D3
                  TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+TEMPR*TFLI)/DENT
                ENDIF
C
C               ..UPDATE WATER
                VWC(J)=VWC(J)+VD
C
                IF((MFBLC.LE.0.0D0).or.(fdep(jj).eq.0.0d0)) GOTO 80
C
C               ..CALCULATE AMOUT OF WATER AND CHEM. IN D.E. M.P.
                IF(DBET(J).LT.DB(JJ)) THEN
                  DEFD=DB(JJ)-DBET(J)
                  IF(MFBLC.LE.DEFD) THEN
                    DBET(J)=DBET(J)+MFBLC
                    CDBET(J,IC)=CDBET(J,IC)+MFBLC*CRONEW
                    MFBLC=0.0D0
                  ELSE
                    DBET(J)=DB(JJ)
                    MFBLC=MFBLC-DEFD
                    CDBET(J,IC)=CDBET(J,IC)+DEFD*CRONEW
                  ENDIF
                ENDIF
                IF(MFBLC.LE.0.) GOTO 80
              ENDIF
   70       CONTINUE
          ENDIF
        ENDIF
   80   CONTINUE
C
C       .. ACCUMULATE IF BREAKTHROUGH LAYER
        IF(J.EQ.IBRK+1) THEN
          BRKMAS(IC)=BRKMAS(IC)+MFBLC*CRONEW
          IF(IC.EQ.1) BRKWAT=BRKWAT+MFBLC
        ENDIF
C
C       .. IF APPROPRIATE, RAISE WATER TABLE
C===========================================
        IF(ITBL.EQ.1.AND.INT(H2OT2).GT.0.AND.MFBLC.GT.0.0D0) THEN
C
C         .. IF THERE ARE DRAINS TAKE OUT EXPRESS PORTION OF WATER AND CHEM
          IF(IDRAIN.EQ.1) THEN
            XPRESWAT = MFBLC * XPRESF
            MFBLC = MFBLC - XPRESWAT
            XPRESCHEM(IC) = CRONEW
          ENDIF
          H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
C
C         .. BACK UP FROM THE TOP OF WATERTABLE AND WET UP
          DO 90 J=INT(H2OT2),ID,-1
            NH=IT2H(J)
            NK=NDXT2N(J)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
c            WSH = SOILHP(6, NH) * AEF
            WSH = PORAV(J)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
            DEF=WSH-VWC(J)
            DEF=MAX(DEF,0.0D0)
            IF(DEF.LT.1.D-12) DEF=0.0D0
            IF(MFBLC-DEF.LT.0) THEN
              DEF=MFBLC
              MFBLC=0.0D0
            ELSE
              MFBLC=MFBLC-DEF
            ENDIF
            WCAB=VWC(J)+ALH(NK,IC)*BDH(NH)
            CMESO(J,IC)=(CMESO(J,IC)*WCAB+CRONEW*DEF)/(WCAB+DEF)
            IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CMESO(J,IC)
            CONC(J,IC)=CMESO(J,IC)
C
C           ..UPDATE TEMPERATURE
            IF(IC.EQ.1) THEN
              TCUR=(VWC(J)*CW+CSHD(NH))*1.0D3
              TFLI=DEF*CW*1.0D3
              TEMP(J)=(TEMP(J)*TCUR+TEMPR*TFLI)/(TCUR+TFLI)
            ENDIF
C
C           ..UPDATE WATER
            VWC(J)=VWC(J)+DEF
            IF(MFBLC.EQ.0.0D0) GOTO 100
   90     CONTINUE
        ENDIF
  100   H2OT2=DBLE(IFINDWT(VWC,SOILHP,NSLT,MAXHOR))
C
C       ..PUT LEFTOVERS INTO BOTTOM "CUP" OR BACK INTO RUNOFF
  110   IF(ITBL.EQ.0) THEN
          CUPCHM(IC)=CUPCHM(IC)+MFBLC*CRONEW
          IF(IC.EQ.1) THEN
            CUPRO=CUPRO+MFBLC
            CDNHT=CDNHT+TEMPR*MFBLC*CW*1.0D3
          ENDIF
        ELSE
C          CUPCHM(IC)=CUPCHM(IC)+MFBLC*CRONEW
          EXCHEM=EXCHEM+MFBLC*CRONEW
          IF(IC.EQ.1) EXCESS=EXCESS+MFBLC
        ENDIF
C============================================================
C
        IF(I.EQ.1) THEN
          CUMCLR(I,IC)=CRO(I,IC)*ROB+EXCHEM
          CUMCLM(I,IC)=CRO(I,IC)*(RO-ROB)-EXCHEM
          CMACSEP(I,IC)=MFBLC*CRONEW
          WMACSEP(I)=MFBLC
          IF(IC.EQ.1) THEN
            CUMRO(I)=ROB+EXCESS
            CUMMF(I)=RO-ROB-EXCESS
          ENDIF
        ELSE
          CUMCLR(I,IC)=CUMCLR(I-1,IC)+CRO(I,IC)*ROB+EXCHEM
          CUMCLM(I,IC)=CUMCLM(I-1,IC)+CRO(I,IC)*(RO-ROB)-EXCHEM
          CMACSEP(I,IC)=CMACSEP(I-1,IC)+MFBLC*CRONEW
          WMACSEP(I)=WMACSEP(I-1)+MFBLC
          IF(IC.EQ.1) THEN
            CUMRO(I)=CUMRO(I-1)+ROB+EXCESS
            CUMMF(I)=CUMMF(I-1)+RO-ROB-EXCESS
          ENDIF
        ENDIF
C       WRITE(9,'(A5,I5,10F10.5)')' MPFLO',I,CUMMF(I),CUMRO(I),CUPRO,
C       1                  MFBLC,RO,ROB,EXCESS
C
        IF(ID.EQ.NSLT+1) THEN
          CMESO(ID,IC)=0.0D0
          CMICR(ID,IC)=0.0D0
          CONC(ID,IC)=0.0D0
        ENDIF
C
C     ENDIF
  120 CONTINUE
C
      RETURN
      END
C
      SUBROUTINE UGFLOW(I,ID,NSLT,VWC,TR,ALH,BDH,CONC,UGSEEP,TEMP,CSHD,
     +    CW,CDNHT,MICP,pori,porav,Hmin)
C======================================================================
C
C       PURPOSE:  THIS SUBROUTINE ACCOUNTS FOR UNIT GRADIENT FLOW AND
C             INTERACTIONS WITH SOIL MATRIX, OF WATER AND CHEMICALS
C
C
C       REF:  AHUJA, LAJ; USDA-ARS
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       CDNCHM    I/O CHEMICAL SEEPAGE OUT BOTTOM OF PROFILE [UG]
C       CDNHT I/O HEAT LOST OUT BOTTOM OF PROFILE
C       CMESO I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR I/O CHEMICAL CONC. IN MICROPORES [MG/L]
C       CONC  I/O CHEM. CONC. IN SOIL WATER OF EACH SOIL NODE
C                 SAME AS CC [MG/L]
C       CSHD   I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       TCUR   L  CURRENT TEMPERATURE ENERGY
C       CW         I  VOLUMETRIC HEAT CAPACITY OF WATER [J/MM^3/C]
C       DENT   L  FACTOR IN TEMPERATURE CALC.
C       DTIM   L  TIME STEP [HR]
C       TFLI   L  TEMPERATURE FLUX MOVING IN
C       TFLO   L  TEMPERATURE FLUX MOVING OUT
C       H      I  NODAL SOIL WATER PRESSURE HEADS [CM]
C       HKL        L  HYDROLIC CONDUCTIVITY OF LAYER [CM/HR]
C       HTMP   L  TEMPORARY PRESSURE HEAD VARIABLE
C       I      I  INDEX VARIABLE
C       IC         L  INDEX VARIABLE
C       ID         I  INDEX VARIABLE (DEPTH)
C       J      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       JK         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C       NSLT   I  PROFILE DEPTH [CM]
C       OCMSO  L  OLD CMESO VALUE
C       OPCMSO     L  PREVIOUS OLD CMESO VALUE
C       OPTEMP     L  PREVIOUS OLD TEMPERATURE VALUE
C       OTEMP  L  OLD TEMPERATURE VALUE
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       TEMP  I/O TEMPERATURE OF LAYER (C)
C       TR         I  CUMMULATIVE TIME OF RAINFALL [HR]
C       UGSEEP    I/O SEEPAGE OUT BOTTOM OF PROFILE DO TO UG FLOW
C       VWC       I/O MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C       WTMP   L  TEMPORARY WATER CONTENT VARIABLE
C
C       COMMENTS:
C
C       CALLED FROM:  INFIL
C
C       PROGRAMMER:  DR. L. AHUJA AND K.E. JOHNSEN
C
C       VERSION:   2.15
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12,MXCHEM=15)
      PARAMETER(MXTSTP=5000)  !,HMIN=-35000.0D0)
C
C     .. EFFECTIVE SATURATED DARCIAN FLOW PERCENTAGE THRESHOLD
      PARAMETER(EFFDAR=1.0D-1)
C ----------------------------------------------------------------------
      COMMON /HYDROL/ AEF,BOTFLX,DRDEP,DRSPAC,DRRAD,CLAT(MAXHOR),
     +    H(MXNOD),HKBAR(MXNOD),QF(MXNOD),SOILHP(13,MAXHOR),HFC,HWP,
     +    THETA(MXNOD),thetai(mxnod),RICH_EPS,IREBOT,ITBL,IDRAIN,
     +    MAXITER_RICH,MAXCYCLE_RICH
      COMMON /OPCHEM/ THSMS(MXNOD,MXCHEM),CUPRO,CUPCHM(MXCHEM),CDNCI,
     +    CDNCHM(MXCHEM),CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),
     +    CRO(MXTSTP,MXCHEM)
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
      DOUBLE PRECISION MICP(MAXHOR),HKL(MXNODT),VWC(mxnodt),TR(mxnodt),
     +    ALH(MXnod,MXCHEM),BDH(MAXHOR),CONC(mxnodt,MXCHEM),
     +    TEMP(mxnodt),CSHD(MAXHOR),pori(mxnod),porav(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
      IF(I.EQ.1) THEN
        DTIM=TR(I)
      ELSE
        DTIM=TR(I)-TR(I-1)
      ENDIF
C
      JJ=IT2H(ID)
      JK=NDXT2N(ID)
C
C     .. DETERMINE THE MINIMUM THETA FOR THIS CHUNK
      TFLOOR=WC(HMIN,SOILHP(1,JJ),JJ,0)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
c      WTMP = MIN(VWC(ID), SOILHP(6, JJ) * AEF)
      WTMP = MIN(VWC(ID), PORAV(ID))
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C     .. FIND HEAD AT CURRENT WATER CONTENT
      HTMP=WCH(H(JK),WTMP,SOILHP(1,JJ),JJ,0)
C
C     .. ACTUAL DARCY FLUX FOR THIS LAYER
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     kej,ma
c     jak
      HKL(ID)=POINTK(HTMP,SOILHP(1,JJ),JJ,porav(id))*DTIM
C     .. HAVE TO LIMIT DARCY FLUX TO EFFDAR(SATURATION)
c      IF(HKL(ID).GT.(EFFDAR*SOILHP(6,JJ)*AEF)) HKL(ID)=
c    +    POINTK(HMIN,SOILHP(1,JJ),JJ)*DTIM
c ma  - ken
	IF (HKL(ID) .GT. (EFFDAR * porav(id)))
     +  HKL(ID) = POINTK(HMIN,SOILHP(1, JJ),JJ,porav(id)) * DTIM
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
C     IF (VWC(ID) .GT. SOILHP(6, JJ) * AEF) HKL(ID) =
C     +    MAX(HKL(ID), VWC(ID) - SOILHP(6, JJ) * AEF)
C
      VWC(ID)=MAX(TFLOOR,(VWC(ID)-HKL(ID)))
C
      DO 20 IC=1,MXCHEM
C
        OCMSO=CMESO(ID,IC)
        OTEMP=TEMP(ID)
C       ----------------------------------------------------------------------
C       CALCULATE NEW CHEMICAL CONC.
C       ----------------------------------------------------------------------
        DO 10 J=ID+1,NSLT
          JJ=IT2H(J)
          JK=NDXT2N(J)
          TFLOOR=WC(HMIN,SOILHP(1,JJ),JJ,0)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c          WTMP = MIN(VWC(J), SOILHP(6, JJ) * AEF)
          WTMP = MIN(VWC(J), PORAV(J))
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
          HTMP=WCH(H(JK),WTMP,SOILHP(1,JJ),JJ,0)
C
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     gnf
c     jak
          HKL(J)=POINTK(HTMP,SOILHP(1,JJ),JJ,porav(j))*DTIM
c          IF(HKL(J).GT.(EFFDAR*SOILHP(6,JJ)*AEF)) HKL(J)=
c     +        POINTK(HMIN,SOILHP(1,JJ),JJ)*DTIM
          IF (HKL(J) .GT. (EFFDAR * PORav(J)))
     +		HKL(J) = POINTK(HMIN,SOILHP(1, JJ),JJ,porav(j)) * DTIM
C
C         IF (VWC(J) .GT. SOILHP(6, JJ) * AEF) HKL(J) =
C         +      MAX(HKL(J), VWC(J) - SOILHP(6, JJ) * AEF)
          IF (VWC(J)-HKL(J)+HKL(J - 1) .GT. porav(j))
     +       HKL(J) = HKL(J-1) + VWC(J) - porav(j)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee

          IF(VWC(J)-HKL(J)+HKL(J-1).LT.TFLOOR) 
     +          HKL(J)=VWC(J)+HKL(J-1)-TFLOOR
C
C         DISTRIBUTE THE CHEMICALS
          IF(CMESO(J,IC).NE.0.0D0) CMESO(J,IC)=
     +        MAX(CMESO(J,IC),1.0D-60)
          OPCMSO=OCMSO
          OCMSO=CMESO(J,IC)
          CMESO(J,IC)=(CMESO(J,IC)*(VWC(J)+ALH(JK,IC)*BDH(JJ)-HKL(J))+
     +        OPCMSO*HKL(J-1))/(VWC(J)+ALH(JK,IC)*BDH(JJ)+HKL(J-1)-
     +        HKL(J))
C
C         ..UPDATE TEMPERATURE
          IF(IC.EQ.1) THEN
            OPTEMP=OTEMP
            OTEMP=TEMP(J)
            TCUR=(VWC(J)*CW+CSHD(JJ))*1.0D3
            TFLO=HKL(J)*CW*1.0D3
            TFLI=HKL(J-1)*CW*1.0D3
            DENT=((VWC(J)-HKL(J)+HKL(J-1))*CW+CSHD(JJ))*1.0D3
            TEMP(J)=(TEMP(J)*TCUR-TEMP(J)*TFLO+OPTEMP*TFLI)/DENT
          ENDIF
          IF(IC.EQ.MXCHEM) VWC(J)=MAX(TFLOOR,(VWC(J)-HKL(J)+HKL(J-1)))
          IF(CMESO(J,IC).LT.0.0D0) THEN
            WRITE(9,*) ' CALC OF CMESO PRODUCED NEG (UGFLOW) ',
     +          CMESO(J,IC)
          ENDIF
C
          IF(MICP(JJ).GT.0.0D0) CMICR(J,IC)=CMESO(J,IC)
          CONC(J,IC)=CMESO(J,IC)
   10   CONTINUE
C
        CDNCHM(IC)=CDNCHM(IC)+HKL(NSLT)*OCMSO
        IF(IC.EQ.1) THEN
          UGSEEP=UGSEEP+HKL(NSLT)
          CDNHT=CDNHT+OTEMP*HKL(NSLT)*CW*1.0D3
        ENDIF
C
   20 CONTINUE
C
      RETURN
      END
C
C
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
      SUBROUTINE KNETIC(ID,DELT,IC,X2CONC,AEF,CORR,SOILHP,porav)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C======================================================================
C
C       PURPOSE: CALCULATES KINETIC ADSORPTION/RELEASE OF A PESTICIDE
C    FROM SOIL TO SOLUTION PHASE.  THE ADSORBED PESTICIDE IS ASSUMED TO
C    EXIST IN TWO FORMS - ONE THAT IS IN INSTANTANEOUS EQUILIBRIUM WITH
C    SOLUTION AND THE SECOND THAT EQUILIBRIATES OVER A DAY.  WE DEAL
C    HERE WITH KINETIC RELEASE OF THE SECOND FORM FOR A SINGLE CHEMICAL.
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       AEF        I  FIELD SATURATION FRACTION [0..1]
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       ALK        L  CURRENT KD
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       BDK        L  CURRENT BULK DENSITY
C       CMESO I/O CHEMICAL CONC. IN MESOPORES [MG/L]
C       CMICR I/O CHEMICAL CONC. IN MICROPORES [MG/L]
C       CORR   I  AMT. OF INFILTRATION CORRECTION FOR OVERSHOOTING
C                 THE TOTAL RAINFALL AMOUNT [CM]
C       DEFF   L
C       DELEQ  L
C       DELT   I  INCREMENTAL TIME STEP [HR]
C       DELX2  L
C       DELX3  L
C       EK2        I  EQUIL.CONST. FOR ADSORPTION [CM3 H2O/G SOIL]
C       EQCC   L  EQUIL. CHEMICAL IN CURRENT SOIL LAYER
C       IC         I  INDEX VARIABLE
C       ID         I  INDEX VARIABLE (DEPTH)
C       IP         L  INDEX FOR PESTICIDE NUMBER
C       J      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       KK         L  INDEX VARIABLE
C       MAXBP  P  MAXIMUM NUMBER OF BREAK POINTS IN A RAINSTORM
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXPEST     P  MAXIMUM NUMBER OF PESTICIDES
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C       RDIF   I  PESTICIDE DIFFUSION RATE [CM^2/HR]
C       RFD        I  CURRENT RAINFALL DEPTH [CM]
C       RFDD   I  TOTAL RAINFALL DEPTH [CM]
C       RK2        I  KINETIC CONST FOR RELEASE OF PEST FROM
C                 ABSORBTION SITE
C       SOILHP     I  MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       T1         L  STARTING TIME [DAYS]
C       WCMC   L  WATER CONTENT IN MICROPORES
C       WCMS   L  WATER CONTENT IN MESOPORES
C       WSHK   L  SAT. WATER CONTENT OF CURRENT LAYER
C       X2CONC    I/O PEST. CONC. INVOLVED IN KNETIC PROCESSES [UG/G SOIL]
C
C       COMMENTS:   MESOPORE AND MICROPORE CONCENTRATIONS ARE LIMITED
C               TO 1.0D-99, TO AVOID UNDERFLOW CONDITIONS
C
C       EXTERNAL REFERENCES:
C                 IT2H
C
C       CALLED FROM:  UNSATFLO
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MAXBP=50,MXNOD=300,MXNODT=3001,MAXHOR=12,MXPEST=3,
     +    MXCHEM=15)
      PARAMETER(MXTSTP=5000)
C
C
C   ...COMMON SPACE FOR INFILTRATION AND EVENT-TRANSPORTATION
C
C ----------------------------------------------------------------------
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
C ----------------------------------------------------------------------
      DOUBLE PRECISION MICP
      COMMON /OPINF/ RO,SWF(MXnod),TR(MXTSTP),CI(MXTSTP),CRFD(MAXBP),
     +    CRFT(MAXBP),RFI(MAXBP),RFDD,RFD
      COMMON /OPCHEM/ THSMS(MXNOD,MXCHEM),CUPRO,CUPCHM(MXCHEM),CDNCI,
     +    CDNCHM(MXCHEM),CMESO(MXNODT,MXCHEM),CMICR(MXNODT,MXCHEM),
     +    CRO(MXTSTP,MXCHEM)
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      COMMON /KNTCS/ CONCX2(MXNOD,MXPEST),EK2(MXNOD,MXPEST),
     +    RK2(MXPEST),RDIF(MXPEST),FEK2(MXPEST),IEK2(MXPEST)
C
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
      DIMENSION X2CONC(MXNODT,MXPEST),SOILHP(13,MAXHOR),porav(mxnodt)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C
      IP=IC-12
C
      DO 10 J=1,ID
        JJ=IT2H(J)
        KK=NDXT2N(J)
        IF(EK2(KK,IP).NE.0.0D0) THEN
          ALK=ALH(KK,IC)
          BDK=BDH(JJ)
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
c           WSHK = SOILHP(6, JJ) * AEF
          WSHK = PORAV(J)
c          IF (WSHK.LE.0.0D0) WSHK=PORAV(J-1)     !TO AVOID WSHK BECOMES NEGATIVE AT BOTTOM OF INFILTRAITON LAYER
          IF(J.EQ.ID.AND.RFD.GE.RFDD) WSHK=WSHK-CORR
          T1=WSHK+BDK*ALK
          WCMC=T1*MICP(JJ)
          IF(porav(j)*MICP(JJ).GT.WSHK) WCMC=T1
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
          WCMS=T1-WCMC
          IF(CMESO(J,IC).NE.0.0D0) CMESO(J,IC)=
     +        MAX(CMESO(J,IC),1.0D-60)
          IF(CMICR(J,IC).NE.0.0D0) CMICR(J,IC)=
     +        MAX(CMICR(J,IC),1.0D-60)
          IF(X2CONC(J,IP).NE.0.0D0) X2CONC(J,IP)=
     +        MAX(X2CONC(J,IP),1.0D-60)
C
C         ..PESTICIDE RELEASE FROM WITHIN MESOPORES
          IF(WCMS.GT.0.0D0) THEN
            EQCC=(CMESO(J,IC)*WCMS+X2CONC(J,IP)*BDK)/(WCMS+EK2(KK,IP)*
     +          BDK)
            DELEQ=(CMESO(J,IC)-EQCC)*WCMS/BDK
            DELX2=DELT*RK2(IP)*(EK2(KK,IP)*CMESO(J,IC)-X2CONC(J,IP))
            IF(ABS(DELX2).GT.ABS(DELEQ)) DELX2=DELEQ
            X2CONC(J,IP)=X2CONC(J,IP)+DELX2
            CMESO(J,IC)=CMESO(J,IC)-DELX2*BDK/WCMS
C
C           ..DIFFUSION FROM MICROPORES
            EQCC=(CMESO(J,IC)*WCMS+CMICR(J,IC)*WCMC)/T1
            DELEQ=(CMESO(J,IC)-EQCC)*WCMS
            DEFF=RDIF(IP)/(1.0D0+BDK*ALK/WSHK)
            DELX3=DELT*DEFF*(CMESO(J,IC)-CMICR(J,IC))
            IF(ABS(DELX3).GT.ABS(DELEQ)) DELX3=DELEQ
            IF(WCMC.GT.0.0D0) CMICR(J,IC)=CMICR(J,IC)+DELX3/WCMC
            CMESO(J,IC)=CMESO(J,IC)-DELX3/WCMS
          ENDIF
        ENDIF
   10 CONTINUE
C
C     ..RETURN TO CALLING ROUTINE
      RETURN
      END
C
      SUBROUTINE AVGRID(IC,A,B,THETA,VWC,ALH,BDH,IX2)
C
C======================================================================
C
C       PURPOSE:
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       A     I/O CONSTANT FOR NON-UNIFORM MIXING []
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       B      I  CONSTANT FOR NON-UNIFORM MIXING []
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       I      L  INDEX VARIABLE
C       IC         I  INDEX VARIABLE
C       IX2        I  VARIABLE TO INDICATE KINETICS 0=NO, 1=YES
C       JJ         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       N      L  INDEX VARIABLE
C                 RESISTANCE BETWEEN CANOPY AND MEASUREMENT HEIGHT
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NNT        I  NUMBER INTERIOR NODES IN INFILTRATION GRID
C       THETA  I  VOLUMETRIC WATER CONTENT [CM^3/CM^3]
C       TL         I  NUMERICAL LAYER THICKNESSES [CM]
C       TMASS  L  MASS SUMMATION VARIABLE
C       VWC        I  MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 IT2H
C
C       CALLED FROM:
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12,MXCHEM=15)
C
C
C=======================================================================
C
C     VARIABLES PERTAINING TO SYSTEM DISCRETIZATION
C
C-----------------------------------------------------------------------
C
      COMMON /GEOMTR/XLONG,ASPECT,DELZ(MXNOD),ELEV,HORTHK(MAXHOR),SLOPE,
     +    AREA,TL(MXNOD),TLT(MXNOD),XLAT,ZN(MXNOD),NHOR,NN,NNT
C
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      DIMENSION A(NN),B(mxnodt),THETA(NN),VWC(mxnodt),ALH(MXNOD,MXCHEM),
     +    BDH(MAXHOR)
C
      N=1
      TMASS=0.0D0
      IF(IX2.EQ.0) THEN
        DO 10 I=1,NNT-1
          JJ=IT2H(I)
          JK=NDXT2N(I)
          TMASS=TMASS+B(I)*(VWC(I)+ALH(JK,IC)*BDH(JJ))
          IF(NDXT2N(I+1).NE.N) THEN
            A(N)=TMASS/(TL(N)*(THETA(N)+ALH(JK,IC)*BDH(JJ)))
            TMASS=0.0D0
            N=N+1
          ENDIF
   10   CONTINUE
        TMASS=TMASS+B(NNT)*(VWC(NNT)+ALH(JK,IC)*BDH(JJ))
        A(N)=TMASS/(TL(N)*(THETA(N)+ALH(JK,IC)*BDH(JJ)))
        IF(A(N).LT.0.0D0)
     +    PRINT*,'NEGATIVE MASS IN AVGRID'
      ELSE
        DO 20 I=1,NNT-1
          JJ=IT2H(I)
          TMASS=TMASS+B(I)*BDH(JJ)
          IF(NDXT2N(I+1).NE.N) THEN
            A(N)=TMASS/(TL(N)*BDH(JJ))
            TMASS=0.0D0
            N=N+1
          ENDIF
   20   CONTINUE
        TMASS=TMASS+B(NNT)*BDH(JJ)
        A(N)=TMASS/(TL(N)*BDH(JJ))
        IF(A(N).LT.0.0D0)
     +    PRINT*,'NEGATIVE MASS IN AVGRID'
      ENDIF
C
C
C
      RETURN
      END
C
      SUBROUTINE INDEXR(A,B,C,NA,NB,NC)
C
C======================================================================
C
C       PURPOSE:  THIS SUBROUTINE SETS UP TWO INDEX VECTORS FOR LAYER
C             DEPTHS SUPPLIED THROUGH VECTORS A AND B. THE FIRST
C             INDEX VECTOR CONTAINS THE NUMBER OF B ELEMENTS
C             CONTAINED IN ONE ELEMENT DEPTH OF A.  WHILE THE SECOND
C             INDEX VECTOR DESCRIBES WHICH ELEMENT IN VECTOR A THAT
C             AN ELEMENT IN VECTOR B IS CONTAINED IN.
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       A      I  VECTOR OF LAYER DEPTHS, THERE WILL ALWAYS BE
C                 LESS VALUES IN THIS VECTOR THAN IN B
C       B      I  VECTOR OF LAYER DEPTHS.  THIS VECTOR WILL ALWAYS
C                 CONTAIN MORE VALUES THAN A
C       C
C       I      L  INDEX VARIABLE
C       J      L  INDEX VARIABLE
C       JN         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       NA         I  NUMBER OF ELEMENTS IN VECTOR A
C       NB         I  NUMBER OF ELEMENTS IN VECTOR B
C       NC         I  PROFILE DEPTH
C       NDXH2N    I/O INDEX FOR HORIZONS TO NUMERICAL LAYERS,
C                   IE. HOW MANY NUMERICAL LAYERS IN HORIZON.
C       NDXN2H    I/O INDEX FOR NUMERICAL LAYERS TO HORIZONS,
C                   IE. WHICH HORIZON IS NUMERICAL LAYER IN.
C       NDXN2T    I/O INDEX FOR NUMERICAL LAYER TO GREEN-AMPT GRID,
C                   IE. HOW MANY G-A GRIDS IN NUMERICAL LAYER
C       NDXT2N    I/O INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C
C       COMMENTS:  FOR AN EXAMPLE OF OPERATION:
C
C              ASSUME THAT A CONTAINS: 10,20,30    ; AND
C                      B CONTAINS: 2,4,12,14,25
C
C              THE RESULTANT INDEX VECTORS WOULD BE
C                 NDXA = 2,2,1  ; AND
C                 NDXB = 1,1,2,2,3
C
C       CALLED FROM:  INPUT
C
C       PROGRAMMER: KEN ROJAS
C
C       VERSION: 2.0
C
C======================================================================
C
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12)
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      DIMENSION A(NA),B(NB),C(NC)
C
      JN=1
      DO 20 I=1,NA
        NDXH2N(I)=0
        DO 10 J=JN,NB
          IF(A(I).GE.B(J)) THEN
            NDXN2H(J)=I
            NDXH2N(I)=NDXH2N(I)+1
          ELSE
            JN=J
            GOTO 20
          ENDIF
   10   CONTINUE
   20 CONTINUE
C
      JN=1
      DO 40 I=1,NB
        NDXN2T(I)=0
        DO 30 J=JN,NC
          IF(B(I).GE.C(J)) THEN
            NDXT2N(J)=I
            NDXN2T(I)=NDXN2T(I)+1
          ELSE
            JN=J
            GOTO 40
          ENDIF
   30   CONTINUE
   40 CONTINUE
C
      RETURN
      END
C
C
      FUNCTION IT2H(ITRANS)
C
C======================================================================
C
C       PURPOSE:  DETERMINES WHICH HORIZON A CENTIMETER IS CONTAINED IN.
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       IT2H   O  RELATED INFILTRATION INDEX TO HORIZON NUMBER
C       ITRANS     I  INFILTRATION INDEX TO BE TRANSLATED
C       JT         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       NDXN2H     I  INDEX FOR NUMERICAL LAYERS TO HORIZONS,
C                   IE. WHICH HORIZON IS NUMERICAL LAYER IN.
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 NONE
C
C       CALLED FROM:
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12)
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      JT=NDXT2N(ITRANS)
      IF(JT.EQ.0) JT=NDXT2N(ITRANS-1)
      IT2H=NDXN2H(JT)
C
      RETURN
      END
C
      SUBROUTINE MOVE(THETA,VWC)
C
C======================================================================
C
C       PURPOSE:
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       I      L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       N      L  EDDY DIFFUSIVITY DECAY CONSTANT AERODYNAMIC
C                 RESISTANCE BETWEEN CANOPY AND MEASUREMENT HEIGHT
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NNT        I  NUMBER INTERIOR NODES IN INFILTRATION GRID
C       THETA I/O VOLUMETRIC WATER CONTENT [CM^3/CM^3]
C       TL         I  NUMERICAL LAYER THICKNESSES [CM]
C       TMASS  L  MASS SUMMATION VARIABLE
C       VWC        I  MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 NONE
C
C       CALLED FROM:  EVNTRO
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
C=======================================================================
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12)
C
      COMMON /GEOMTR/XLONG,ASPECT,DELZ(MXNOD),ELEV,HORTHK(MAXHOR),SLOPE,
     +    AREA,TL(MXNOD),TLT(MXNOD),XLAT,ZN(MXNOD),NHOR,NN,NNT
C
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      DIMENSION THETA(NN),VWC(NNT)
C
      N=1
      TMASS=0.0D0
      DO 10 I=1,NNT-1
        TMASS=TMASS+VWC(I)
        IF(NDXT2N(I+1).NE.N) THEN
C         IF (I .EQ. (NNT-1)) TMASS = TMASS + VWC(I+1)
          THETA(N)=TMASS/TL(N)
          TMASS=0.0D0
          N=N+1
        ENDIF
   10 CONTINUE
      TMASS=TMASS+VWC(NNT)
      THETA(N)=TMASS/TL(N)
      RETURN
      END
C
C
      SUBROUTINE MOVET(T,TEMP,VWC,CSHD,THETA)
C
C======================================================================
C
C       PURPOSE:
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       CSHD   I  DRY VOLUMETRIC HEAT CAPACITIES [J/MM^3/C]
C       CSW        L
C       CWW        P  CONSTANT
C       I      L  INDEX VARIABLE
C       JJ         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       N      L  INDEX VARIABLE
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NNT        I  NUMBER INTERIOR NODES IN INFILTRATION GRID
C       T     I/O SOIL TEMPERATURE IN NUMERICAL CONFIGURATION [C]
C       TEMP   I  TEMPERATURE OF LAYER (C)
C       THETA  I  VOLUMETRIC WATER CONTENT [CM^3/CM^3]
C       TL         I  NUMERICAL LAYER THICKNESSES [CM]
C       TMASS  L  MASS SUMMATION VARIABLE
C       VWC        I  MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 IT2H
C
C       CALLED FROM:  EVNTRO
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12)
C
      PARAMETER(CWW=4.184D0)
C
C=======================================================================
C
C     VARIABLES PERTAINING TO SYSTEM DISCRETIZATION
C
C-----------------------------------------------------------------------
C
      COMMON /GEOMTR/XLONG,ASPECT,DELZ(MXNOD),ELEV,HORTHK(MAXHOR),SLOPE,
     +    AREA,TL(MXNOD),TLT(MXNOD),XLAT,ZN(MXNOD),NHOR,NN,NNT
C
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      DIMENSION T(NN),TEMP(mxnodt),CSHD(MAXHOR),VWC(mxnodt),THETA(NN)
C
C
      N=1
      TMASS=0.0D0
      DO 10 I=1,NNT-1
        JJ=IT2H(I)
        CSW=CSHD(JJ)*1.0D3+VWC(I)*CWW
        TMASS=TMASS+TEMP(I)*CSW
        IF(NDXT2N(I+1).NE.N) THEN
          IF(I.EQ.(NNT-1)) TMASS=TMASS+TEMP(I+1)*CSW
          T(N)=TMASS/(TL(N)*(THETA(N)*CWW+CSHD(JJ)*1.0D3))
          TMASS=0.0D0
          N=N+1
        ENDIF
   10 CONTINUE
      CSW=CSHD(JJ)*1.0D3+VWC(NNT)*CWW
      TMASS=TMASS+TEMP(NNT)*CSW
      T(N)=TMASS/(TL(N)*(THETA(N)*CWW+CSHD(JJ)*1.0D3))
      RETURN
      END
C
C
      SUBROUTINE NTRPTR(A,B)
C
C======================================================================
C
C       PURPOSE:  THIS ROUTINE MOVES THE CONCENTRATIONS IN A (NUMERICAL
C             LAYER SYSTEM) INTO B (INFILTRATION SYSTEM==1(CM))
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       A      I  VECTOR OF LAYER DEPTHS, THERE WILL ALWAYS BE
C                 LESS VALUES IN THIS VECTOR THAN IN B
C       B     I/O VECTOR OF LAYER DEPTHS.  THIS VECTOR WILL ALWAYS
C                 CONTAIN MORE VALUES THAN A
C       I      L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       NDXT2N     I  INDEX FOR GREEN-AMPT GRID TO NUMERICAL LAYER,
C                   IE. WHICH NUMERICAL LAYER IS G-A GRID IN.
C       NN         I  NUMBER INTERIOR NODES IN RICHARD'S EQN SOLUTION
C       NNT        I  NUMBER INTERIOR NODES IN INFILTRATION GRID
C
C       COMMENTS:
C
C       CALLED FROM: EVNTRO
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12)
C
C
C=======================================================================
C
C     VARIABLES PERTAINING TO SYSTEM DISCRETIZATION
C
C-----------------------------------------------------------------------
C
      COMMON /GEOMTR/XLONG,ASPECT,DELZ(MXNOD),ELEV,HORTHK(MAXHOR),SLOPE,
     +    AREA,TL(MXNOD),TLT(MXNOD),XLAT,ZN(MXNOD),NHOR,NN,NNT
C
C
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C
      DIMENSION A(NN),B(NNT)
C
      DO 10 I=1,NNT
        B(I)=A(NDXT2N(I))
   10 CONTINUE
C
      RETURN
      END
C
      FUNCTION RR2(TRFD)
C
C======================================================================
C
C       PURPOSE:  THIS SUBROUTINE FINDS THE NEXT RAINFALL EVENT
C
C       REF: AHUJA, LAJ; USDA-ARS, DURANT OK
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       CRFD   I  CUM AMOUNT OF RAINFALL OVER BRK.PNTS. [CM]
C       J      L  INDEX VARIABLE
C       MAXBP  P  MAXIMUM NUMBER OF BREAK POINTS IN A RAINSTORM
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       RFI        I  CURRENT RAINFALL INTENSITY [CM/HR]
C       RR2        O  NEW RAINFALL DEPTH  [CM]
C       TRFD   I  CURRENT RAINFALL DEPTH [CM]
C
C       CALLED FROM:  INFIL
C
C       PROGRAMMER:  LAJ AHUJA
C
C       VERSION:   2.0
C
C======================================================================
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MAXBP=50,MAXHOR=12,mxnod=300)
      PARAMETER(MXTSTP=5000)
C
      COMMON /OPINF/ RO,SWF(MXnod),TR(MXTSTP),CI(MXTSTP),CRFD(MAXBP),
     +    CRFT(MAXBP),RFI(MAXBP),RFDD,RFD
C
      DO 10 J=1,MAXBP
        IF(TRFD.LE.CRFD(J)) GOTO 20
   10 CONTINUE
      PRINT*,'ERROR---RAINFALL IS > THAN STORED AMOUNT IN RR2:RZTEST'
      PRINT*,'TRFD:',TRFD,'  LAST CRFD:',CRFD(MAXBP)
      STOP
   20 RR2=RFI(J)
      RETURN
      END
C
C
      SUBROUTINE CHEMBL(TCONC,IFLG,IP,IC,CHML,CWAT,X2CONC,IMAGIC,ROL,
     +    TDRCHM)
C
C======================================================================
C
C       PURPOSE:
C
C       REF:
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       ALH        I  KD FOR KNETC DESORPTION OF CURRENT PEST.[CM3 H2O/G SOIL]
C       BDH        I  BULK DENSITY FOR HORIZON [G/CM^3]
C       CHML   I  TOTAL AMT. OF CHEM. LOST THROUGH SEEPAGE
C       CWAT   I  CHEM ADDED TO SYSTEM
C       DELTAI     L  CHEMICAL MASS BALANCE
C       I      L  INDEX VARIABLE
C       IC         I  INDEX VARIABLE
C       IFLG   I  FLAG FOR INITIAL SUM OF CHEMICALS
C       IMAGIC     I  INDICATOR OF DEBUG OUTPUT
C       IP         I  INDEX FOR PESTICIDE NUMBER
C       JJ         L  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNOD  P  MAX NUMBER OF NUMERICAL NODES
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       MXPEST     P  MAXIMUM NUMBER OF PESTICIDES
C       MXTSTP     P  MAX NUMBER OF TIME STEPS
C       NNT        I  NUMBER INTERIOR NODES IN INFILTRATION GRID
C       ROL        I  CHEM. LOST TO RUN OFF
C       SIMASS     L  INITIAL CHEMICAL MASS
C       TCONC  I  CHEMICAL CONCENTRATIONS OF SINGLE CHEMICAL
C       TDRCHM     I  CHEM. LOST TO TILE DRAINAGE
C       TIMASS     L  FINAL CHEMICAL MASS
C       VWC        I  MOISTURE CONTENT AT EACH 1 CM INCREMENT [0..1]
C       X2CONC     I  PEST. CONC. INVOLVED IN KNETIC PROCESSES [UG/G SOIL]
C
C       COMMENTS:
C
C       EXTERNAL REFERENCES:
C                 IT2H
C
C       CALLED FROM:  EVNTRO
C
C       PROGRAMMER:  KEN ROJAS
C
C       VERSION:   2
C
C-----------------------------------------------------------------------
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C=======================================================================
C
      PARAMETER(MXNOD=300,MXNODT=3001,MAXHOR=12,MXCHEM=15,MXPEST=3,
     +    MXSPEC=10)
C
      COMMON /GEOMTR/XLONG,ASPECT,DELZ(MXNOD),ELEV,HORTHK(MAXHOR),SLOPE,
     +    AREA,TL(MXNOD),TLT(MXNOD),XLAT,ZN(MXNOD),NHOR,NN,NNT
      CHARACTER SOLTYP*10,NMPEST*30,PLNAME*30
      COMMON /NAMES/ NMPEST(MXPEST),SOLTYP(MAXHOR),PLNAME(MXSPEC)
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
      COMMON /IPINF/ CRUSTK,OCRUST,ICRUST,INFLPD,NHZ,NSLT,POND,RR,
     +    DHB(MAXHOR),NSL(MAXHOR),WI(Mxnod),DSL(MXNODT),VWC(MXNODT),
     +    IUGFLW
      COMMON /NDEX/ NDXN2H(MXNOD),NDXH2N(MAXHOR),NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
C ----------------------------------------------------------------------
      DOUBLE PRECISION MICP
C
      CHARACTER NMCHEM(12)*5
      LOGICAL FIRST
      DIMENSION TCONC(NNT),X2CONC(MXNODT,MXPEST),SIMASS(MXCHEM)
      SAVE SIMASS,NMCHEM,FIRST
C
      DATA FIRST /.TRUE./
      DATA(NMCHEM(I),I=1,12) /'H+ ','CA++ ','NA+  ','MG++ ','CL-  ',
     +    'HCO3-','S04--','AL+++','NO3-N','NH4-N','CO3  ','UREA '/
C
      IF(FIRST.AND.(IMAGIC.EQ.-1.OR.IMAGIC.EQ.-2.OR.IMAGIC.EQ.-10)) THEN
        WRITE(79,1200)
        WRITE(179,1201)
        WRITE(179,1301) NMPEST(1),NMPEST(2),NMPEST(3)
        WRITE(279,1201)
        WRITE(279,1301) NMPEST(1),NMPEST(2),NMPEST(3)
        FIRST=.FALSE.
      ENDIF
C
      TIMASS=0.0D0
      DO 10 I=1,NNT
        JJ=IT2H(I)
        JK=NDXT2N(I)
        TIMASS=TIMASS+TCONC(I)*(VWC(I)+ALH(JK,IC)*BDH(JJ))
        IF(IP.GT.0) THEN
          TIMASS=TIMASS+X2CONC(I,IP)*BDH(JJ)
        ENDIF
   10 CONTINUE
C
      IF(IFLG.EQ.0) THEN
        SIMASS(IC)=TIMASS
      ELSE
        DELTAI=SIMASS(IC)+CWAT-ROL-CHML-TDRCHM-TIMASS
        IF (ABS(DELTAI).LT.1.0D-9)DELTAI=0.0D0
        IF(IMAGIC.EQ.-1.OR.IMAGIC.EQ.-2.OR.IMAGIC.EQ.-10) THEN
          IF(IC.GE.13) THEN
            WRITE(79,1000) IC,NMPEST(IC-12),SIMASS(IC),CWAT,ROL,TDRCHM,
     +          CHML,TIMASS,DELTAI
          ELSE
            WRITE(79,1100) IC,NMCHEM(IC),SIMASS(IC),CWAT,ROL,TDRCHM,
     +          CHML,TIMASS,DELTAI
          ENDIF
        ENDIF
      ENDIF
C
      RETURN
 1000 FORMAT(33('#'),/'CHEMICAL NUMBER ==>',I3,' CHEMICAL NAME: ',A30,/
     +    ' BEGINNING MASS INFIL (UG) ==>',T45,G15.8,/
     +    '     ADDED TO WATER==>',T40,G15.8,/
     +    '     LOST TO RUNOFF==>',T40,G15.8,/
     +    '     LOST TO TILE DRAINAGE ==>',T40,G15.8,/
     +    '     LOST TO SEEPAGE ==>',T40,G15.8,/
     +    ' ENDING MASS INFIL ==>',T45,G15.8,/T45,15('-'),/
     +    ' MASS BALANCE INFIL ===',T45,G15.8,//)
 1100 FORMAT(33('#'),/'CHEMICAL NUMBER ==>',I3,' CHEMICAL NAME: ',A5,/
     +    ' BEGINNING MASS INFIL (UG) ==>',T45,G15.8,/
     +    '     ADDED TO WATER==>',T40,G15.8,/
     +    '     LOST TO RUNOFF==>',T40,G15.8,/
     +    '     LOST TO TILE DRAINAGE ==>',T40,G15.8,/
     +    '     LOST TO SEEPAGE ==>',T40,G15.8,/
     +    ' ENDING MASS INFIL ==>',T45,G15.8,/T45,15('-'),/
     +    ' MASS BALANCE INFIL ===',T45,G15.8,//)
 1200 FORMAT('DEFINITIONS OF HEADERS USED IN THIS FILE:'/,
     +    '========================================='/,
     +    'TR - CUM TIME (HRS WITH 0 BEING THE START OF THE STORM)'/,
     +    'CI - CUMULATIVE INFILTRATION (CM)'/,
     +    'CUMRO - CUMULATIVE RUNOFF WATER (CM)'/,'CRO - INSTANTANEOUS C
     +HEM CONC OF INFILTRATION WATER (UG/CM3)'/,
     +    'CUMCLR - CUMULATIVE CHEM IN RUNOFF (UG)'/,
     +    'CUMDR - CUMULATIVE DRAINAGE OF WATER OUT TILE DRAINS (CM)'/,
     +    'DRCHEM - CHEM LOSS IN TILE DRAIN [UG/CM2]'/,
     +    'CUMMF- CUMULATIVE FLOW OF WATER THROUGH MACROPORES (CM)'/,
     +    'CUMCLM - CUMULATIVE CHEM IN MACROPORE FLOW (UG)'/,'CMACSEP -
     +CHEM LOST FROM MACROPORES OUT OF PROFILE BOTTOM(UG)'/,'WMACSEP - W
     +ATER LOST FROM MACROPORES OUT OF PROFILE BOTTOM(CM)'/,
     +    'I - DEPTH (CM)'/,'VWC - VOLUMETRIC WATER CONTENT (CC/CC)'/,
     +    'CMESO - CHEMICAL IN MESOPORES (UG/L)'/,
     +    'CMICR - CHEMICAL IN MICROPORES (UG/L)'/,
     +    'CONC - TOTAL SOIL CHEMICAL CONCENTRATION (UG/L)'/,
     +    'FLOW - WATER MOVED FROM CONTINUOUS MACROPORES TO SOIL(CM)'/,
     +    'DFLOW - WATER MOVED FROM DEAD-END MACROPORES TO SOIL(CM)'/,
     +    'CFLOW - CHEM MOVED FROM CONTINUOUS MACROPORES TO SOIL(UG)'/,
     +    'CDFLOW - CHEM MOVED FROM DEAD-END MACROPORES TO SOIL(UG)'/,
     +    'DBET - WATER HELD IN DEAD-END MACROPORES (CM)'/,
     +    'CDBET - CHEM HELD IN DEAD-END MACROPORES (UG)'/,
     +    'CMASW - CHEM MASS ON MACROPORE WALLS (UG)'/)
 1201 FORMAT('DEFINITIONS OF HEADERS USED IN THIS FILE:'/,
     +    '========================================='/,
     +    'I  - INFILTRATION STEP'/,
     +    'TR - CUM TIME (HRS WITH 0 BEING THE START OF THE STORM)'/,
     +    'CI - CUMULATIVE INFILTRATION (CM)'/,
     +    'CUMRO - CUMULATIVE RUNOFF WATER (CM)'/,'CRO - INSTANTANEOUS C
     +HEM CONC OF INFILTRATION WATER (UG/CM3)'/,
     +    'CUMCLR - CUMULATIVE CHEM IN RUNOFF (UG)'/,
     +    'CUMDR - CUMULATIVE DRAINAGE OF WATER OUT TILE DRAINS (CM)'/,
     +    'DRCHEM - CHEM LOSS IN TILE DRAIN [UG/CM2]'/,
     +    'CUMMF- CUMULATIVE FLOW OF WATER THROUGH MACROPORES (CM)'/,
     +    'CUMCLM - CUMULATIVE CHEM IN MACROPORE FLOW (UG)'/,'CMACSEP -
     +CHEM LOST FROM MACROPORES OUT OF PROFILE BOTTOM(UG)'/,'WMACSEP - W
     +ATER LOST FROM MACROPORES OUT OF PROFILE BOTTOM(CM)'/)
 1301 FORMAT('DAY',2X,'YEAR',5X,'I',10X,'TR',10X,'CI',7X,'CUMRO',
     +      7X,'CUMDR',7X,'CUMMF',5X,'WMACSEP',
     +      9X,'CRO',6X,'CUMCLR',6X,'DRCHEM',6X,'CUMCLM',5X,'CMACSEP',
     +      9X,'CRO',6X,'CUMCLR',6X,'DRCHEM',6X,'CUMCLM',5X,'CMACSEP',
     +      9X,'CRO',6X,'CUMCLR',6X,'DRCHEM',6X,'CUMCLM',5X,'CMACSEP'/
     +      90X,20('-'),3x,A11,3x,20('-'),
     +      2X,20('-'),3x,A11,3x,20('-'),
     +      3X,20('-'),3x,A11,3x,20('-'))
C
      END
C
      SUBROUTINE SOILPR(J,SOILHP,RHOB,PCLAY,PSAND,PSILT,ITYPE,PRTDEN
     +                ,itill,HWP)
C
C======================================================================
C
C       PURPOSE:
C       CALCULATES SOIL HYDRAULIC PROPERTIES FROM TEXTURE, BULK DENSITY,
C       AND 1/3 BAR OR 1/10 BAR WATER CONTENT. KS IS CALCULATED FROM
C       EFFECTIVE POROSITY USING AN EMPIRICAL EQUATION OF
C       AHUJA ET AL. (1985). THE MATRIC POTENTIAL-WATER CONTENT RELATION
C       IS OBTAINED BY THE SCALING APPROACH FROM A KNOWN REFERENCE CURVE
C       FOR A TEXTURAL GROUP (AHUJA ET AL., 1985). THE UNSATURATED
C       HYDRAULIC CONDUCTIVITY IS SIMILARLY OBTAINED BY SCALING FROM A
C       REFERENCE CURVE OR FROM THE POTENTIAL-WATER CONTENT CURVE,
C       USING THE KS VALUE.
C       THE WATER RETENTION CURVE IS BROKEN INTO THREE SECTIONS. THE
C       STANDARD BROOKS-COREY RELATIONSHIP IS MAINTAIN UNTIL TILLAGE
C       OCCURS THEN THE CURVE CHANGES ACCORDING TO AHUJA ET AL. (1997)
C
C       REF:  AHUJA ET AL. (1985), AHUJA ET AL. (1997)
C
C       VARIABLE DEFINITIONS:
C       VARIABLE  I/O DESCRIPTION
C       --------  --- -----------
C       A1         L  CONSTANT FOR THETA(H) CURVE
C       A2         L  LAMDA- SLOPE OF THETA(H) CURVE
C       A2ORIG     L  LAMDA- FOR RECONSOLIDATED SOIL
C       ALFA   L  VARIABLE USED IN ESTIMATING CURVES
C       B*         L  COEFFICIENT FOR THETA CURVE
C       BDH       I/O BULK DENSITY FOR HORIZON [G/CM^3]
C       C1         L  SATURATED HYDRAULIC CONDUCTIVITY (CM/HR)
C       C2         L  SECOND INTERCEPT FOR K(H) CURVE
C       CHBD   L  TRUE WHEN BULK DENSITY HAS CHANGED
C       CKSAT  L  CONDUCTIVITY ADJUSTMENT FACTOR
C       FC         L  VOL FIELD CAPCITY [CM^3-W/CM^3-S]
C       FC10   L  VOL WATER CONTENT AT 1/10 BAR [CM^3-W/CM^3-S]
C       FC33   L  VOL WATER CONTENT AT 1/3 BAR [CM^3-W/CM^3-S]
C       HMIN   P  MINIMUM PRESSURE HEAD [CM]
C       HREF   L  SOIL CLASS INDEX
C       IRST   L  INDICATES NUMBER OF HORIZONS DONE
C       ITYPE  I  INDICATOR OF B-C DATA AVAILABLE
C                 (-1 -RESET VALUES,0 -FULL CURVE, ELSE MINIMAL)
C       J      I  INDEX VARIABLE
C       MAXHOR     P  MAXIMUM NUMBER OF SOIL HORIZONS
C       MICP   I  TOTAL MICROPOROSITY OF HORIZON [CM3/CM3]
C       MXCHEM     P  MAXIMUM NUMBER OF CHEMICALS SIMULATED
C       MXNODT     P  MAX NUMBER OF 1 CM LAYERS + 1
C       N1         L  EXPONENT 1 FOR K(H) CURVE
C       N2         L  EXPONENT 2 FOR K(H) CURVE
C       NCL        L  VARIABLE ASSOCIATED WITH SOIL TYPE
C       PCLAY  I  SEDIMENT FRACTION CLAY CONTENT [0..1]
C       PRTDEN     I  PARTICLE DENSITY FOR CURRENT HORIZON [G/CM^3]
C       PSAND  I  SEDIMENT SIZE FRACTION SAND PORTION [0..1]
C       PSILT  I  SEDIMENT SIZE FRACTION SILT PORTION [0..1]
C       RA1        L  REF CONSTANT FOR O(H) CURVE
C       RA2        L  REF PORE SIZE DISTRIBUTION INDEX
C       RB2        L  REF CONSTANT FOR O(H) CURVE
C       RC1        L  REF SAT. HYDRAULIC CONDUCTIVTY [CM/HR]
C       RC2        L  REF SECOND INTRCEPT ON K(H) CURVE
C       RHOB   I  SOIL BULK DENSITY [G/CM^3]
C       RKSAT  L  VARIABLE USED TO FIND ADJUSTMENT FACTOR
C       RN1        L  REF FIRST EXPONENT FOR K(H) CURVE
C       RN2        L  REF EXPONENT FOR K(H) CURVE
C       RRHOB  L  LOCAL VALUES OF BULK DENSITY [G/CM^3]
C       RS1        L  REF BUBBLING PRESSURE K(H) CURVE [CM]
C       RS2        L  REF BUBBLING PRESSURE O(H) [CM]
C       RWR        L  REF RESIDUAL WATER CONTENT [0..1]
C       RWS        L  REF SATURATION WATER CONTENT [0..1]
C       S1         L  BUBBLING PRESSURE FOR K(H) CURVE [CM]
C       S2         L  BUBBLING PRESSURE FOR THETA(H) CURVE  [CM]
C       SOILHP    I/O MODIFIED BROOKS-COREY PARAMETERS
C                   (1):   HB    - BUBBLING PRESSURE O(H) [CM]
C                   (2):   LAMDA - PORE SIZE DISTRIBUTION INDEX
C                   (3):   EPS   - EXPONENT FOR K(H) CURVE
C                   (4):   KSAT  - SAT HYDRAULIC CONDUCT [CM/HR]
C                   (5):   WR    - RESIDUAL WATER CONTENT
C                   (6):   WS    - SATURATION WATER CONTENT
C                   (7):   WFC   - FIELD CAPACITY (1/3 BAR) WC
C                   (8):   WFC   - FIELD CAPACITY (1/10 BAR) WC
C                   (9):   WWP   - WILTING POINT (15 BAR) WC
C                   (10):  HB    - BUBBLING PRESSURE K(H) CURVE [CM]
C                   (11):  C2    - SECOND INTRCEPT ON K(H) CURVE
C                   (12):  N1    - FIRST EXPONENT FOR K(H) CURVE
C                   (13):  A1    - CONSTANT FOR O(H) CURVE
C       T10HE  L  THETA VALUE AT 10*BUBBLING PRESSURE
C       WR         L  RESIDUAL WATER CONTENT [0..1]
C       WS         L  SATURATED WATER CONTENT [0..1]
C
C
C       COMMENTS: CONDUCTIVITY CURVES:
C               K = C1 EXP (-N1*H)  WHERE H >  S1
C               K = C2 * H**(-N2)   H <= S1
C
C             WATER CONTENT CURVES:
C               THETA = WS - A1 * H  WHERE H >  S2
C               THETA = B * H**(-A2)   H <= S2
C                 B=(WS-WR-A1*S2)*S2**A2
C               THETA = B2 * H**(-A2ORIG)  H < 10*S2
C                 B=(WS-WR-A1*S2)*S2**A2ORIG
C
C
C       EXTERNAL REFERENCES:
C                 NONE
C
C       CALLED FROM:
C
C       PROGRAMMER:  DR. LAJ AHUJA AND KEN ROJAS
C
C       VERSION: 98
C
C======================================================================
C
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
C
      PARAMETER(MAXHOR=12,MXCHEM=15,mxnod=300,mxnodt=3001)
c      PARAMETER(HMIN=-35000.0D0)
C ----------------------------------------------------------------------
      COMMON /IPCHEM/ A,ALH(MXNOD,MXCHEM),B,BDH(MAXHOR),DEG(MAXHOR),
     +    BDHR(MAXHOR),MICP(MAXHOR),NMICP
cssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     jak
      COMMON /NDEX/ NDXN2H(MXNOD), NDXH2N(MAXHOR), NDXN2T(MXNOD),
     +    NDXT2N(MXNODT)
      COMMON /SOIL/ SOILPP(8,MAXHOR),pori(mxnod)
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
C ----------------------------------------------------------------------
      DIMENSION WR(MAXHOR),WS(MAXHOR),C1(MAXHOR),C2(MAXHOR),A1(MAXHOR),
     +    A2(MAXHOR),S1(MAXHOR),S2(MAXHOR),A2ORIG(MAXHOR),
     +    T10HE(MAXHOR),S2ORIG(MAXHOR),ALFAORIG(MAXHOR),B2ORIG(MAXHOR)
      DOUBLE PRECISION MICP,N1(MAXHOR),N2(MAXHOR)
      LOGICAL CHBD
C
C      DIMENSION RN1(14), RS1(14), RN2(14), RWS(14),
      DIMENSION RN1(14),RN2(14),RWS(14),RA1(14),RS2(14),RWR(14),
     +    RA2(14),RB2(14),FC10(MAXHOR),FC33(MAXHOR),SOILHP(13,MAXHOR),
     +    RRHOB(MAXHOR),CKSAT(MAXHOR),WSORIG(MAXHOR)
      SAVE IRST,RRHOB,CKSAT,A2ORIG,T10HE,S2ORIG,B2ORIG,WSORIG
      DATA IRST /0/,CKSAT /MAXHOR*1.0D0/
      DATA WR /MAXHOR*0.0D0/,WS /MAXHOR*0.0D0/,C1 /MAXHOR*0.0D0/,C2 /
     +    MAXHOR*0.0D0/,A1 /MAXHOR*0.0D0/,A2 /MAXHOR*0.0D0/,S1 /MAXHOR*
     +    0.0D0/,S2 /MAXHOR*0.0D0/,N1 /MAXHOR*0.0D0/,N2 /MAXHOR*0.0D0/,
     +    A2ORIG /MAXHOR*0.0D0/,T10HE /MAXHOR*0.0D0/,S2ORIG /MAXHOR*
     +    0.0D0/,RRHOB /MAXHOR*0.0D0/,WSORIG/MAXHOR*0.0D0/
C
C     .. CONDUCTIVITY CURVE REFERENCE VALUES
      DATA RN1 /12*0.0d0,0.0D0,0.0D0/
      DATA RN2 /3.776D0,3.422D0,2.966D0,2.66D0,2.633D0,2.633D0,2.75D0,
     +    2.582D0,2.453D0,2.48D0,2.381D0,2.393D0,2.633D0,0.0D0/
C      DATA RS1/7.26D0, 8.69D0, 14.66D0, 11.15D0, 20.76D0, 20.76D0,
C     +   28.08D0, 25.89D0, 32.56D0, 29.17D0, 34.19D0, 37.3D0, 50.0D0,
C     +   0.0D0/
C
C     .. THETA CURVE REFERENCE VALUES
      DATA RWS /0.437D0,0.437D0,0.453D0,0.463D0,0.501D0,0.501D0,0.398D0,
     +    0.464D0,0.471D0,0.43D0,0.479D0,0.475D0,0.501D0,0.0D0/
      DATA RWR /0.02D0,0.035D0,0.041D0,0.027D0,0.015D0,0.015D0,0.068D0,
     +    0.075D0,0.04D0,0.109D0,0.056D0,0.09D0,0.015D0,0.0D0/
      DATA RA1 /12*0.0,0.002D0,0.0D0/
      DATA RS2 /7.26D0,8.69D0,14.66D0,11.15D0,20.76D0,20.76D0,28.08D0,
     +    25.89D0,32.56D0,29.17D0,34.19D0,37.3D0,20.76D0,0.0D0/
      DATA RA2 /0.592D0,0.474D0,0.322D0,0.22D0,0.211D0,0.211D0,0.25D0,
     +    0.194D0,0.151D0,0.168D0,0.127D0,0.131D0,0.211D0,0.0D0/
C
      BDH(J)=RHOB
      C1(J)=SOILHP(4,J)
      WR(J)=SOILHP(5,J)
      WS(J)=SOILHP(6,J)
      FC33(J)=SOILHP(7,J)
      FC10(J)=SOILHP(8,J)
      IF ((WSORIG(J).LE.0.0D0).or.(itill.eq.1)) then
         if (WS(J).NE.0.0D0) THEN
            WSORIG(J)=WS(J)
         ELSE 
            WSORIG(J)=1.0D0-BDHR(J)/PRTDEN
         endif
      ENDIF
      CHBD=.FALSE.
C
C     ..SAVE REFERENCE BULK DENSITY VALUES
      IF(J.GT.IRST.OR.ITYPE.LT.0) RRHOB(J)=RHOB
C
C     ..CHECK FOR CHANGE IN BULK DENSITY
      IF(RHOB.NE.RRHOB(J)) CHBD=.TRUE.
C
C     ..LOOK FOR USER SPECIFIED REFERENCE CURVES
      IF(ITYPE.LE.0) THEN
C       IF (ITYPE.EQ.0) THEN
        NCL=14
        IF(CHBD) THEN
C         ,, CHANGE DETECTED IN BULK DENSITY
C         .. K-CURVE VALUES
C         RN2(NCL) = SOILHP(3,J)
C         RS1(NCL) = SOILHP(10,J)
C         RN1(NCL) = SOILHP(12,J)
C         C1(J) = SOILHP(4,J)
C         .. THETA-CURVE VALUES
C         RWR(NCL) = SOILHP(5,J)
C         C2(J) = SOILHP(11,J)
C         S2(J) = S2ORIG(J)
C         A2(J) = A2ORIG(J)
C         A1(J) = SOILHP(13,J)
C         WS(J) = 0.0D0
C         WR(J) = RWR(NCL)
C         WR(J) = SOILHP(5,J)
C         FC33(J) = SOILHP(7,J)
C         FC10(J) = SOILHP(8,J)
          RRHOB(J)=RHOB
        ELSE
C         ,, NO CHANGE DETECTED IN BULK DENSITY
          S2(J)=SOILHP(1,J)
          A2(J)=SOILHP(2,J)
          N2(J)=SOILHP(3,J)
          C1(J)=SOILHP(4,J)
          WR(J)=SOILHP(5,J)
          WS(J)=SOILHP(6,J)
          S1(J)=SOILHP(10,J)
          N1(J)=SOILHP(12,J)
          A1(J)=SOILHP(13,J)
          ALFA=1.0D0
          IF(J.GT.IRST.OR.ITYPE.LT.0) THEN
            B1=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
            T10HE(J)=B1/(ABS(10.0D0*S2(J))**A2(J))+WR(J)
            IF (B2ORIG(J).LE.0.0D0.or.itill.eq.1) B2ORIG(J)=B1
            IF (A2ORIG(J).LE.0.0D0.or.itill.eq.1) A2ORIG(J)=A2(J)
            IF (S2ORIG(J).LE.0.0D0.or.itill.eq.1) S2ORIG(J)=S2(J)
            IF (ALFAORIG(J).LE.0.0D0.or.itill.eq.1) ALFAORIG(J)=ALFA
          ENDIF
C
C         .. DETERMINE 1/3 BAR VALUES
          IF(10.0D0*S2(J).LT.333.0D0) THEN
            FC33(J)=B2ORIG(J)/(333.0D0**A2ORIG(J))+WR(J)
          ELSEIF(S2(J).LT.333.0D0) THEN
            B2=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
            FC33(J)=B2/(333.0D0**A2(J))+WR(J)
          ELSE
            FC33(J)=WS(J)-A1(J)*333.0D0
          ENDIF
C
C         .. DETERMINE 1/10 BAR VALUES
          IF(10.0D0*S2(J).LT.100.0D0) THEN
            FC10(J)=B2ORIG(J)/(100.0D0**A2ORIG(J))+WR(J)
          ELSEIF(S2(J).LT.100.0D0) THEN
            B2=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
            FC10(J)=B2/(100.0D0**A2(J))+WR(J)
          ELSE
            FC10(J)=WS(J)-A1(J)*100.0D0
          ENDIF
          RKSAT=764.5D0*(WS(J)-FC33(J))**3.29D0     ! from Ahuja 
c          RKSAT=509.4D0*(WS(J)-FC33(J))**3.633D0   !From Rawls et al. 1982
C
C         .. CHANGED 6.25.03 BY KEN -- IN CASE KSAT IS ZERO AT INITIALIZATION TIME
          IF(C1(J).LT.0.0D0) C1(J)=RKSAT
          C2(J)=C1(J)*S1(J)**(N2(J)-N1(J))
C
          CKSAT(J)=C1(J)/RKSAT
          IRST=J
          GOTO 10
        ENDIF
      ENDIF
C
C
C
C     ESTIMATE PARAMETERS OF WATER RETENTION CURVE
C
      IF(ITYPE.GT.0.OR.CHBD) WS(J)=WSORIG(J)*(1.0D0-BDH(J)/PRTDEN)/
     +                                   (1.0D0-BDHR(J)/PRTDEN)
C
C     ..SAVE INITIAL VALUES FOR TILLAGE AFFECTS
      IF(J.GT.IRST.OR.ITYPE.LT.0) THEN
        IF(PSAND.GE.85.0D0.AND.(PSILT+1.5D0*PCLAY).LE.15.0D0) THEN
          NCL=1
        ELSEIF(PSAND.GE.85.0D0.AND.PSAND.LE.90.0D0.AND.(PSILT+1.5D0*
     +      PCLAY).GE.15.0D0) THEN
          NCL=2
        ELSEIF(PSAND.GE.70.0D0.AND.PSAND.LE.85.0D0.AND.(PSILT+2.0D0*
     +      PCLAY).LE.30.0D0) THEN
          NCL=2
        ELSEIF(PSAND.GE.52.0D0.AND.PCLAY.LE.20.0D0.AND.(PSILT+2.0D0*
     +      PCLAY).GT.30.0D0) THEN
          NCL=3
        ELSEIF(PSAND.GE.43.0D0.AND.PSAND.LE.52.0D0.AND.(PCLAY.LT.7.0D0
     +      .AND.PSILT.LT.50.0D0)) THEN
          NCL=3
        ELSEIF(PSAND.LT.52.0D0.AND.PCLAY.GE.7.0D0.AND.(PCLAY.LT.27.0D0
     +      .AND.PSILT.GE.28.0D0.AND.PSILT.LE.50.0D0)) THEN
          NCL=4
        ELSEIF(PSILT.GE.50.0D0.AND.PCLAY.GE.12.0D0.AND.(PCLAY.LT.27.0D0)
     +      ) THEN
          NCL=5
        ELSEIF(PSILT.GE.50.0D0.AND.PSILT.LE.80.0D0.AND.(PCLAY.LT.12.0D0)
     +      ) THEN
          NCL=5
        ELSEIF(PSILT.GE.80.0D0.AND.PCLAY.LT.12.0D0) THEN
          NCL=6
        ELSEIF(PSAND.GE.45.0D0.AND.PCLAY.GE.20.0D0.AND.(PCLAY.LE.35.0D0
     +      .AND.PSILT.LT.28.0D0)) THEN
          NCL=7
        ELSEIF(PSAND.GE.20.0D0.AND.PSAND.LE.45.0D0.AND.PCLAY.GE.27.0D0
     +      .AND.PCLAY.LE.40.0D0) THEN
          NCL=8
        ELSEIF(PCLAY.GE.27.0D0.AND.PCLAY.LE.40.0D0.AND.PSAND.LT.20.0D0)
     +      THEN
          NCL=9
        ELSEIF(PCLAY.GE.35.0D0.AND.PSAND.GE.45.0D0) THEN
          NCL=10
        ELSEIF(PCLAY.GE.40.0D0.AND.PSILT.GE.40.0D0) THEN
          NCL=11
        ELSEIF(PCLAY.GE.40.0D0.AND.PSILT.LT.40.0D0.AND.PSAND.LT.45.0D0)
     +      THEN
          NCL=12
        ELSE
          NCL=13
        ENDIF
C
C       .. FIRST TIME OR INITIALIZATION PASS
        IF(WR(J).LE.0.0D0) WR(J)=RWR(NCL)
        RB2(NCL)=(1.0D0-RA1(NCL)*RS2(NCL))*RS2(NCL)**RA2(NCL)
        SOILHP(12,J)=RN1(NCL)
        SOILHP(3,J)=RN2(NCL)
        N2(J)=RN2(NCL)
        A2(J)=RA2(NCL)
C
C       .. SCALE BUBBLING PRESSURE AND SATURATED SLOPE OF THETA CURVE
        IF(FC33(J).GT.0.0D0) THEN
          FC=(FC33(J)-WR(J))/(WS(J)-WR(J))
          IF(FC.GE.1.0D0) HREF=RS2(NCL)/2.0D0
          IF(FC.LT.1.0D0) THEN
            HREF=(RB2(NCL)/FC)**(1.0D0/RA2(NCL))
            IF(HREF.LT.RS2(NCL).AND.RA1(NCL).GT.0.0D0) THEN
              HREF=(1.0D0-FC)/RA1(NCL)
            ENDIF
          ENDIF
          ALFA=HREF/333.0D0
          S2(J)=RS2(NCL)/ALFA
        ELSEIF(FC10(J).GT.0.0D0) THEN
          FC=(FC10(J)-WR(J))/(WS(J)-WR(J))
          IF(FC.GE.1.0D0) HREF=RS2(NCL)/2.0D0
          IF(FC.LT.1.0D0) THEN
            HREF=(RB2(NCL)/FC)**(1.0D0/RA2(NCL))
            IF(HREF.LT.RS2(NCL).AND.RA1(NCL).GT.0.0D0) THEN
              HREF=(1.0D0-FC)/RA1(NCL)
            ENDIF
          ENDIF
          ALFA=HREF/100.0D0
          S2(J)=RS2(NCL)/ALFA
        ELSE
          RT=((RWS(NCL)-RWR(NCL))/(WS(J)-WR(J)))
          ALFA=RT**(-1.0D0/RA2(NCL))
          S2(J)=RS2(NCL)/ALFA
        ENDIF
        A1(J)=RA1(NCL)*ALFA*(WS(J)-WR(J))
        B1=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
        T10HE(J)=B1/(ABS(10.0D0*S2(J))**A2(J))+WR(J)
            IF (B2ORIG(J).LE.0.0D0.or.itill.eq.1) B2ORIG(J)=B1
            IF (A2ORIG(J).LE.0.0D0.or.itill.eq.1) A2ORIG(J)=A2(J)
            IF (S2ORIG(J).LE.0.0D0.or.itill.eq.1) S2ORIG(J)=S2(J)
            IF (ALFAORIG(J).LE.0.0D0.or.itill.eq.1) ALFAORIG(J)=ALFA
      ELSE
C       .. ALL OTHER TIMES THROUGH
        ALFA=ALFAORIG(J)
        S2(J)=S2ORIG(J)
        A1(J)=SOILHP(13,J)*(SOILHP(6,J)-SOILHP(5,J))/(WS(J)-WR(J))
        T1=(LOG(WS(J)-WR(J)-A1(J)*S2(J))-LOG(T10HE(J)-WR(J)))
        T2=(LOG(ABS(S2(J)))-LOG(ABS(10.0D0*S2(J))))
        A2(J)=ABS(T1/T2)
C       ..Update 1/10 NOR 1/3 BAR DATA  !need to return SWRC to original, Nov. 17, 2010
        B2=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
C
        IF(10.0D0*S2(J).LT.333.0D0) THEN
          FC33(J)=B2ORIG(J)/(333.0D0**A2ORIG(J))+WR(J)
        ELSEIF(S2(J).LE.333.0D0) THEN
          FC33(J)=B2/(333.0D0**A2(J))+WR(J)
        ELSE
          FC33(J)=WS(J)-A1(J)*333.0D0
        ENDIF
C
        IF(10.0D0*S2(J).LT.100.0D0) THEN
          FC10(J)=B2ORIG(J)/(100.0D0**A2ORIG(J))+WR(J)
        ELSEIF(S2(J).LE.100.0D0) THEN
          FC10(J)=B2/(100.0D0**A2(J))+WR(J)
        ELSE
          FC10(J)=WS(J)-A1(J)*100.0D0
        ENDIF
      ENDIF
C
      IF(FC33(J).GT.0.0D0) THEN
C
C       ..WE HAVE 1/3 BAR DATA
        IF(10.0D0*S2(J).LT.100.0D0) THEN
C         .. ORIGINAL CURVE
          FC10(J)=B2ORIG(J)/(100.0D0**A2ORIG(J))+WR(J)
        ELSEIF(S2(J).LE.100.0D0) THEN
C         .. ADJUSTED CURVE
          B2=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
          FC10(J)=B2/(100.0D0**A2(J))+WR(J)
        ELSE
C         .. SATURATED CURVE
          FC10(J)=WS(J)-A1(J)*100.0D0
        ENDIF
C
      ELSEIF(FC10(J).GT.0.0D0) THEN
C
C       ..WE HAVE 1/10 BAR DATA
        IF(10.0D0*S2(J).LT.333.0D0) THEN
C         .. ORIGINAL CURVE
          FC33(J)=B2ORIG(J)/(333.0D0**A2ORIG(J))+WR(J)
        ELSEIF(S2(J).LE.333.0D0) THEN
C         .. ADJUSTED CURVE
          B2=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
          FC33(J)=B2/(333.0D0**A2(J))+WR(J)
        ELSE
C         .. SATURATED CURVE
          FC33(J)=WS(J)-A1(J)*333.0D0
        ENDIF
      ELSE
C
C       ..WE DON'T HAVE EITHER 1/10 NOR 1/3 BAR DATA
        B2=(WS(J)-WR(J)-A1(J)*S2(J))*S2(J)**A2(J)
C
        IF(10.0D0*S2(J).LT.333.0D0) THEN
          FC33(J)=B2ORIG(J)/(333.0D0**A2ORIG(J))+WR(J)
        ELSEIF(S2(J).LE.333.0D0) THEN
          FC33(J)=B2/(333.0D0**A2(J))+WR(J)
        ELSE
          FC33(J)=WS(J)-A1(J)*333.0D0
        ENDIF
C
        IF(10.0D0*S2(J).LT.100.0D0) THEN
          FC10(J)=B2ORIG(J)/(100.0D0**A2ORIG(J))+WR(J)
        ELSEIF(S2(J).LE.100.0D0) THEN
          FC10(J)=B2/(100.0D0**A2(J))+WR(J)
        ELSE
          FC10(J)=WS(J)-A1(J)*100.0D0
        ENDIF
      ENDIF
C
C     ..ESTIMATE KSAT AND UNSATURATED K PARAMETERS
      IF(J.GT.IRST.OR.ITYPE.LT.0) THEN
        IRST=J
        IF(C1(J).GE.0.0D0) THEN
C
C         ..CREATE ADJUSTMENT FACTOR IF USER SUPPLIED KSAT IS NOT EST.
          RKSAT=764.5D0*(WS(J)-FC33(J))**3.29D0     !from Ahuja
c          RKSAT=509.4D0*(WS(J)-FC33(J))**3.633D0   !From Rawls et al. 1982
          CKSAT(J)=C1(J)/RKSAT
        ENDIF
      ENDIF
C
      IF(C1(J).LT.0.0D0.OR.CHBD) C1(J)=764.5D0*(WS(J)-FC33(J))**3.29D0*      !from Ahuja
c      IF(C1(J).EQ.0.0D0.OR.CHBD) C1(J)=509.4D0*(WS(J)-FC33(J))**3.633D0*   !from Rawls et al. 1982.
     +    CKSAT(J)
C     N2(J) = SOILHP(3,J)
      S1(J)=S2(J)
      N1(J)=SOILHP(12,J)
      SOILHP(10,J)=S1(J)
      SOILHP(4,J)=C1(J)
csssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss
c     ma
c     jak
      jh2n = ndxh2n(j)
      IF(CHBD) THEN
        T2=(LOG(ABS(S2(J)))-LOG(ABS(10.0D0*S2(J))))
        T3=(LOG(POINTK(-S2(J),SOILHP(1,J),J,pori(jh2n)))-
     +      LOG(POINTK(-10.0D0*S2(J),SOILHP(1,J),J,pori(jh2n))))
ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
        N2(J)=ABS(T3/T2)        !NEW SLOPE
      ENDIF
      C2(J)=C1(J)*S1(J)**(N2(J)-N1(J))
C
C     ..STORE NEW VALUES IN WORK MATRIX
   10 SOILHP(1,J)=S2(J)
      SOILHP(2,J)=A2(J)
      SOILHP(3,J)=N2(J)
      SOILHP(4,J)=C1(J)
      SOILHP(5,J)=WR(J)
      SOILHP(6,J)=WS(J)
      SOILHP(7,J)=FC33(J)
      SOILHP(8,J)=FC10(J)
      SOILHP(9,J)=B2ORIG(J)/(ABS(HWP)**A2ORIG(J))+WR(J)
      SOILHP(10,J)=S1(J)
      SOILHP(11,J)=C2(J)
      SOILHP(12,J)=N1(J)
      SOILHP(13,J)=A1(J)
C
      RETURN
      END
C
